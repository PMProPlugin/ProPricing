<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ProPlugin • ProPricing</title>

<!-- Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;500;600;700;800;900&family=Prompt:wght@400;600;700&display=swap" rel="stylesheet">

<!-- Tailwind -->
<script src="https://cdn.tailwindcss.com"></script>
<script>
  tailwind.config = {
    darkMode: 'class',
    theme: {
      extend: {
        fontFamily: {
          display: ["Kanit", "ui-sans-serif", "system-ui"],
          sans: ["Prompt", "Inter", "ui-sans-serif", "system-ui"]
        },
        colors: {
          brand: {
            red: "#ef4444"
          }
        },
        boxShadow: {
          soft: "0 10px 30px rgba(0,0,0,.25)"
        }
      }
    }
  };
</script>
<style>
  html,body{background:#0a0a0a}
  ::-webkit-scrollbar{width:10px;height:10px}::-webkit-scrollbar-thumb{background:#222;border-radius:10px}
  .oneline{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis }
  .text-elevate{ text-shadow:0 1px 2px rgba(0,0,0,.9),0 0 1px rgba(0,0,0,.7) }
  @media print { .no-print{display:none!important} .print-only{display:block} }
</style>
</head>

<body class="text-white font-sans">

<!-- ============ APP MARKUP (TRIMMED FOR BREVITY) ============ -->
<!-- NOTE: This file contains only the relevant parts to reproduce the Template
     Management fixes. Wire it into your full file as needed. -->

<div id="settingsPanel" class="p-6">
  <div class="flex gap-2 mb-4">
    <button class="set-tab px-3 py-2 rounded-2xl bg-zinc-800 border border-zinc-700" data-tab="templates">Templates</button>
  </div>
  <div id="settingsContent"></div>
</div>

<script>
/* ============ UTILITIES ================= */
const $  = (s,r=document)=>r.querySelector(s);
const $$ = (s,r=document)=>Array.from(r.querySelectorAll(s));
const LS = { TEMPLATES:'TEMPLATES' };
const log = (a,m='')=>console.log('[LOG]',a,m);
function fileToBase64(f){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(f); }); }

/* ============ DEFAULTS (for demo) ================= */
function defaultTemplates(){
  return [
    { id:'t-a4',  name:'A4 (1 per sheet)', kind:'A4',  showLogo:true, imageData:null, logoStyles:{size:64,margin:10}, styles:{ sku:{fs:16,color:'#ffffff',mt:0}, description:{fs:30,color:'#ffffff',mt:0}, details:{fs:14,color:'#ffffff',mt:0}, price:{fs:72,color:'#ffffff',mt:0}, oldPrice:{fs:20,color:'#ff4d4f',mt:0}, expire:{fs:13,color:'#ffffff',mt:0} } },
    { id:'t-a5',  name:'A5 (2 per A4 landscape)', kind:'A5',  showLogo:true, imageData:null, logoStyles:{size:50,margin:8},  styles:{ sku:{fs:14,color:'#ffffff',mt:0}, description:{fs:26,color:'#ffffff',mt:0}, details:{fs:13,color:'#ffffff',mt:0}, price:{fs:60,color:'#ffffff',mt:0}, oldPrice:{fs:18,color:'#ff4d4f',mt:0}, expire:{fs:12,color:'#ffffff',mt:0} } },
    { id:'t-a6',  name:'A6 (4 per sheet)',       kind:'A6',  showLogo:true, imageData:null, logoStyles:{size:40,margin:6},  styles:{ sku:{fs:12,color:'#ffffff',mt:0}, description:{fs:22,color:'#ffffff',mt:0}, details:{fs:12,color:'#ffffff',mt:0}, price:{fs:48,color:'#ffffff',mt:0}, oldPrice:{fs:16,color:'#ff4d4f',mt:0}, expire:{fs:11,color:'#ffffff',mt:0} } }
  ];
}
let templates = JSON.parse(localStorage.getItem(LS.TEMPLATES)||'null') || defaultTemplates();
localStorage.setItem(LS.TEMPLATES, JSON.stringify(templates));

/* ============ SETTINGS RENDERER (only templates tab) ================= */
function openSettings(tab){ renderSettings(tab); }
function renderSettings(tab){
  const box = $('#settingsContent');
  if(tab==='templates'){
    const arr = JSON.parse(localStorage.getItem(LS.TEMPLATES)||'[]');
    box.innerHTML = `
      <div class="flex items-center justify-between">
        <div class="text-2xl font-semibold mb-2">Template Management</div>
        <div class="flex items-center gap-2">
          <label class="px-3 py-2 rounded-2xl bg-brand.red hover:bg-red-600 border border-red-700 cursor-pointer">
            <input type="file" id="tplUploadNew" accept="image/png, image/jpeg" class="hidden">
            Upload New Template
          </label>
        </div>
      </div>
      <div class="text-sm text-zinc-400 mb-3">All templates are fully customizable.</div>
      <div id="tplList" class="grid lg:grid-cols-2 gap-6 mt-2"></div>
    `;

    const listBox = $('#tplList'); listBox.innerHTML='';
    arr.forEach((t,i)=>{
      const card = document.createElement('div');
      card.className = 'p-4 rounded-2xl border border-zinc-800 bg-zinc-900/40';
      const safe = (v, d) => (v===undefined || v===null) ? d : v;
      t.styles = t.styles || {};
      ['sku','description','details','price','oldPrice','expire'].forEach(k=>{
        t.styles[k] = t.styles[k] || {fs:14,color:'#ffffff',mt:0};
        t.styles[k].fs = safe(parseInt(t.styles[k].fs), 14);
        t.styles[k].color = t.styles[k].color || '#ffffff';
        t.styles[k].mt = safe(parseInt(t.styles[k].mt), 0);
      });
      t.logoStyles = t.logoStyles || {size:64, margin:10};

      card.innerHTML = `
        <div class="flex justify-between items-start">
          <input data-name="${i}" value="${t.name||'Untitled Template'}" class="bg-transparent text-white text-lg font-semibold px-2 py-1 outline-none border-b border-zinc-700 focus:border-brand.red">
          <button class="ml-2 px-3 py-1 rounded-2xl bg-zinc-900 hover:bg-zinc-800 border border-zinc-700" data-del="${i}">Delete</button>
        </div>
        <div class="text-xs text-zinc-400 mb-3">ID: ${t.id||'-'} • Kind: ${t.kind||'-'}</div>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <div class="text-sm font-semibold mb-2">Background Image</div>
            <img src="${t.imageData||''}" class="w-full rounded-lg border border-zinc-700 my-2 object-contain max-h-32 ${t.imageData?'':'hidden'}">
            <div class="${t.imageData?'hidden':''} text-xs text-zinc-500">No background image</div>
            <label class="w-full text-center block mt-2 px-3 py-2 rounded-2xl bg-zinc-800 hover:bg-zinc-700 border border-zinc-700 cursor-pointer">
              <input type="file" data-img="${i}" accept="image/png, image/jpeg" class="hidden">
              Upload/Change Image
            </label>
          </div>
          <div>
            <div class="text-sm font-semibold mb-2">Logo Settings</div>
            <label class="flex items-center gap-2 text-sm"><input type="checkbox" data-logo="${i}" ${t.showLogo?'checked':''}> Show logo</label>
            <div class="grid grid-cols-2 gap-2 mt-2">
              <div>
                <label class="text-xs text-zinc-400">Size (px)</label>
                <input type="number" step="1" data-logosize="${i}" value="${safe(parseInt(t.logoStyles.size),64)}" class="w-full px-2 py-1 rounded-xl bg-zinc-950 border border-zinc-800">
              </div>
              <div>
                <label class="text-xs text-zinc-400">Margin (px)</label>
                <input type="number" step="1" data-logomargin="${i}" value="${safe(parseInt(t.logoStyles.margin),10)}" class="w-full px-2 py-1 rounded-xl bg-zinc-950 border border-zinc-800">
              </div>
            </div>
          </div>
        </div>
        <div class="grid grid-cols-2 gap-3 mt-4">
          ${['sku','description','details','price','oldPrice','expire'].map(k=>`
            <div class="p-3 rounded-xl bg-zinc-900 border border-zinc-800">
              <div class="text-xs text-zinc-400 mb-1 capitalize">${k.replace('oldPrice','Old Price')}</div>
              <label class="text-xs">Font size</label>
              <input type="number" step="1" data-fs="${i}|${k}" value="${t.styles[k].fs}" class="w-full px-2 py-1 rounded-xl bg-zinc-950 border border-zinc-800 mb-1">
              <label class="text-xs">Color</label>
              <input type="color" data-color="${i}|${k}" value="${t.styles[k].color}" class="w-full h-8 rounded-xl bg-zinc-950 border border-zinc-800 mb-1">
              <label class="text-xs">Top margin (px)</label>
              <input type="number" step="1" data-mt="${i}|${k}" value="${t.styles[k].mt}" class="w-full px-2 py-1 rounded-xl bg-zinc-950 border border-zinc-800">
            </div>
          `).join('')}
        </div>
        <button class="mt-4 w-full px-3 py-2 rounded-2xl bg-brand.red hover:bg-red-600 border border-red-700" data-savtpl="${i}">Save Template</button>
      `;
      listBox.appendChild(card);
    });

    // Delegated: Save & Delete
    listBox.addEventListener('click', (ev)=>{
      const saveBtn = ev.target.closest('button[data-savtpl]');
      if(saveBtn){
        const i = +saveBtn.getAttribute('data-savtpl');
        const list = JSON.parse(localStorage.getItem(LS.TEMPLATES)||'[]');
        const t = list[i]; if(!t) return;
        t.name = $(`#settingsContent input[data-name="${i}"]`)?.value?.trim() || t.name || 'Untitled Template';
        ['sku','description','details','price','oldPrice','expire'].forEach(k=>{
          const fs = parseInt($(`#settingsContent input[data-fs="${i}|${k}"]`)?.value)||14;
          const color = $(`#settingsContent input[data-color="${i}|${k}"]`)?.value||'#ffffff';
          const mt = parseInt($(`#settingsContent input[data-mt="${i}|${k}"]`)?.value)||0;
          t.styles = t.styles || {}; t.styles[k] = {fs, color, mt};
        });
        t.showLogo = !!$(`#settingsContent input[data-logo="${i}"]`)?.checked;
        t.logoStyles = t.logoStyles || {};
        t.logoStyles.size = parseInt($(`#settingsContent input[data-logosize="${i}"]`)?.value)||64;
        t.logoStyles.margin = parseInt($(`#settingsContent input[data-logomargin="${i}"]`)?.value)||10;
        localStorage.setItem(LS.TEMPLATES, JSON.stringify(list));
        templates = list;
        log('save_template', t.name);
        alert('Template saved');
        return;
      }
      const delBtn = ev.target.closest('button[data-del]');
      if(delBtn){
        const i = +delBtn.getAttribute('data-del');
        const list = JSON.parse(localStorage.getItem(LS.TEMPLATES)||'[]');
        const t = list[i]; if(!t) return;
        if(confirm(`Delete template "${t.name}"?`)){
          list.splice(i,1);
          localStorage.setItem(LS.TEMPLATES, JSON.stringify(list));
          templates = list;
          log('delete_template', t.name);
          renderSettings('templates');
        }
      }
    });

    // Delegated: Background image change
    listBox.addEventListener('change', async (ev)=>{
      const fInput = ev.target.closest('input[type="file"][data-img]');
      if(fInput){
        const i = +fInput.getAttribute('data-img');
        const file = fInput.files && fInput.files[0];
        if(!file) return;
        const list = JSON.parse(localStorage.getItem(LS.TEMPLATES)||'[]');
        const t = list[i]; if(!t) return;
        try{
          const b64 = await fileToBase64(file);
          t.imageData = b64; t.kind = t.kind || 'IMAGE';
          localStorage.setItem(LS.TEMPLATES, JSON.stringify(list));
          templates = list;
          log('update_template_image', t.name);
          renderSettings('templates');
        }catch(err){ alert('Failed to update image: '+err.message); }
        fInput.value = '';
      }
    });

    // Upload NEW template from image
    $('#settingsContent #tplUploadNew').onchange = async (e)=>{
      const f = e.target.files && e.target.files[0]; if(!f) return;
      const nm = prompt('Enter a name for this new template:'); if(!nm){ e.target.value=''; return; }
      try{
        const imageData = await fileToBase64(f);
        const id = 'user-' + Math.random().toString(36).slice(2,10);
        const base = defaultTemplates()[2] || {styles:{}};
        const newTpl = { id, name:nm, kind:'IMAGE', imageData, showLogo:false, logoStyles:{size:40,margin:6}, styles: JSON.parse(JSON.stringify(base.styles||{})) };
        const list = JSON.parse(localStorage.getItem(LS.TEMPLATES)||'[]');
        list.push(newTpl);
        localStorage.setItem(LS.TEMPLATES, JSON.stringify(list));
        templates = list;
        log('create_template_image', nm);
        renderSettings('templates');
        alert('New template created.');
      }catch(err){ alert('Failed to create template: '+err.message); }
      e.target.value='';
    };
  }
}

// boot
openSettings('templates');
</script>
</body>
</html>
