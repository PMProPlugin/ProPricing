<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ProPlugin • ProPricing</title>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;600;700;800;900&family=Prompt:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: { sans: ['Kanit','Prompt','system-ui','sans-serif'] },
          colors: { brand: { dark:'#0b0b0c', red:'#E11D2E' } },
          boxShadow: { soft: '0 6px 18px rgba(0,0,0,.25)' }
        }
      }
    }
  </script>

  <!-- Firebase (Compat SDKs for simplicity) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-storage-compat.js"></script>

  <!-- SheetJS (optional: for SKU import/export later) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root { color-scheme: dark; }
    html,body{ height:100%; background:#0b0b0c }
    ::-webkit-scrollbar{width:10px;height:10px}::-webkit-scrollbar-thumb{background:#222;border-radius:10px}
    .oneline{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis }
    .text-elevate{ text-shadow:0 1px 2px rgba(0,0,0,.9),0 0 1px rgba(0,0,0,.7) }

    /* ====== PRINT ENGINE (fit to page with real world units) ====== */
    @media print { .no-print{display:none!important} .print-only{display:block} html,body{ -webkit-print-color-adjust: exact; print-color-adjust: exact; background:#fff; } }

    /* On-screen preview panel */
    .sheet-preview{ background:#111; border:1px solid #2a2a2a; }
    .sheet-frame{ width:100%; aspect-ratio: 210/297; background:#000; display:grid; place-items:center; }
    .sheet-frame img{ width:100%; height:100%; object-fit:cover; }
  </style>
</head>

<body class="text-white font-sans">
  <header class="no-print sticky top-0 z-50 bg-brand.dark/90 border-b border-zinc-800 backdrop-blur">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center gap-3">
      <div class="w-9 h-9 rounded-xl bg-brand.red grid place-items-center text-lg font-extrabold">PP</div>
      <div class="font-bold">ProPricing (Sync + Print Fit)</div>
      <div class="ml-auto flex items-center gap-2">
        <span id="whoami" class="text-zinc-400 text-sm">—</span>
        <button id="btnLogout" class="px-3 py-1.5 rounded-xl bg-zinc-800 border border-zinc-700 hover:bg-zinc-700">Logout</button>
      </div>
    </div>
  </header>

  <!-- ===================== AUTH / SETUP ===================== -->
  <main id="authArea" class="min-h-[70vh] grid place-items-center p-6">
    <div class="w-full max-w-md bg-zinc-900/80 border border-zinc-800 rounded-2xl p-6 shadow-soft">
      <h2 class="text-xl font-bold mb-1">Sign in</h2>
      <p class="text-zinc-400 mb-4 text-sm">Email/Password (host can be created below on first run).</p>
      <input id="loginEmail" type="email" class="w-full mt-1 px-4 py-3 rounded-2xl bg-zinc-900 border border-zinc-700" placeholder="your@email.com" />
      <input id="loginPass" type="password" class="w-full mt-3 px-4 py-3 rounded-2xl bg-zinc-900 border border-zinc-700" placeholder="password" />
      <button id="btnLogin" class="mt-4 w-full py-3 rounded-2xl bg-brand.red hover:bg-red-600 border border-red-700 font-semibold">Sign in</button>
      <details class="mt-5 text-sm text-zinc-400">
        <summary class="cursor-pointer text-zinc-300">Create host (first time)</summary>
        <div class="mt-3 space-y-2">
          <input id="hostEmail" type="email" class="w-full px-4 py-3 rounded-2xl bg-zinc-900 border border-zinc-700" placeholder="host@yourapp.local" />
          <input id="hostPass" type="password" class="w-full px-4 py-3 rounded-2xl bg-zinc-900 border border-zinc-700" placeholder="strong password" />
          <button id="btnCreateHost" class="w-full py-2.5 rounded-2xl bg-zinc-800 hover:bg-zinc-700 border border-zinc-700">Create host</button>
        </div>
      </details>
    </div>
  </main>

  <!-- ===================== APP ===================== -->
  <section id="appArea" class="hidden max-w-6xl mx-auto p-4">
    <div class="grid md:grid-cols-2 gap-6">
      <!-- Left: Template Management -->
      <div class="bg-zinc-900/80 border border-zinc-800 rounded-2xl p-5 shadow-soft">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-bold">Template Management</h3>
          <div class="text-sm text-zinc-400">Auto‑sync via Firestore + Storage</div>
        </div>

        <div class="grid sm:grid-cols-2 gap-3">
          <input id="tplName" class="px-4 py-3 rounded-2xl bg-zinc-900 border border-zinc-700" placeholder="Template name (e.g. A4 Flagship)" />
          <select id="tplSize" class="px-4 py-3 rounded-2xl bg-zinc-900 border border-zinc-700">
            <option value="A4">A4 — 210×297mm</option>
            <option value="A5">A5 — 148×210mm</option>
            <option value="A6">A6 — 105×148mm</option>
          </select>
          <select id="tplOrient" class="px-4 py-3 rounded-2xl bg-zinc-900 border border-zinc-700">
            <option value="portrait">Portrait</option>
            <option value="landscape">Landscape</option>
          </select>
          <select id="tplFit" class="px-4 py-3 rounded-2xl bg-zinc-900 border border-zinc-700">
            <option value="cover">Fill page (no white edge)</option>
            <option value="contain">Fit inside (keep full image)</option>
          </select>
        </div>

        <div class="mt-4 flex items-center gap-3">
          <input id="tplBg" type="file" accept="image/png,image/jpeg" class="hidden" />
          <button id="btnPickBg" class="px-4 py-2.5 rounded-2xl bg-zinc-800 hover:bg-zinc-700 border border-zinc-700">Upload / Replace Background</button>
          <button id="btnSaveTpl" class="px-4 py-2.5 rounded-2xl bg-brand.red hover:bg-red-600 border border-red-700 font-semibold">Save Template</button>
        </div>

        <div class="mt-5">
          <label class="text-sm text-zinc-400">Templates</label>
          <div id="tplList" class="mt-2 grid grid-cols-2 gap-2"></div>
        </div>
      </div>

      <!-- Right: Live Preview + Print -->
      <div class="bg-zinc-900/80 border border-zinc-800 rounded-2xl p-5 shadow-soft">
        <div class="flex items-center justify-between mb-3">
          <h3 class="text-lg font-bold">Preview & Print</h3>
          <button id="btnPrint" class="px-4 py-2.5 rounded-2xl bg-emerald-600 hover:bg-emerald-500 border border-emerald-700 font-semibold">Print</button>
        </div>
        <div class="sheet-preview rounded-xl overflow-hidden">
          <div id="previewFrame" class="sheet-frame">
            <img id="previewImg" alt="template preview" src="" />
          </div>
        </div>
        <p class="mt-3 text-sm text-zinc-400">
          • Printing uses real‑world <span class="font-semibold">mm</span> units and <span class="font-semibold">@page { margin:0 }</span> inside an isolated print frame.<br>
          • Choose <em>Fill page</em> for full‑bleed look, or <em>Fit inside</em> to avoid cropping.
        </p>
      </div>
    </div>

    <!-- ============ Other sections (data that now auto-syncs) ============ -->
    <div class="mt-6 grid md:grid-cols-2 gap-6">
      <!-- Manage Logo -->
      <div class="bg-zinc-900/80 border border-zinc-800 rounded-2xl p-5 shadow-soft">
        <h3 class="text-lg font-bold mb-2">Manage Logo</h3>
        <div class="flex items-center gap-3">
          <input id="logoFile" type="file" accept="image/*" class="hidden" />
          <button id="btnPickLogo" class="px-4 py-2.5 rounded-2xl bg-zinc-800 hover:bg-zinc-700 border border-zinc-700">Upload Logo</button>
          <img id="logoPreview" class="h-10" />
        </div>
      </div>

      <!-- Dealer Settings (very minimal example) -->
      <div class="bg-zinc-900/80 border border-zinc-800 rounded-2xl p-5 shadow-soft">
        <h3 class="text-lg font-bold mb-2">Dealer Settings</h3>
        <label class="text-sm text-zinc-400">Dealer Name</label>
        <input id="dealerName" class="w-full mt-1 px-4 py-3 rounded-2xl bg-zinc-900 border border-zinc-700" placeholder="e.g. Bangkok Dealer" />
        <button id="btnSaveDealer" class="mt-3 px-4 py-2.5 rounded-2xl bg-zinc-800 hover:bg-zinc-700 border border-zinc-700">Save</button>
        <div id="dealerSaved" class="text-xs text-zinc-400 mt-2"></div>
      </div>
    </div>
  </section>

  <script>
    // ========================= CONFIG =========================
    // 1) Replace with your Firebase project config (Project settings > General)
const firebaseConfig = {
  apiKey: "AIza...",            // ต้องขึ้นต้นด้วย AIza
  authDomain: "<projectId>.firebaseapp.com",
  projectId: "<projectId>",
  storageBucket: "<projectId>.appspot.com",
  messagingSenderId: "...",
  appId: "1:...:web:..."
};

    // 2) Optional defaults
    const DEFAULTS = { pageSize: 'A4', orientation: 'portrait', fit: 'cover' };

    <script>
  // ===== Guard: Validate Firebase Config =====
  function validateFirebaseConfig(cfg){
    if (!cfg || typeof cfg !== 'object') throw new Error('Missing firebaseConfig object');
    const required = ['apiKey','authDomain','projectId','storageBucket','appId'];
    for (const k of required){ if(!cfg[k]) throw new Error('firebaseConfig.'+k+' is missing'); }
    if (!/^AIza[0-9A-Za-z-_]{35}$/.test(cfg.apiKey)) {
      throw new Error('firebaseConfig.apiKey looks invalid (must start with AIza…)');
    }
  }

  try {
    validateFirebaseConfig(firebaseConfig);
    firebase.initializeApp(firebaseConfig);
  } catch (err) {
    console.error(err);
    const msg = [
      'Firebase config error → '+err.message,
      'Fix steps:',
      '1) Copy the Web App config from Project settings → General → Your apps (</>)',
      '2) Paste into index.html exactly (no extra spaces/quotes)',
      '3) Enable Email/Password sign-in',
      '4) Add your domain in Authorized domains',
    ].join('\n');
    alert(msg);
    throw err; // stop further execution
  }

    // ========================= FIREBASE INIT =========================
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage();

    // Enable offline cache (helps when connection drops; syncs later)
    if (db && db.enablePersistence) { db.enablePersistence().catch(()=>{}); }

    // ========================= UI REFS =========================
    const authArea = document.getElementById('authArea');
    const appArea = document.getElementById('appArea');
    const whoami = document.getElementById('whoami');
    const btnLogout = document.getElementById('btnLogout');

    // Login
    const loginEmail = document.getElementById('loginEmail');
    const loginPass = document.getElementById('loginPass');
    const btnLogin = document.getElementById('btnLogin');

    // Host create
    const hostEmail = document.getElementById('hostEmail');
    const hostPass = document.getElementById('hostPass');
    const btnCreateHost = document.getElementById('btnCreateHost');

    // Template inputs
    const tplName = document.getElementById('tplName');
    const tplSize = document.getElementById('tplSize');
    const tplOrient = document.getElementById('tplOrient');
    const tplFit = document.getElementById('tplFit');
    const tplBgInput = document.getElementById('tplBg');
    const btnPickBg = document.getElementById('btnPickBg');
    const btnSaveTpl = document.getElementById('btnSaveTpl');
    const tplList = document.getElementById('tplList');

    // Preview
    const previewImg = document.getElementById('previewImg');
    const previewFrame = document.getElementById('previewFrame');
    const btnPrint = document.getElementById('btnPrint');

    // Logo + Dealer
    const btnPickLogo = document.getElementById('btnPickLogo');
    const logoFile = document.getElementById('logoFile');
    const logoPreview = document.getElementById('logoPreview');
    const dealerName = document.getElementById('dealerName');
    const btnSaveDealer = document.getElementById('btnSaveDealer');
    const dealerSaved = document.getElementById('dealerSaved');

    // Current selection state
    let currentTemplate = null; // { id, name, size, orientation, fit, bgUrl }
    let pickedBgFile = null;

    // ========================= AUTH =========================
    auth.onAuthStateChanged(async (user) => {
      if (user) {
        whoami.textContent = user.email;
        authArea.classList.add('hidden');
        appArea.classList.remove('hidden');
        attachLiveListeners();
        await loadLogo();
        await loadDealer();
      } else {
        whoami.textContent = '—';
        appArea.classList.add('hidden');
        authArea.classList.remove('hidden');
      }
    });

    btnLogin.onclick = async () => {
      try {
        await auth.signInWithEmailAndPassword(loginEmail.value.trim(), loginPass.value);
      } catch (e) { alert(e.message); }
    };

    btnLogout.onclick = () => auth.signOut();

    btnCreateHost.onclick = async () => {
      try {
        const email = hostEmail.value.trim();
        const pass = hostPass.value.trim();
        if (!email || !pass) return alert('Fill host email & password');
        await auth.createUserWithEmailAndPassword(email, pass);
        alert('Host created. You are signed in.');
      } catch (e) { alert(e.message); }
    };

    // ========================= TEMPLATE MGMT =========================
    btnPickBg.onclick = () => tplBgInput.click();
    tplBgInput.onchange = () => { pickedBgFile = tplBgInput.files?.[0] || null; if (pickedBgFile) previewImg.src = URL.createObjectURL(pickedBgFile); };

    btnSaveTpl.onclick = async () => {
      try {
        const name = (tplName.value || '').trim();
        if (!name) return alert('Please enter template name');
        const size = tplSize.value || DEFAULTS.pageSize;
        const orientation = tplOrient.value || DEFAULTS.orientation;
        const fit = tplFit.value || DEFAULTS.fit;
        let bgUrl = currentTemplate?.bgUrl || '';

        // If a new BG file picked, upload to Storage and get URL
        if (pickedBgFile) {
          const id = currentTemplate?.id || crypto.randomUUID();
          const ref = storage.ref(`templates/${id}/background_${Date.now()}`);
          await ref.put(pickedBgFile);
          bgUrl = await ref.getDownloadURL();
          currentTemplate = { ...(currentTemplate||{ id }), name, size, orientation, fit, bgUrl };
        }

        // Save to Firestore (auto‑sync to all clients)
        if (!currentTemplate?.id) currentTemplate = { id: crypto.randomUUID(), name, size, orientation, fit, bgUrl };
        await db.collection('templates').doc(currentTemplate.id).set(currentTemplate, { merge: true });
        alert('Template saved');
        pickedBgFile = null;
      } catch (e) { alert(e.message); }
    };

    // Render small cards
    function renderTplCard(tpl){
      const el = document.createElement('button');
      el.className = 'group bg-zinc-900 border border-zinc-800 rounded-xl p-2 text-left hover:bg-zinc-800';
      el.innerHTML = `
        <div class="w-full aspect-[3/2] bg-black/40 rounded-md overflow-hidden grid place-items-center">
          ${tpl.bgUrl ? `<img src="${tpl.bgUrl}" class="w-full h-full object-cover opacity-80 group-hover:opacity-100"/>` : `<div class='text-xs text-zinc-500'>no image</div>`}
        </div>
        <div class="mt-2 text-sm font-semibold oneline">${tpl.name}</div>
        <div class="text-xs text-zinc-400">${tpl.size} • ${tpl.orientation} • ${tpl.fit}</div>`;
      el.onclick = () => selectTemplate(tpl);
      return el;
    }

    function selectTemplate(tpl){
      currentTemplate = tpl;
      tplName.value = tpl.name || '';
      tplSize.value = tpl.size || DEFAULTS.pageSize;
      tplOrient.value = tpl.orientation || DEFAULTS.orientation;
      tplFit.value = tpl.fit || DEFAULTS.fit;
      previewImg.src = tpl.bgUrl || '';
      setPreviewAspect(tpl.size, tpl.orientation);
    }

    function setPreviewAspect(size, orient){
      const map = { A4:[210,297], A5:[148,210], A6:[105,148] };
      const [w,h] = map[size] || map.A4;
      const ratio = orient==='landscape' ? (h+'/'+w) : (w+'/'+h);
      previewFrame.style.aspectRatio = ratio;
    }

    function attachLiveListeners(){
      db.collection('templates').orderBy('name').onSnapshot(snap => {
        tplList.innerHTML = '';
        snap.forEach(doc => { const data = doc.data(); tplList.appendChild(renderTplCard(data)); });
        if (!currentTemplate && snap.size) selectTemplate(snap.docs[0].data());
      });
    }

    // ========================= PRINT (FIT TO PAGE) =========================
    btnPrint.onclick = () => {
      if (!currentTemplate?.bgUrl) return alert('Please select a template with background');
      openPrintFrame(currentTemplate);
    };

    function openPrintFrame(tpl){
      const map = { A4:[210,297], A5:[148,210], A6:[105,148] };
      let [wmm, hmm] = map[tpl.size] || map.A4;
      if (tpl.orientation === 'landscape') [wmm,hmm] = [hmm,wmm];
      const fit = (tpl.fit||'cover'); // 'cover' or 'contain'
      const src = tpl.bgUrl;

      const html = `<!DOCTYPE html><html><head><meta charset='utf-8'>
        <style>
          @page { size: ${wmm}mm ${hmm}mm; margin: 0; }
          html,body { height: 100%; margin: 0; -webkit-print-color-adjust: exact; print-color-adjust: exact; background: #fff; }
          .sheet { width:${wmm}mm; height:${hmm}mm; display:grid; place-items:center; }
          img.bg { width:100%; height:100%; object-fit:${fit}; }
        </style>
      </head>
      <body>
        <div class='sheet'>
          <img class='bg' src='${src}' alt='bg'/>
        </div>
        <script>setTimeout(()=>{ window.print(); setTimeout(()=>window.close(), 300); }, 150);<\/script>
      </body></html>`;

      const w = window.open('', '_blank');
      w.document.open();
      w.document.write(html);
      w.document.close();
    }

    // ========================= LOGO (sync) =========================
    btnPickLogo.onclick = () => logoFile.click();
    logoFile.onchange = async () => {
      const f = logoFile.files?.[0]; if (!f) return;
      const ref = storage.ref(`org/logo_${Date.now()}`);
      await ref.put(f); const url = await ref.getDownloadURL();
      await db.collection('org').doc('branding').set({ logo:url }, { merge:true });
    };

    async function loadLogo(){
      db.collection('org').doc('branding').onSnapshot(doc => {
        logoPreview.src = doc.data()?.logo || '';
      });
    }

    // ========================= DEALER SETTINGS (sync) =========================
    btnSaveDealer.onclick = async () => {
      await db.collection('settings').doc('dealer').set({ name: dealerName.value.trim() || '' }, { merge:true });
      dealerSaved.textContent = 'Saved at ' + new Date().toLocaleTimeString();
      setTimeout(()=>dealerSaved.textContent='', 2000);
    }

    async function loadDealer(){
      db.collection('settings').doc('dealer').onSnapshot(doc => {
        dealerName.value = doc.data()?.name || '';
      });
    }
  </script>
</body>
</html>
