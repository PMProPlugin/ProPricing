<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Price Tag Manager — Fixed</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @media print {
      .no-print { display: none !important; }
    }
  </style>
</head>
<body class="bg-zinc-950 text-zinc-100 min-h-screen">
  <!-- App Shell -->
  <header class="border-b border-zinc-800 sticky top-0 bg-zinc-950/70 backdrop-blur no-print">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="font-semibold tracking-wide">Price Tag Manager</div>
      <div id="currentUserBadge" class="text-sm text-zinc-300"></div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-6">
    <!-- ===== First-Run Setup View ===== -->
    <section id="view-setup" class="hidden">
      <h1 class="text-xl font-semibold mb-4">เริ่มต้นใช้งานครั้งแรก</h1>

      <div class="grid md:grid-cols-2 gap-6">
        <!-- Create Host Block -->
        <div class="p-5 rounded-2xl border border-zinc-800">
          <h2 class="font-medium mb-3">สร้างบัญชี Host (แอดมินสูงสุด)</h2>
          <label class="block text-sm mb-1">ชื่อผู้ใช้</label>
          <input id="setupHostUsername" class="w-full px-3 py-2 rounded-xl bg-zinc-900 border border-zinc-800 mb-3" placeholder="host" />
          <label class="block text-sm mb-1">รหัสผ่าน</label>
          <input id="setupHostPassword" type="password" class="w-full px-3 py-2 rounded-xl bg-zinc-900 border border-zinc-800 mb-3" placeholder="••••••" />
          <label class="block text-sm mb-1">ยืนยันรหัสผ่าน</label>
          <input id="setupHostPassword2" type="password" class="w-full px-3 py-2 rounded-xl bg-zinc-900 border border-zinc-800 mb-4" placeholder="••••••" />
          <button id="btnCreateHost" class="px-4 py-2 rounded-xl bg-emerald-600 hover:bg-emerald-500">สร้างบัญชี Host</button>
          <p id="setupHostMsg" class="text-sm text-zinc-400 mt-3"></p>
        </div>

        <!-- Cloud Load Block on First Run -->
        <div class="p-5 rounded-2xl border border-zinc-800">
          <h2 class="font-medium mb-3">มีข้อมูลอยู่บน Cloud แล้ว?</h2>
          <p class="text-sm text-zinc-400 mb-3">กรอก GitHub Token และ Gist ID เพื่อโหลดสแนปช็อตมาใช้ทันที จากนั้นไปที่หน้าเข้าสู่ระบบ</p>
          <label class="block text-sm mb-1">GitHub Token (scopes: <code>gist</code>)</label>
          <input id="frToken" class="w-full px-3 py-2 rounded-xl bg-zinc-900 border border-zinc-800 mb-3" placeholder="ghp_..." />
          <label class="block text-sm mb-1">Gist ID</label>
          <input id="frGistId" class="w-full px-3 py-2 rounded-xl bg-zinc-900 border border-zinc-800 mb-4" placeholder="xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" />
          <div class="flex gap-2">
            <button id="btnFirstRunCloudLoad" class="px-4 py-2 rounded-xl bg-sky-600 hover:bg-sky-500">Load from Cloud</button>
            <button id="btnGoLoginFromSetup" class="px-4 py-2 rounded-xl bg-zinc-700 hover:bg-zinc-600">ไปหน้า Login</button>
          </div>
          <p id="firstRunMsg" class="text-sm text-zinc-400 mt-3"></p>
        </div>
      </div>
    </section>

    <!-- ===== Login View ===== -->
    <section id="view-login" class="hidden">
      <h1 class="text-xl font-semibold mb-4">เข้าสู่ระบบ</h1>
      <div class="grid md:grid-cols-2 gap-6">
        <div class="p-5 rounded-2xl border border-zinc-800">
          <label class="block text-sm mb-1">ชื่อผู้ใช้</label>
          <input id="loginUsername" class="w-full px-3 py-2 rounded-xl bg-zinc-900 border border-zinc-800 mb-3" placeholder="username" />
          <label class="block text-sm mb-1">รหัสผ่าน</label>
          <input id="loginPassword" type="password" class="w-full px-3 py-2 rounded-xl bg-zinc-900 border border-zinc-800 mb-4" placeholder="••••••" />
          <button id="btnLogin" class="px-4 py-2 rounded-xl bg-emerald-600 hover:bg-emerald-500">เข้าสู่ระบบ</button>
          <p id="loginMsg" class="text-sm text-zinc-400 mt-3"></p>
        </div>
        <div class="p-5 rounded-2xl border border-zinc-800">
          <h2 class="font-medium mb-3">โหลดข้อมูลจาก Cloud (ถ้ามี)</h2>
          <label class="block text-sm mb-1">GitHub Token</label>
          <input id="loginToken" class="w-full px-3 py-2 rounded-xl bg-zinc-900 border border-zinc-800 mb-3" placeholder="ghp_..." />
          <label class="block text-sm mb-1">Gist ID</label>
          <input id="loginGistId" class="w-full px-3 py-2 rounded-xl bg-zinc-900 border border-zinc-800 mb-4" placeholder="xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" />
          <div class="flex gap-2">
            <button id="btnLoginCloudLoad" class="px-4 py-2 rounded-xl bg-sky-600 hover:bg-sky-500">Load from Cloud</button>
            <button id="btnGoSetupFromLogin" class="px-4 py-2 rounded-xl bg-zinc-700 hover:bg-zinc-600">ไปหน้า Setup</button>
          </div>
          <p class="text-xs text-zinc-500 mt-2">*ระบบจะจดจำ Token และ Gist ID ไว้ในเครื่องนี้เพื่อโหลดอัตโนมัติครั้งต่อไป (สามารถลบได้ใน Settings)</p>
          <p id="loginCloudMsg" class="text-sm text-zinc-400 mt-3"></p>
        </div>
      </div>
    </section>

    <!-- ===== App View ===== -->
    <section id="view-app" class="hidden">
      <!-- Top Bar -->
      <div class="no-print mb-5 flex items-center gap-3">
        <button data-tab="products" class="tab-btn px-4 py-2 rounded-xl bg-zinc-800">Products</button>
        <button data-tab="templates" class="tab-btn px-4 py-2 rounded-xl bg-zinc-900 border border-zinc-800">Templates</button>
        <button data-tab="settings" class="tab-btn px-4 py-2 rounded-xl bg-zinc-900 border border-zinc-800">Settings</button>
        <div class="ml-auto flex items-center gap-2">
          <button id="btnCloudSave" class="px-3 py-2 rounded-xl bg-sky-600 hover:bg-sky-500 no-print">Save ↥ Cloud</button>
          <button id="btnCloudLoad" class="px-3 py-2 rounded-xl bg-sky-700 hover:bg-sky-600 no-print">Load ↧ Cloud</button>
          <button id="btnLogout" class="px-3 py-2 rounded-xl bg-zinc-700 hover:bg-zinc-600 no-print">ออกจากระบบ</button>
        </div>
      </div>

      <!-- Tabs -->
      <div id="tab-products">
        <div class="no-print mb-3 flex items-center gap-3">
          <input id="searchSku" class="px-3 py-2 rounded-xl bg-zinc-900 border border-zinc-800 w-64" placeholder="ค้นหา SKU/ชื่อ" />
          <select id="channelFilter" class="px-3 py-2 rounded-xl bg-zinc-900 border border-zinc-800">
            <option value="Flagship">Flagship</option>
            <option value="Marketplace">Marketplace</option>
            <option value="Dealer">Dealer</option>
          </select>
          <button id="btnAddProduct" class="px-3 py-2 rounded-xl bg-emerald-600 hover:bg-emerald-500">เพิ่มสินค้า</button>
        </div>

        <div class="overflow-x-auto border border-zinc-800 rounded-2xl">
          <table class="w-full text-sm">
            <thead class="bg-zinc-900">
              <tr>
                <th class="px-3 py-2 text-left">SKU</th>
                <th class="px-3 py-2 text-left">ชื่อ</th>
                <th class="px-3 py-2 text-left">ราคา Flagship</th>
                <th class="px-3 py-2 text-left">ราคา Marketplace</th>
                <th class="px-3 py-2 text-left">ราคา Dealer</th>
                <th class="px-3 py-2 text-left col-costs">Costs (สิทธิ์เฉพาะ)</th>
                <th class="px-3 py-2 text-left col-expires">Expires Date</th>
                <th class="px-3 py-2 text-left">Details</th>
                <th class="px-3 py-2 text-left">Actions</th>
              </tr>
            </thead>
            <tbody id="productsTbody" class="divide-y divide-zinc-800"></tbody>
          </table>
        </div>

        <div class="mt-6">
          <h3 class="font-medium mb-2">ตัวอย่างป้าย (Preview)</h3>
          <div id="previewArea" class="grid md:grid-cols-3 gap-4"></div>
        </div>
      </div>

      <div id="tab-templates" class="hidden">
        <div class="no-print mb-3 flex items-center gap-2">
          <button id="btnUploadTemplate" class="px-3 py-2 rounded-xl bg-emerald-600 hover:bg-emerald-500">อัปโหลดเทมเพลต (PNG/JPG)</button>
          <input id="templateFile" type="file" accept="image/png,image/jpeg" class="hidden" />
        </div>
        <div id="templatesList" class="grid md:grid-cols-3 gap-4"></div>
      </div>

      <div id="tab-settings" class="hidden">
        <div class="grid md:grid-cols-2 gap-6">
          <div class="p-5 rounded-2xl border border-zinc-800">
            <h3 class="font-medium mb-3">Cloud Sync (GitHub Gist)</h3>
            <label class="block text-sm mb-1">GitHub Token</label>
            <input id="setToken" class="w-full px-3 py-2 rounded-xl bg-zinc-900 border border-zinc-800 mb-3" />
            <label class="block text-sm mb-1">Gist ID</label>
            <input id="setGistId" class="w-full px-3 py-2 rounded-xl bg-zinc-900 border border-zinc-800 mb-4" />
            <div class="flex gap-2">
              <button id="btnSaveSettings" class="px-3 py-2 rounded-xl bg-zinc-700 hover:bg-zinc-600">บันทึก</button>
              <button id="btnCreateGist" class="px-3 py-2 rounded-xl bg-sky-600 hover:bg-sky-500">Create New Gist</button>
            </div>
            <p id="settingsMsg" class="text-sm text-zinc-400 mt-3"></p>
          </div>

          <div class="p-5 rounded-2xl border border-zinc-800">
            <h3 class="font-medium mb-3">ผู้ใช้ & สิทธิ์</h3>
            <div class="flex gap-2 mb-3">
              <input id="newUsername" class="flex-1 px-3 py-2 rounded-xl bg-zinc-900 border border-zinc-800" placeholder="username" />
              <input id="newPassword" type="password" class="flex-1 px-3 py-2 rounded-xl bg-zinc-900 border border-zinc-800" placeholder="password" />
            </div>
            <div class="flex gap-2 mb-3">
              <select id="newRole" class="px-3 py-2 rounded-xl bg-zinc-900 border border-zinc-800">
                <option>host</option>
                <option>manager</option>
                <option>staff</option>
                <option>viewer</option>
              </select>
              <button id="btnAddUser" class="px-3 py-2 rounded-xl bg-emerald-600 hover:bg-emerald-500">เพิ่มผู้ใช้</button>
            </div>
            <div id="usersList" class="space-y-2"></div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <template id="tpl-product-row">
    <tr>
      <td class="px-3 py-2 text-zinc-300 font-mono"></td>
      <td class="px-3 py-2"></td>
      <td class="px-3 py-2"></td>
      <td class="px-3 py-2"></td>
      <td class="px-3 py-2"></td>
      <td class="px-3 py-2 col-costs"></td>
      <td class="px-3 py-2 col-expires"></td>
      <td class="px-3 py-2"></td>
      <td class="px-3 py-2">
        <button class="btnEdit px-2 py-1 rounded-lg bg-zinc-800 mr-1">แก้ไข</button>
        <button class="btnDelete px-2 py-1 rounded-lg bg-red-700">ลบ</button>
      </td>
    </tr>
  </template>

  <script>
  // ============================
  // Storage Keys & In-Memory
  // ============================
  const LS = {
    users: 'ptm.users',
    settings: 'ptm.settings',
    products: 'ptm.products',
    templates: 'ptm.templates',
    session: 'ptm.session',
  };

  const $ = (sel, root=document) => root.querySelector(sel);
  const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

  function getJSON(key, fallback) {
    try { return JSON.parse(localStorage.getItem(key)) ?? fallback; } catch { return fallback; }
  }
  function setJSON(key, val) { localStorage.setItem(key, JSON.stringify(val)); }

  function getUsers(){ return getJSON(LS.users, []); }
  function setUsers(u){ setJSON(LS.users, u); }
  function getSettings(){ return getJSON(LS.settings, { token: '', gistId: '' }); }
  function setSettings(s){ setJSON(LS.settings, s); }
  function getProducts(){ return getJSON(LS.products, []); }
  function setProducts(p){ setJSON(LS.products, p); }
  function getTemplates(){ return getJSON(LS.templates, []); }
  function setTemplates(t){ setJSON(LS.templates, t); }
  function getSession(){ return getJSON(LS.session, null); }
  function setSession(sess){ setJSON(LS.session, sess); }

  // ============================
  // Crypto (PBKDF2 + fallback SHA-256)
  // ============================
  async function sha256(str){
    const enc = new TextEncoder();
    const buf = await crypto.subtle.digest('SHA-256', enc.encode(str));
    return btoa(String.fromCharCode(...new Uint8Array(buf)));
  }

  function randSalt(len=16){
    const b = new Uint8Array(len);
    crypto.getRandomValues(b);
    return btoa(String.fromCharCode(...b));
  }

  async function pbkdf2(password, saltB64, iterations=150000, keyLen=32){
    const enc = new TextEncoder();
    const salt = Uint8Array.from(atob(saltB64), c=>c.charCodeAt(0));
    const keyMaterial = await crypto.subtle.importKey('raw', enc.encode(password), {name:'PBKDF2'}, false, ['deriveBits']);
    const bits = await crypto.subtle.deriveBits({name:'PBKDF2', hash:'SHA-256', salt, iterations}, keyMaterial, keyLen*8);
    return btoa(String.fromCharCode(...new Uint8Array(bits)));
  }

  async function createUser(username, password, role='viewer'){
    const users = getUsers();
    if(users.some(u=>u.username===username)) throw new Error('มีผู้ใช้นี้อยู่แล้ว');
    const salt = randSalt();
    const hash = await pbkdf2(password, salt);
    const user = { id: crypto.randomUUID(), username, role, kdf:'pbkdf2', iterations:150000, salt, hash };
    users.push(user); setUsers(users);
    return user;
  }

  async function verifyPassword(user, password){
    if(user.kdf==='pbkdf2'){
      const h = await pbkdf2(password, user.salt, user.iterations||150000);
      return h===user.hash;
    }
    if(user.passwordHash){ // legacy fallback
      const h = await sha256(password);
      return h===user.passwordHash;
    }
    return false;
  }

  // ============================
  // UI Helpers
  // ============================
  function show(id){ $(id).classList.remove('hidden'); }
  function hide(id){ $(id).classList.add('hidden'); }
  function setView(v){
    ['#view-setup','#view-login','#view-app'].forEach(hide);
    if(v==='setup') show('#view-setup');
    else if(v==='login') show('#view-login');
    else show('#view-app');
  }

  function escapeHTML(str){
    return (str||'').replace(/[&<>"']/g, s=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[s]));
  }

  // ============================
  // Cloud (GitHub Gist)
  // ============================
  async function cloudSave(){
    const {token, gistId} = getSettings();
    if(!token) throw new Error('ยังไม่ได้ตั้งค่า Token');
    const snapshot = {
      version: 1,
      users: getUsers(),
      products: getProducts(),
      templates: getTemplates(),
      savedAt: new Date().toISOString()
    };
    const headers = { 'Authorization': `token ${token}`, 'Accept': 'application/vnd.github+json' };

    if(gistId){
      const res = await fetch(`https://api.github.com/gists/${gistId}`, {
        method:'PATCH', headers, body: JSON.stringify({ files: { 'ptm.json': { content: JSON.stringify(snapshot, null, 2) } } })
      });
      if(!res.ok) throw new Error('บันทึกไม่สำเร็จ: '+res.status);
      return { gistId };
    } else {
      const body = { description:'PTM Snapshot', public:false, files:{ 'ptm.json': { content: JSON.stringify(snapshot, null, 2) } } };
      const res = await fetch('https://api.github.com/gists', { method:'POST', headers, body: JSON.stringify(body) });
      if(!res.ok) throw new Error('สร้าง Gist ไม่สำเร็จ: '+res.status);
      const data = await res.json();
      const id = data.id; setSettings({ token, gistId:id });
      return { gistId:id };
    }
  }

  async function cloudLoad(tokenOverride, gistIdOverride){
    const s = getSettings();
    const token = tokenOverride ?? s.token;
    const gistId = gistIdOverride ?? s.gistId;
    if(!token || !gistId) throw new Error('ต้องมี Token และ Gist ID');
    const res = await fetch(`https://api.github.com/gists/${gistId}`, { headers:{ 'Authorization': `token ${token}`, 'Accept':'application/vnd.github+json' } });
    if(!res.ok) throw new Error('โหลดไม่สำเร็จ: '+res.status);
    const data = await res.json();
    const file = data.files?.['ptm.json'];
    if(!file?.content) throw new Error('ไม่พบไฟล์ ptm.json ใน Gist');
    const snapshot = JSON.parse(file.content);
    if(snapshot.users) setUsers(snapshot.users);
    if(snapshot.products) setProducts(snapshot.products);
    if(snapshot.templates) setTemplates(snapshot.templates);
    return snapshot;
  }

  async function tryAutoCloudLoad(){
    // ถ้าไม่มีผู้ใช้ แต่ตั้งค่า Token+Gist ไว้แล้ว ให้ลองโหลดอัตโนมัติ
    if(getUsers().length===0){
      const {token, gistId} = getSettings();
      if(token && gistId){
        try { await cloudLoad(); } catch(e){ console.warn('Auto cloud load failed:', e.message); }
      }
    }
  }

  // ============================
  // App Logic
  // ============================
  function refreshCurrentUserBadge(){
    const sess = getSession();
    $('#currentUserBadge').textContent = sess ? `${sess.username} · ${sess.role}` : '';
  }

  function setTab(name){
    ['products','templates','settings'].forEach(t=>{
      const on = (t===name);
      $(`#tab-${t}`).classList.toggle('hidden', !on);
      const btn = document.querySelector(`.tab-btn[data-tab="${t}"]`);
      btn.classList.toggle('bg-zinc-800', on);
      btn.classList.toggle('bg-zinc-900', !on);
      btn.classList.toggle('border', !on);
      btn.classList.toggle('border-zinc-800', !on);
    });
  }

  function maybeToggleProtectedColumns(){
    const sess = getSession();
    const canSeeCosts = !!sess && ['host','manager'].includes(sess.role);
    $$('.col-costs').forEach(td=> td.classList.toggle('hidden', !canSeeCosts));
  }

  function maybeToggleExpiresColumn(){
    const ch = $('#channelFilter').value;
    const show = (ch==='Flagship');
    $$('.col-expires').forEach(td=> td.classList.toggle('hidden', !show));
  }

  function renderUsers(){
    const list = $('#usersList');
    list.innerHTML='';
    const users = getUsers();
    for(const u of users){
      const row = document.createElement('div');
      row.className = 'flex items-center justify-between px-3 py-2 rounded-xl bg-zinc-900 border border-zinc-800';
      row.innerHTML = `<div><span class="font-medium">${escapeHTML(u.username)}</span> <span class="text-xs text-zinc-400">· ${u.role}</span></div>
      <div class="flex gap-2">
        <button class="btnReset px-2 py-1 rounded-lg bg-zinc-800" data-id="${u.id}">รีเซ็ตรหัส</button>
        <button class="btnRemove px-2 py-1 rounded-lg bg-red-700" data-id="${u.id}">ลบ</button>
      </div>`;
      list.appendChild(row);
    }

    list.addEventListener('click', async (e)=>{
      const id = e.target?.dataset?.id; if(!id) return;
      const users = getUsers();
      const idx = users.findIndex(x=>x.id===id);
      if(idx<0) return;
      if(e.target.classList.contains('btnRemove')){
        users.splice(idx,1); setUsers(users); renderUsers(); return;
      }
      if(e.target.classList.contains('btnReset')){
        const pass = prompt('กำหนดรหัสผ่านใหม่'); if(!pass) return;
        const u = users[idx];
        const salt = randSalt(); const hash = await pbkdf2(pass, salt);
        users[idx] = { ...u, kdf:'pbkdf2', iterations:150000, salt, hash, passwordHash: undefined };
        setUsers(users); alert('อัปเดตรหัสแล้ว');
      }
    }, { once:true });
  }

  function renderProducts(){
    const tbody = $('#productsTbody');
    tbody.innerHTML='';
    const q = ($('#searchSku').value||'').toLowerCase();
    const ch = $('#channelFilter').value;
    const products = getProducts().filter(p=> (p.sku?.toLowerCase().includes(q) || p.name?.toLowerCase().includes(q)) );

    for(const p of products){
      const tr = document.importNode($('#tpl-product-row').content, true);
      const tds = tr.querySelectorAll('td');
      tds[0].textContent = p.sku||'';
      tds[1].textContent = p.name||'';
      tds[2].textContent = formatMoney(p.priceFlagship);
      tds[3].textContent = formatMoney(p.priceMarketplace);
      tds[4].textContent = formatMoney(p.priceDealer);
      tds[5].textContent = p.costs!=null ? formatMoney(p.costs) : '';
      tds[6].textContent = p.expires||'';
      // details: render as text-only bullets (escape)
      tds[7].innerHTML = (p.details||[]).map(d=>`<div class="text-zinc-300">• ${escapeHTML(d)}</div>`).join('');

      const [btnEdit, btnDelete] = tr.querySelectorAll('button');
      btnEdit.addEventListener('click', ()=> editProduct(p));
      btnDelete.addEventListener('click', ()=> deleteProduct(p));
      tbody.appendChild(tr);
    }

    maybeToggleProtectedColumns();
    maybeToggleExpiresColumn();

    // Preview sample (first 3)
    const area = $('#previewArea');
    area.innerHTML='';
    products.slice(0,3).forEach(async item=>{
      const el = await buildPreviewTag(item);
      area.appendChild(el);
    });
  }

  function formatMoney(n){
    if(n==null || isNaN(n)) return '';
    return new Intl.NumberFormat('th-TH',{ style:'currency', currency:'THB', maximumFractionDigits:0 }).format(n);
  }

  function editProduct(p){
    const name = prompt('ชื่อสินค้า', p.name||''); if(name==null) return;
    const sku = prompt('SKU', p.sku||''); if(sku==null) return;
    const pf = +prompt('ราคา Flagship', p.priceFlagship??'') || 0;
    const pm = +prompt('ราคา Marketplace', p.priceMarketplace??'') || 0;
    const pd = +prompt('ราคา Dealer', p.priceDealer??'') || 0;
    const costs = +prompt('Costs (ถ้ามีสิทธิ์)', p.costs??'') || 0;
    const expires = prompt('วันหมดอายุ (YYYY-MM-DD)', p.expires||'') || '';
    const detailsRaw = prompt('รายละเอียด (คั่นบรรทัด)\nจะถูกบันทึกเป็นข้อความปลอดภัย (ไม่ใช้ HTML)', (p.details||[]).join('\n'))||'';

    const products = getProducts();
    const idx = products.findIndex(x=>x.sku===p.sku);
    const details = detailsRaw.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
    const np = { ...p, name, sku, priceFlagship:pf, priceMarketplace:pm, priceDealer:pd, costs, expires, details };
    if(idx>=0) products[idx] = np; else products.push(np);
    setProducts(products); renderProducts();
  }

  function deleteProduct(p){
    if(!confirm('ลบสินค้านี้?')) return;
    const products = getProducts().filter(x=>x.sku!==p.sku);
    setProducts(products); renderProducts();
  }

  async function buildPreviewTag(item){
    // Simple preview: either use first template image as background or plain card
    const wrap = document.createElement('div');
    wrap.className = 'p-4 rounded-2xl border border-zinc-800';

    const tpl = getTemplates()[0];
    if(tpl?.imageData){
      const img = new Image();
      img.src = tpl.imageData;
      await img.decode().catch(()=>{}); // ⟵ รอรูปเพื่ออ่านขนาดจริง
      const W = img.naturalWidth || 640, H = img.naturalHeight || 480;
      const scale = 240 / W; // fit width ~240px
      const canvas = document.createElement('canvas');
      canvas.width = Math.round(W*scale);
      canvas.height = Math.round(H*scale);
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

      // Overlay simple texts
      ctx.font = 'bold 16px sans-serif';
      ctx.fillStyle = '#111';
      ctx.fillText(item.name||'', 12, 24);
      ctx.font = '14px sans-serif';
      ctx.fillText(formatMoney(item.priceFlagship||item.priceMarketplace||item.priceDealer||0), 12, 46);

      wrap.appendChild(canvas);
    } else {
      wrap.innerHTML = `<div class="text-sm text-zinc-400 mb-2">(ไม่มีภาพเทมเพลต — แสดงการ์ดพื้นฐาน)</div>
      <div class="rounded-xl bg-zinc-900 border border-zinc-800 p-4">
        <div class="text-xs text-zinc-400">${escapeHTML(item.sku||'')}</div>
        <div class="font-medium">${escapeHTML(item.name||'')}</div>
        <div class="text-lg">${formatMoney(item.priceFlagship||item.priceMarketplace||item.priceDealer||0)}</div>
        ${(item.details||[]).slice(0,3).map(d=>`<div class="text-zinc-300">• ${escapeHTML(d)}</div>`).join('')}
      </div>`;
    }

    return wrap;
  }

  // ============================
  // Templates
  // ============================
  function renderTemplates(){
    const box = $('#templatesList');
    box.innerHTML='';
    const tpls = getTemplates();
    if(tpls.length===0){ box.innerHTML = '<div class="text-sm text-zinc-400">ยังไม่มีเทมเพลต</div>'; return; }
    for(const t of tpls){
      const card = document.createElement('div');
      card.className = 'rounded-2xl border border-zinc-800 overflow-hidden';
      card.innerHTML = `<div class="aspect-video bg-zinc-900">${ t.imageData ? `<img src="${t.imageData}" class="w-full h-full object-cover"/>` : ''}</div>
      <div class="p-3 flex items-center justify-between">
        <div class="text-sm">${escapeHTML(t.name)}</div>
        <button class="btnRemoveTpl px-2 py-1 rounded-lg bg-red-700" data-id="${t.id}">ลบ</button>
      </div>`;
      box.appendChild(card);
    }
    box.addEventListener('click', (e)=>{
      const id = e.target?.dataset?.id; if(!id) return;
      if(e.target.classList.contains('btnRemoveTpl')){
        const tpls = getTemplates().filter(x=>x.id!==id);
        setTemplates(tpls); renderTemplates();
      }
    }, { once:true });
  }

  function handleTemplateUpload(file){
    const reader = new FileReader();
    reader.onload = ()=>{
      const tpls = getTemplates();
      tpls.push({ id: crypto.randomUUID(), name: file.name, imageData: reader.result });
      setTemplates(tpls); renderTemplates(); renderProducts();
    };
    reader.readAsDataURL(file);
  }

  // ============================
  // Init & Event Wiring
  // ============================
  async function init(){
    await tryAutoCloudLoad();

    const sess = getSession();
    if(sess){ setView('app'); refreshCurrentUserBadge(); setTab('products'); renderProducts(); renderTemplates(); wireSettingsForm(); return; }

    if(getUsers().length===0){ setView('setup'); }
    else { setView('login'); }
  }

  function wireSettingsForm(){
    const s = getSettings();
    $('#setToken').value = s.token||'';
    $('#setGistId').value = s.gistId||'';
  }

  // --- Setup events ---
  $('#btnCreateHost').addEventListener('click', async ()=>{
    const u = $('#setupHostUsername').value.trim();
    const p1 = $('#setupHostPassword').value;
    const p2 = $('#setupHostPassword2').value;
    const msg = $('#setupHostMsg'); msg.textContent='';
    if(!u || !p1){ msg.textContent='กรอกชื่อผู้ใช้และรหัสผ่าน'; return; }
    if(p1!==p2){ msg.textContent='รหัสผ่านไม่ตรงกัน'; return; }
    try {
      await createUser(u, p1, 'host');
      msg.textContent='สร้าง Host แล้ว ไปหน้าเข้าสู่ระบบได้เลย';
      setView('login');
    } catch(e){ msg.textContent = e.message; }
  });

  $('#btnFirstRunCloudLoad').addEventListener('click', async ()=>{
    const token = $('#frToken').value.trim();
    const gist = $('#frGistId').value.trim();
    const msg = $('#firstRunMsg'); msg.textContent='กำลังโหลด...';
    try{
      setSettings({ token, gistId:gist });
      await cloudLoad(token, gist);
      msg.textContent='โหลดสำเร็จ! ไปหน้าเข้าสู่ระบบได้เลย';
    }catch(e){ msg.textContent='ผิดพลาด: '+e.message; }
  });

  $('#btnGoLoginFromSetup').addEventListener('click', ()=> setView('login'));

  // --- Login events ---
  $('#btnLogin').addEventListener('click', async ()=>{
    const u = $('#loginUsername').value.trim();
    const p = $('#loginPassword').value;
    const msg = $('#loginMsg'); msg.textContent='';
    const users = getUsers();
    const user = users.find(x=>x.username===u);
    if(!user){ msg.textContent='ไม่พบบัญชีนี้'; return; }
    const ok = await verifyPassword(user, p);
    if(!ok){ msg.textContent='รหัสผ่านไม่ถูกต้อง'; return; }
    setSession({ id:user.id, username:user.username, role:user.role, at:Date.now() });
    setView('app'); refreshCurrentUserBadge(); setTab('products'); renderProducts(); renderTemplates(); wireSettingsForm();
  });

  $('#btnLoginCloudLoad').addEventListener('click', async ()=>{
    const token = $('#loginToken').value.trim();
    const gist = $('#loginGistId').value.trim();
    const msg = $('#loginCloudMsg'); msg.textContent='กำลังโหลด...';
    try{ setSettings({ token, gistId:gist }); await cloudLoad(token, gist); msg.textContent='โหลดสำเร็จ! เข้าสู่ระบบด้วยบัญชีของคุณได้เลย'; }
    catch(e){ msg.textContent='ผิดพลาด: '+e.message; }
  });

  $('#btnGoSetupFromLogin').addEventListener('click', ()=> setView('setup'));

  // --- App topbar ---
  $$('.tab-btn').forEach(b=> b.addEventListener('click', ()=> setTab(b.dataset.tab)) );
  $('#channelFilter').addEventListener('change', ()=>{ maybeToggleExpiresColumn(); renderProducts(); });
  $('#searchSku').addEventListener('input', ()=> renderProducts());

  $('#btnLogout').addEventListener('click', ()=>{ setSession(null); setView('login'); refreshCurrentUserBadge(); });

  $('#btnCloudSave').addEventListener('click', async ()=>{
    try{ const {gistId} = await cloudSave(); alert('บันทึกขึ้น Cloud แล้ว (Gist: '+gistId+')'); }
    catch(e){ alert('บันทึกไม่สำเร็จ: '+e.message); }
  });
  $('#btnCloudLoad').addEventListener('click', async ()=>{
    try{ await cloudLoad(); renderUsers(); renderProducts(); renderTemplates(); alert('โหลดจาก Cloud แล้ว'); }
    catch(e){ alert('โหลดไม่สำเร็จ: '+e.message); }
  });

  // --- Settings ---
  $('#btnSaveSettings').addEventListener('click', ()=>{
    const token = $('#setToken').value.trim();
    const gistId = $('#setGistId').value.trim();
    setSettings({ token, gistId });
    $('#settingsMsg').textContent = 'บันทึกการตั้งค่าแล้ว';
  });

  $('#btnCreateGist').addEventListener('click', async ()=>{
    try{ const {gistId} = await cloudSave(); $('#setGistId').value = gistId; $('#settingsMsg').textContent = 'สร้าง Gist ใหม่และบันทึกแล้ว'; }
    catch(e){ $('#settingsMsg').textContent = 'ผิดพลาด: '+e.message; }
  });

  $('#btnAddUser').addEventListener('click', async ()=>{
    const u = $('#newUsername').value.trim();
    const p = $('#newPassword').value;
    const r = $('#newRole').value;
    if(!u || !p) return alert('กรอกชื่อผู้ใช้และรหัสผ่าน');
    try{ await createUser(u,p,r); renderUsers(); alert('เพิ่มผู้ใช้แล้ว'); }
    catch(e){ alert(e.message); }
  });

  // --- Products ---
  $('#btnAddProduct').addEventListener('click', ()=>{
    editProduct({ sku:'', name:'', priceFlagship:0, priceMarketplace:0, priceDealer:0, costs:null, expires:'', details:[] });
  });

  // --- Templates ---
  $('#btnUploadTemplate').addEventListener('click', ()=> $('#templateFile').click());
  $('#templateFile').addEventListener('change', ()=>{
    const f = $('#templateFile').files?.[0]; if(!f) return;
    if(!/image\/(png|jpeg)/.test(f.type)) return alert('รองรับเฉพาะ PNG/JPG');
    handleTemplateUpload(f);
  });

  // ===== Boot =====
  // Starter data (only if completely empty)
  if(getProducts().length===0 && getUsers().length===0){
    setProducts([
      { sku:'SKU-001', name:'Dynamic Mic', priceFlagship:2990, priceMarketplace:2890, priceDealer:2700, costs:1800, expires:'2025-12-31', details:['Cardioid','Metal body','XLR'] },
      { sku:'SKU-002', name:'Headphones Pro', priceFlagship:4990, priceMarketplace:4790, priceDealer:4500, costs:3200, expires:'', details:['40mm driver','Closed-back'] },
    ]);
    setTemplates([]);
  }

  // If already logged-in, render users too
  if(getSession()) renderUsers();

  init();
  </script>
</body>
</html>
