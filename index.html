<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Price Tag Manager — 100% Online (GitHub Gist)</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root { color-scheme: dark; }
    html,body{height:100%}
    body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,"Noto Sans",sans-serif;}
    .hidden{display:none}
    .card{ @apply rounded-2xl border border-zinc-700 p-5 bg-zinc-900/60 shadow; }
    .btn{ @apply px-4 py-2 rounded-2xl border border-zinc-700 hover:bg-zinc-800 active:scale-[.99] transition; }
    .btn-primary{ @apply bg-zinc-100 text-zinc-900 border-transparent hover:bg-white; }
    .input{ @apply w-full px-4 py-3 rounded-2xl bg-zinc-900 border border-zinc-700; }
    .label{ @apply text-sm text-zinc-400; }
    .muted{ @apply text-xs text-zinc-500; }
  </style>
</head>
<body class="min-h-full bg-[#0a0a0a] text-zinc-100">
  <header class="sticky top-0 z-10 backdrop-blur bg-black/30 border-b border-zinc-800">
    <div class="mx-auto max-w-5xl px-4 py-4 flex items-center justify-between">
      <h1 class="text-lg font-semibold">Price Tag Manager <span class="text-xs text-zinc-400">(100% Online · Gist)</span></h1>
      <div class="flex items-center gap-2">
        <button id="btnCloudForget" class="btn" title="ลบการเชื่อมต่อคลาวด์ (ล้างพารามิเตอร์ใน URL)">Forget Cloud</button>
        <button id="btnLogout" class="btn hidden">Sign Out</button>
      </div>
    </div>
  </header>

  <main class="mx-auto max-w-5xl px-4 py-8 space-y-8">
    <!-- Cloud Setup View -->
    <section id="cloudSetupView" class="card">
      <h2 class="text-xl font-semibold mb-4">เชื่อมต่อ Cloud (GitHub Gist)</h2>
      <p class="text-zinc-400 mb-4">ครั้งแรกเท่านั้น: ใส่ <b>GitHub Token</b> และ <b>Gist ID</b> หรือสร้าง Gist ใหม่ จากนั้นระบบจะเพิ่ม <b>#gist=&lt;id&gt;</b> ใน URL ให้เอง เพื่อให้รีเฟรชแล้วโหลดอัตโนมัติ (ไม่ใช้ localStorage)</p>
      <div class="grid sm:grid-cols-2 gap-4">
        <div>
          <label class="label">GitHub Token (เขียนข้อมูล)</label>
          <input id="inpToken" class="input" type="password" placeholder="ghp_xxx หรือ fine-grained token" />
        </div>
        <div>
          <label class="label">Gist ID (มีอยู่แล้ว)</label>
          <input id="inpGistId" class="input" type="text" placeholder="เช่น a1b2c3d4e5f6..." />
        </div>
      </div>
      <div class="mt-3">
        <label class="inline-flex items-center gap-2 text-sm">
          <input id="chkRememberToken" type="checkbox" class="rounded" checked>
          <span>เข้ารหัส Token ด้วยรหัสผ่าน Host และเก็บไว้ในไฟล์ Gist (เพื่อไม่ต้องกรอก Token อีก)</span>
        </label>
      </div>
      <div class="mt-4 flex flex-wrap gap-2">
        <button id="btnLoadExisting" class="btn btn-primary">Load from Existing Gist</button>
        <button id="btnCreateGist" class="btn">Create New Empty Gist</button>
      </div>
      <p class="muted mt-3">ข้อมูลจริงเก็บบน Gist 100% · หน้านี้ไม่ใช้ localStorage/sessionStorage · หลังเชื่อมแล้วระบบจะใส่ <code>#gist=...</code> ที่ URL ให้</p>
    </section>

    <!-- First-time Host Setup -->
    <section id="setupView" class="card hidden">
      <h2 class="text-xl font-semibold mb-4">ตั้งค่า Host ครั้งแรก</h2>
      <div class="grid sm:grid-cols-2 gap-4">
        <div>
          <label class="label">รหัสผ่าน Host</label>
          <input id="setupPass1" class="input" type="password" placeholder="ตั้งรหัสผ่าน" />
        </div>
        <div>
          <label class="label">ยืนยันรหัสผ่าน</label>
          <input id="setupPass2" class="input" type="password" placeholder="พิมพ์ซ้ำอีกครั้ง" />
        </div>
      </div>
      <div class="mt-4 flex gap-2">
        <button id="btnCreateHost" class="btn btn-primary">Create Host</button>
      </div>
      <p class="muted mt-3">จะสร้างผู้ใช้ <b>host</b> และ (ถ้าเลือกไว้) จะเข้ารหัส Token เก็บในไฟล์ Gist</p>
    </section>

    <!-- Login View -->
    <section id="loginView" class="card hidden">
      <h2 class="text-xl font-semibold mb-4">ลงชื่อเข้าใช้</h2>
      <div class="grid sm:grid-cols-2 gap-4">
        <div class="sm:col-span-2">
          <label class="label">รหัสผ่าน</label>
          <input id="loginPass" class="input" type="password" placeholder="กรอกรหัสผ่าน" />
        </div>
      </div>
      <div class="mt-4 flex gap-2">
        <button id="btnLogin" class="btn btn-primary">Log in</button>
      </div>
      <p id="loginHint" class="muted mt-3 hidden">พบ Token ที่เข้ารหัสใน Gist — เพียงล็อกอินก็ใช้งานได้</p>
    </section>

    <!-- App View (Demo minimal) -->
    <section id="appView" class="hidden">
      <div class="card">
        <div class="flex items-center justify-between">
          <div>
            <h2 class="text-xl font-semibold">แดชบอร์ด</h2>
            <p class="text-zinc-400">ยินดีต้อนรับ, <span id="whoami">—</span></p>
          </div>
          <div class="flex gap-2">
            <button id="btnAddDemo" class="btn">Add Demo Item</button>
            <button id="btnSaveNow" class="btn btn-primary">Save Now</button>
          </div>
        </div>
      </div>

      <div class="card">
        <h3 class="font-medium mb-3">รายการสินค้า (ตัวอย่าง)</h3>
        <div class="overflow-x-auto">
          <table class="min-w-full text-sm">
            <thead>
              <tr class="text-zinc-400">
                <th class="text-left p-2">SKU</th>
                <th class="text-left p-2">ชื่อสินค้า</th>
                <th class="text-right p-2">ราคา</th>
              </tr>
            </thead>
            <tbody id="tblProducts"></tbody>
          </table>
        </div>
      </div>
    </section>
  </main>

  <script>
  // ============================================================
  // 100% ONLINE IMPLEMENTATION (NO localStorage / sessionStorage)
  // Persist only on GitHub Gist. Keep runtime secrets in memory.
  // - First-time: user enters Token + Gist ID (or creates gist)
  //   -> app sets URL hash: #gist=<id> (bookmarkable)
  // - Refresh uses the #gist param to auto-load from cloud
  // - Token can be stored ENCRYPTED inside Gist (optional) so user
  //   only types password at login; we decrypt to write.
  // ============================================================

  // -----------------------------
  // Utilities (DOM, URL, Crypto)
  // -----------------------------
  const $ = (sel) => document.querySelector(sel);
  const show = (sel) => { const el=$(sel); if(el) el.classList.remove('hidden'); };
  const hide = (sel) => { const el=$(sel); if(el) el.classList.add('hidden'); };

  function getHashParam(name){
    // parse #key1=val1&key2=val2
    const h = location.hash.startsWith('#') ? location.hash.slice(1) : location.hash;
    const p = new URLSearchParams(h);
    return p.get(name);
  }
  function setHashParam(name, val){
    const h = location.hash.startsWith('#') ? location.hash.slice(1) : location.hash;
    const p = new URLSearchParams(h);
    if(val===null || val===undefined || val==='') p.delete(name); else p.set(name, val);
    const newHash = '#' + p.toString();
    if(newHash !== location.hash){ history.replaceState(null, '', newHash); }
  }

  async function sha256Hex(text){
    const enc = new TextEncoder().encode(text);
    const buf = await crypto.subtle.digest('SHA-256', enc);
    return [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,'0')).join('');
  }

  // AES-GCM helpers (PBKDF2 -> key -> encrypt/decrypt)
  async function deriveKey(password, saltB64, iter=120000){
    const pw = new TextEncoder().encode(password);
    const salt = Uint8Array.from(atob(saltB64), c=>c.charCodeAt(0));
    const keyMat = await crypto.subtle.importKey('raw', pw, 'PBKDF2', false, ['deriveKey']);
    return crypto.subtle.deriveKey(
      {name:'PBKDF2', hash:'SHA-256', salt, iterations: iter},
      keyMat,
      {name:'AES-GCM', length:256},
      false,
      ['encrypt','decrypt']
    );
  }
  function b64encode(u8){ return btoa(String.fromCharCode(...u8)); }
  function b64decode(str){ return Uint8Array.from(atob(str), c=>c.charCodeAt(0)); }
  async function aesEncryptToBundle(plainText, password){
    const salt = crypto.getRandomValues(new Uint8Array(16));
    const iv   = crypto.getRandomValues(new Uint8Array(12));
    const key  = await deriveKey(password, b64encode(salt));
    const ct   = await crypto.subtle.encrypt({name:'AES-GCM', iv}, key, new TextEncoder().encode(plainText));
    return { salt: b64encode(salt), iv: b64encode(iv), ct: b64encode(new Uint8Array(ct)), iter:120000 };
  }
  async function aesDecryptFromBundle(bundle, password){
    const {salt, iv, ct, iter=120000} = bundle || {};
    const key = await deriveKey(password, salt, iter);
    const ptBuf = await crypto.subtle.decrypt({name:'AES-GCM', iv: b64decode(iv)}, key, b64decode(ct));
    return new TextDecoder().decode(ptBuf);
  }

  // -----------------------------
  // State (in memory only)
  // -----------------------------
  const defaultAppState = {
    users: [],               // [{username:'host', role:'host', passHash:'...'}]
    products: [],
    templates: [],
    logo: '',
    dealerNames: [],
    logs: [],
    cloud: { encToken: null } // {salt,iv,ct,iter} if present
  };
  let appData = structuredClone(defaultAppState);
  let currentUser = null;
  let runtimeToken = null;   // PAT in memory only (cleared on refresh/signout)
  let autoSaveTimer = null;

  // -----------------------------
  // GitHub Gist I/O
  // -----------------------------
  async function gistRequest(method, path, body, token){
    const res = await fetch('https://api.github.com' + path, {
      method,
      headers: {
        'Accept': 'application/vnd.github+json',
        ...(token ? {'Authorization': `token ${token}`} : {}),
        ...(body ? {'Content-Type': 'application/json'} : {})
      },
      body: body ? JSON.stringify(body) : undefined
    });
    if(!res.ok){
      const t = await res.text();
      throw new Error(`${method} ${path} -> ${res.status}: ${t}`);
    }
    return res.json();
  }

  async function cloudCreateGist(token, initialState){
    if(!token) throw new Error('Missing GitHub Token');
    const payload = {
      description: 'Price Tag Manager Data',
      public: false, // secret gist (unlisted)
      files: { 'proplugin-data.json': { content: JSON.stringify(initialState ?? defaultAppState, null, 2) } }
    };
    const resp = await gistRequest('POST', '/gists', payload, token);
    return resp.id;
  }

  async function cloudSave(){
    const gistId = getHashParam('gist');
    if(!gistId) throw new Error('No #gist in URL');
    const token = runtimeToken;
    if(!token){
      throw new Error('No write token — โปรดล็อกอินเพื่อปลดล็อก token หรือโหลดใหม่ด้วย Token');
    }
    const payload = { files: { 'proplugin-data.json': { content: JSON.stringify(appData, null, 2) } } };
    await gistRequest('PATCH', `/gists/${gistId}`, payload, token);
  }

  async function cloudLoad(gistId, tokenForWrite){
    // Read does NOT require auth for secret/public gist
    const resp = await gistRequest('GET', `/gists/${gistId}`, null, null);
    const file = resp.files?.['proplugin-data.json'];
    if(!file) throw new Error('proplugin-data.json not found in gist');
    const data = JSON.parse(file.content);
    appData = Object.assign(structuredClone(defaultAppState), data);

    // If we have a fresh token (from setup), keep it in memory this session
    runtimeToken = tokenForWrite || runtimeToken || null;

    // Hint on login page if encrypted token exists in gist
    if(appData?.cloud?.encToken){ show('#loginHint'); } else { hide('#loginHint'); }
  }

  function scheduleAutoSave(){
    clearTimeout(autoSaveTimer);
    autoSaveTimer = setTimeout(()=>cloudSave().catch(e=>console.error('autosave failed', e)), 600);
  }

  // -----------------------------
  // Routing helpers
  // -----------------------------
  function gotoApp(){
    $('#whoami').textContent = currentUser?.username ?? '—';
    hide('#cloudSetupView'); hide('#setupView'); hide('#loginView'); show('#appView');
    $('#btnLogout').classList.remove('hidden');
    renderProducts();
  }
  function gotoLogin(){
    hide('#cloudSetupView'); hide('#setupView'); hide('#appView'); show('#loginView');
    $('#btnLogout').classList.add('hidden'); $('#loginPass').value='';
  }
  function gotoCloud(){
    hide('#loginView'); hide('#setupView'); hide('#appView'); show('#cloudSetupView');
    $('#btnLogout').classList.add('hidden');
  }
  function gotoSetup(){
    hide('#cloudSetupView'); hide('#loginView'); hide('#appView'); show('#setupView');
    $('#btnLogout').classList.add('hidden');
  }

  // -----------------------------
  // Boot — ONE-TIME load via URL #gist
  // -----------------------------
  let __BOOTED = false;
  async function ensureCloudBoot(){
    if(__BOOTED) return; __BOOTED = true;
    const gistId = getHashParam('gist');
    if(gistId){
      hide('#cloudSetupView'); // prevent flicker
      try{
        await cloudLoad(gistId, null);
        if((appData.users?.length ?? 0) === 0) gotoSetup(); else gotoLogin();
      }catch(err){
        console.error('Auto cloud load failed:', err);
        gotoCloud();
      }
      return;
    }
    // no gist param yet — first time on this device
    gotoCloud();
  }

  // -----------------------------
  // Cloud Setup UI
  // -----------------------------
  $('#btnLoadExisting').addEventListener('click', async ()=>{
    const token = $('#inpToken').value.trim();
    const gistId = $('#inpGistId').value.trim();
    if(!token || !gistId){ alert('กรุณากรอก Token และ Gist ID'); return; }
    try{
      // Load and remember in URL only
      await cloudLoad(gistId, token);
      setHashParam('gist', gistId);

      if((appData.users?.length ?? 0) === 0){
        // Prepare empty skeleton then go create host
        if($('#chkRememberToken').checked){
          // we will encrypt & store token after host password is set
        }
        // save initial file (ensures file exists)
        await cloudSave();
        gotoSetup();
      }else{
        // Existing app: if remember checked, we will encrypt token after login
        gotoLogin();
      }
    }catch(e){ alert('โหลดจาก Gist ไม่สำเร็จ: ' + e.message); }
  });

  $('#btnCreateGist').addEventListener('click', async ()=>{
    const token = $('#inpToken').value.trim();
    if(!token){ alert('กรุณากรอก GitHub Token'); return; }
    try{
      const id = await cloudCreateGist(token, defaultAppState);
      // remember only in URL
      setHashParam('gist', id);
      runtimeToken = token;
      alert('สร้าง Gist สำเร็จ: ' + id + '
(ระบบจะจำผ่าน URL #gist และใช้งานแบบออนไลน์ 100%)');
      gotoSetup();
    }catch(e){ alert('สร้าง Gist ไม่สำเร็จ: ' + e.message); }
  });

  $('#btnCloudForget').addEventListener('click', ()=>{
    if(confirm('ลืมการเชื่อมต่อคลาวด์ (ล้าง #gist จาก URL) ใช่ไหม?')){
      setHashParam('gist','');
      location.reload();
    }
  });

  // -----------------------------
  // Host Setup UI
  // -----------------------------
  $('#btnCreateHost').addEventListener('click', async ()=>{
    const p1 = $('#setupPass1').value; const p2 = $('#setupPass2').value;
    if(!p1 || p1 !== p2){ alert('รหัสผ่านไม่ตรงกัน'); return; }
    const passHash = await sha256Hex(p1);
    appData.users = [{ username:'host', role:'host', passHash }];

    // If we have a runtime token from setup and user chooses to remember, encrypt to Gist
    if(runtimeToken && $('#chkRememberToken').checked){
      try{
        appData.cloud.encToken = await aesEncryptToBundle(runtimeToken, p1);
      }catch(e){ console.warn('Encrypt token failed:', e); }
    }

    try{ await cloudSave(); }catch(e){ alert('บันทึกขึ้นคลาวด์ไม่สำเร็จ: '+e.message); return; }
    gotoLogin();
  });

  // -----------------------------
  // Login / Logout
  // -----------------------------
  $('#btnLogin').addEventListener('click', async ()=>{
    const pass = $('#loginPass').value;
    const hash = await sha256Hex(pass);
    const host = appData.users?.find(u=>u.username==='host');
    if(host && host.passHash === hash){
      currentUser = host;
      // If token not in memory but encrypted token exists, decrypt using password
      if(!runtimeToken && appData?.cloud?.encToken){
        try{ runtimeToken = await aesDecryptFromBundle(appData.cloud.encToken, pass); }
        catch(e){ alert('ถอดรหัส Token ไม่ได้ — โปรดโหลดใหม่ด้วย Token สักครั้ง'); }
      }
      gotoApp();
      return;
    }
    alert('รหัสผ่านไม่ถูกต้อง');
  });

  $('#btnLogout').addEventListener('click', ()=>{
    currentUser = null;
    runtimeToken = null; // forget token in memory on logout
    gotoLogin();
  });

  // -----------------------------
  // Demo products
  // -----------------------------
  function renderProducts(){
    const tbody = $('#tblProducts');
    tbody.innerHTML = '';
    for(const p of appData.products){
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="p-2">${p.sku}</td>
        <td class="p-2">${p.name}</td>
        <td class="p-2 text-right">${Number(p.price||0).toLocaleString()}</td>
      `;
      tbody.appendChild(tr);
    }
  }

  $('#btnAddDemo').addEventListener('click', ()=>{
    const n = (appData.products?.length || 0) + 1;
    appData.products.push({ sku: 'SKU' + String(n).padStart(4,'0'), name: 'Demo Item ' + n, price: 100*n });
    renderProducts();
    scheduleAutoSave();
  });

  $('#btnSaveNow').addEventListener('click', async ()=>{
    try{ await cloudSave(); alert('บันทึกขึ้นคลาวด์แล้ว'); }
    catch(e){ alert('บันทึกไม่สำเร็จ: ' + e.message); }
  });

  // -----------------------------
  // Boot
  // -----------------------------
  function boot(){ ensureCloudBoot().catch(e=>console.error(e)); }
  if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', boot, {once:true});
  else boot();
  window.addEventListener('pageshow', ()=>ensureCloudBoot(), {passive:true});

  </script>
</body>
</html>
