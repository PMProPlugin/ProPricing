<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ProPlugin • Price Tag Manager</title>

<!-- Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;600;700;800;900&family=Prompt:wght@400;600;700&display=swap" rel="stylesheet">

<!-- Tailwind -->
<script src="https://cdn.tailwindcss.com"></script>
<script>
  tailwind.config = {
    darkMode: 'class',
    theme: {
      extend: {
        fontFamily: { sans: ['Kanit','Prompt','system-ui','sans-serif'] },
        colors: { brand: { dark:'#0b0b0c', red:'#E11D2E' } },
        boxShadow: { soft: '0 6px 18px rgba(0,0,0,.25)' }
      }
    }
  }
</script>

<!-- SheetJS + XlsxPopulate -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx-populate/browser/xlsx-populate.min.js"></script>

<style>
  :root { color-scheme: dark; }
  html,body{ height:100%; background:#0b0b0c }
  ::-webkit-scrollbar{width:10px;height:10px}::-webkit-scrollbar-thumb{background:#222;border-radius:10px}
  .oneline{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis }
  .text-elevate{ text-shadow:0 1px 2px rgba(0,0,0,.9),0 0 1px rgba(0,0,0,.7) }
  @media print { .no-print{display:none!important} .print-only{display:block} }
</style>
</head>

<body class="text-white font-sans">

<!-- ===================== LOGIN ===================== -->
<section id="loginView" class="min-h-screen grid place-items-center">
  <div class="w-full max-w-md bg-zinc-900/80 border border-zinc-800 rounded-2xl p-8 shadow-soft">
    <div class="flex items-center gap-3 mb-6">
      <div class="w-11 h-11 rounded-xl bg-brand.red grid place-items-center text-xl font-extrabold">P</div>
      <div class="text-2xl font-semibold">ProPlugin • Price Tag Manager</div>
    </div>
    <label class="text-sm text-zinc-400">Username</label>
    <input id="loginUser" class="w-full mt-1 px-4 py-3 rounded-2xl bg-zinc-900 border border-zinc-700 focus:outline-none focus:ring-2 focus:ring-brand.red" placeholder="username" />
    <label class="text-sm text-zinc-400 mt-4 block">Password</label>
    <input id="loginPass" type="password" class="w-full mt-1 px-4 py-3 rounded-2xl bg-zinc-900 border border-zinc-700 focus:outline-none focus:ring-2 focus:ring-brand.red" placeholder="password" />
    <button id="btnLogin" class="mt-6 w-full py-3 rounded-2xl bg-brand.red hover:bg-red-600 border border-red-700 font-semibold">Sign in</button>
  </div>
</section>

<!-- ===================== APP ===================== -->
<section id="appView" class="hidden min-h-screen">
  <!-- Topbar -->
  <header class="sticky top-0 z-40 bg-brand.dark/95 backdrop-blur border-b border-zinc-800">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center gap-3">
      <div class="flex items-center gap-3">
        <div id="logoBox" class="w-10 h-10 rounded-xl bg-zinc-100 text-brand.dark font-black grid place-items-center overflow-hidden select-none">
          <span id="logoFallback">P</span>
          <img id="logoImg" class="hidden w-full h-full object-contain" alt="logo">
        </div>
        <div class="text-xl sm:text-2xl font-semibold tracking-wide">Price Tags</div>
        <span id="roleBadge" class="ml-2 text-xs px-2 py-1 rounded bg-zinc-800 border border-zinc-700"></span>
      </div>
      <div class="ml-auto flex items-center gap-2">
        <button id="btnSettings" class="hidden px-3 py-2 rounded-2xl bg-zinc-900 hover:bg-zinc-800 border border-zinc-700 text-sm">Settings</button>
        <button id="btnHistory" class="px-3 py-2 rounded-2xl bg-zinc-900 hover:bg-zinc-800 border border-zinc-700 text-sm hidden">History</button>
        <button id="btnLogout" class="px-3 py-2 rounded-2xl bg-zinc-900 hover:bg-zinc-800 border border-zinc-700 text-sm">Sign out</button>
      </div>
    </div>

    <!-- Filters -->
    <div class="max-w-7xl mx-auto px-4 pb-4 flex flex-col gap-3">
      <div class="flex flex-col lg:flex-row gap-3">
        <div class="relative flex-1">
          <input id="searchInput" class="w-full text-xl sm:text-2xl px-5 py-4 rounded-2xl border border-zinc-700 bg-zinc-950 focus:outline-none focus:ring-2 focus:ring-brand.red" placeholder="Search (SKU / Product Name)" />
          <div class="absolute right-4 top-1/2 -translate-y-1/2 text-zinc-500">⌘K</div>
        </div>
        <select id="channelSelect" class="px-4 py-3 rounded-2xl bg-zinc-950 border border-zinc-700">
          <option>Flagship</option><option>Marketplace</option><option>Dealer</option>
        </select>
        <div class="px-3 py-2 rounded-2xl bg-zinc-950 border border-zinc-700 flex items-center gap-2">
          <span class="text-sm text-zinc-400">Date range</span>
          <input id="dateStart" type="date" class="px-3 py-2 rounded-xl bg-zinc-900 border border-zinc-700">
          <span class="text-zinc-500">→</span>
          <input id="dateEnd" type="date" class="px-3 py-2 rounded-xl bg-zinc-900 border border-zinc-700">
        </div>
        <button id="btnPrintModal" class="px-5 py-3 rounded-2xl bg-brand.red hover:bg-red-600 border border-red-700 font-semibold">Print</button>
      </div>
    </div>
  </header>

  <!-- Table -->
  <main class="max-w-7xl mx-auto px-4 py-6">
    <div class="overflow-auto border border-zinc-800 rounded-2xl">
      <table class="min-w-[1200px] w-full text-sm">
        <thead class="bg-zinc-900/70 border-b border-zinc-800">
          <tr class="[&>th]:px-3 [&>th]:py-3 text-left">
            <th>SKU</th>
            <th class="w-64">Description</th>
            <th class="w-64">Details</th>
            <th id="thCosts" class="hidden">Costs</th>

            <!-- Flagship -->
            <th class="col-normal">Normal</th>
            <th class="col-promo">Promotion</th>
            <th class="col-expire">Expires (Flagship)</th>

            <!-- Marketplace -->
            <th class="col-market">Marketplace</th>
            <th class="col-marketgp">Market GP%</th>

            <!-- Dealer -->
            <th class="col-t1"><span id="lblT1">Dealer T1</span></th>
            <th class="col-gp1">GP% T1</th>
            <th class="col-t2"><span id="lblT2">Dealer T2</span></th>
            <th class="col-gp2">GP% T2</th>
            <th class="col-t3"><span id="lblT3">Dealer T3</span></th>
            <th class="col-gp3">GP% T3</th>

            <th class="w-32">Actions</th>
          </tr>
        </thead>
        <tbody id="productBody" class="[&>tr:nth-child(odd)]:bg-zinc-900/40"></tbody>
      </table>
    </div>
  </main>
</section>

<!-- ===================== SETTINGS (with Cloud Sync) ===================== -->
<div id="settingsPanel" class="hidden fixed inset-0 z-[60] bg-black/60 backdrop-blur-sm">
  <div class="absolute inset-4 bg-zinc-950/95 border border-zinc-800 rounded-2xl overflow-hidden grid grid-cols-[260px_1fr]">
    <aside class="bg-zinc-900/60 border-r border-zinc-800 p-3 space-y-2">
      <div class="text-sm text-zinc-400 px-2">Settings</div>
      <button data-tab="data" class="set-tab only-host-admin w-full text-left px-3 py-2 rounded-2xl bg-zinc-900 hover:bg-zinc-800 border border-zinc-700">Manage Data</button>
      <button data-tab="logo" class="set-tab only-host w-full text-left px-3 py-2 rounded-2xl bg-zinc-900 hover:bg-zinc-800 border border-zinc-700">Manage Logo</button>
      <button data-tab="dealer" class="set-tab only-host-admin w-full text-left px-3 py-2 rounded-2xl bg-zinc-900 hover:bg-zinc-800 border border-zinc-700">Dealer Settings</button>
      <button data-tab="users" class="set-tab only-host-admin w-full text-left px-3 py-2 rounded-2xl bg-zinc-900 hover:bg-zinc-800 border border-zinc-700">User Management</button>
      <button data-tab="templates" class="set-tab only-host w-full text-left px-3 py-2 rounded-2xl bg-zinc-900 hover:bg-zinc-800 border border-zinc-700">Template Management</button>
      <button data-tab="cloud" class="set-tab only-host w-full text-left px-3 py-2 rounded-2xl bg-zinc-900 hover:bg-zinc-800 border border-zinc-700">Cloud Sync</button>
      <button data-tab="history" class="set-tab only-host w-full text-left px-3 py-2 rounded-2xl bg-zinc-900 hover:bg-zinc-800 border border-zinc-700">Usage History</button>
      <div class="absolute bottom-3 left-3 right-3">
        <button id="btnCloseSettings" class="w-full text-sm px-2 py-1.5 rounded-xl bg-brand.red hover:bg-red-600 border border-red-700">Close</button>
      </div>
    </aside>
    <section id="settingsContent" class="p-6 overflow-auto"></section>
  </div>
</div>

<!-- ===================== EDITOR ===================== -->
<div id="editorModal" class="hidden fixed inset-0 z-[70] bg-black/70">
  <div class="absolute inset-6 bg-zinc-950 border border-zinc-800 rounded-2xl overflow-hidden">
    <div class="flex items-center justify-between p-4 border-b border-zinc-800">
      <div class="text-xl font-semibold">Edit Product</div>
      <button onclick="closeEditor()" class="px-3 py-1 rounded-2xl bg-zinc-900 hover:bg-zinc-800 border border-zinc-700">Close</button>
    </div>
    <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-6 overflow-auto h-[calc(100%-100px)]">
      <div class="space-y-4">
        <div><label class="text-sm text-zinc-400">SKU</label><input id="edSku" class="w-full mt-1 px-3 py-2 rounded-2xl bg-zinc-900 border border-zinc-700"></div>
        <div><label class="text-sm text-zinc-400">Description</label><input id="edDesc" class="w-full mt-1 px-3 py-2 rounded-2xl bg-zinc-900 border border-zinc-700"></div>
        <div><label class="text-sm text-zinc-400">Details</label><textarea id="edDetails" rows="6" class="w-full mt-1 px-3 py-2 rounded-2xl bg-zinc-900 border border-zinc-700"></textarea></div>
        <div><label class="text-sm text-zinc-400">Expires Date</label><input id="edExpire" type="date" class="w-full mt-1 px-3 py-2 rounded-2xl bg-zinc-900 border border-zinc-700"></div>
      </div>
      <div class="space-y-4">
        <div class="grid grid-cols-2 gap-4">
          <div><label class="text-sm text-zinc-400">Costs</label><input id="edCosts" type="number" step="0.01" class="w-full mt-1 px-3 py-2 rounded-2xl bg-zinc-900 border border-zinc-700"></div>
          <div><label class="text-sm text-zinc-400">Normal Price</label><input id="edNormal" type="number" step="0.01" class="w-full mt-1 px-3 py-2 rounded-2xl bg-zinc-900 border border-zinc-700"></div>
          <div><label class="text-sm text-zinc-400">Promotion Price</label><input id="edPromo" type="number" step="0.01" class="w-full mt-1 px-3 py-2 rounded-2xl bg-zinc-900 border border-zinc-700"></div>
          <div><label class="text-sm text-zinc-400">Marketplace Price</label><input id="edMarket" type="number" step="0.01" class="w-full mt-1 px-3 py-2 rounded-2xl bg-zinc-900 border border-zinc-700"></div>
          <div><label class="text-sm text-zinc-400"><span id="edLabelT1">Dealer T1</span></label><input id="edT1" type="number" step="0.01" class="w-full mt-1 px-3 py-2 rounded-2xl bg-zinc-900 border border-zinc-700"></div>
          <div><label class="text-sm text-zinc-400"><span id="edLabelT2">Dealer T2</span></label><input id="edT2" type="number" step="0.01" class="w-full mt-1 px-3 py-2 rounded-2xl bg-zinc-900 border border-zinc-700"></div>
          <div><label class="text-sm text-zinc-400"><span id="edLabelT3">Dealer T3</span></label><input id="edT3" type="number" step="0.01" class="w-full mt-1 px-3 py-2 rounded-2xl bg-zinc-900 border border-zinc-700"></div>
        </div>
        <button id="btnSaveEd" class="w-full mt-2 py-3 rounded-2xl bg-brand.red hover:bg-red-600 border border-red-700 font-semibold">Save</button>
      </div>
    </div>
  </div>
</div>

<!-- ===================== PRINT MODAL (Horizontal, full preview) ===================== -->
<div id="printModal" class="hidden fixed inset-0 z-[80] bg-black/70">
  <!-- OUTER GRID: header + content rows; two columns always -->
  <div class="absolute inset-6 bg-zinc-950 border border-zinc-800 rounded-2xl grid grid-rows-[auto_1fr] grid-cols-[480px_1fr] min-h-0">
    <!-- Header spans two columns -->
    <div class="col-span-2 sticky top-0 z-10 bg-zinc-950 border-b border-zinc-800 p-4 flex items-center justify-between">
      <div class="text-xl font-semibold">Print Price Tags</div>
      <button onclick="togglePrintModal(false)" class="px-3 py-1.5 rounded-2xl bg-zinc-900 hover:bg-zinc-800 border border-zinc-700">Close</button>
    </div>

    <!-- Left column: list -->
    <div class="p-4 border-r border-zinc-800 space-y-4 overflow-auto">
      <div class="sticky top-0 bg-zinc-950 border-b border-zinc-800 pb-3 z-10">
        <div class="grid grid-cols-[1fr_auto] gap-2">
          <select id="printTemplate" class="w-full px-3 py-2 rounded-2xl bg-zinc-900 border border-zinc-700"></select>
          <button id="btnOpenPrint" class="px-4 py-2 rounded-2xl bg-brand.red hover:bg-red-600 border border-red-700 font-semibold">Open Print Page</button>
        </div>
        <div class="mt-3 px-3 py-2 rounded-2xl bg-zinc-900 border border-zinc-800 flex items-center gap-2">
          <input id="printSearch" class="flex-1 bg-transparent outline-none" placeholder="Search in list…">
          <label class="text-sm"><input type="checkbox" id="printCheckAll"> <span class="text-zinc-300">Select all</span></label>
        </div>
        <div class="text-sm text-zinc-400 mt-2">Select products and set qty per SKU</div>
      </div>
      <div id="printList" class="space-y-2 pt-2"></div>
      <div id="printSummary" class="text-sm text-zinc-400"></div>
    </div>

    <!-- Right column: live preview fills available space -->
    <div class="flex flex-col w-full h-full min-h-0 min-w-0 p-4 overflow-hidden">
      <div class="text-sm text-zinc-400 mb-2 shrink-0">Live preview of the first selected item</div>
      <div id="previewBox" class="bg-zinc-900 rounded-2xl border border-zinc-800 flex-1 w-full h-full min-h-0 min-w-0 relative flex items-center justify-center overflow-hidden"></div>
    </div>
  </div>
</div>

<script>
/* ================= CORE STATE / STORAGE ================= */
const LS = {
  PRODUCTS: 'pp_products_en_v5',
  USERS: 'pp_users_en_v5',
  LOGO: 'pp_logo_base64_v3',
  TEMPLATES: 'pp_templates_en_v4',
  LOGS: 'pp_logs_en_v5',
  LASTUSER: 'pp_last_user_en',
  USERS_COST_FLAG: 'pp_flag_users_costs_en',
  DEALER_NAMES: 'pp_dealer_names_en',
  CLOUD: 'pp_cloud_cfg_v1' // { gistId, token, autoSync }
};
const defaultDealerNames = {t1:'Dealer T1', t2:'Dealer T2', t3:'Dealer T3'};
const Channels = ['Flagship','Marketplace','Dealer'];

const defaultUsers = [
  {username:'host',  password:'1234', role:'Host',  channels:[...Channels], canSeeCosts:true,  canPrint:true},
  {username:'admin', password:'1234', role:'Admin', channels:[...Channels], canSeeCosts:true,  canPrint:true},
  {username:'user1', password:'1234', role:'User',  channels:['Flagship'], canSeeCosts:false, canPrint:true},
  {username:'user2', password:'1234', role:'User',  channels:['Flagship'], canSeeCosts:false, canPrint:true},
  {username:'user3', password:'1234', role:'User',  channels:['Marketplace'], canSeeCosts:false, canPrint:false},
  {username:'user4', password:'1234', role:'User',  channels:['Dealer'], canSeeCosts:false, canPrint:false}
];

const sampleProducts = [{
  sku:'MP-00010',
  description:'iCon Pro Audio GoLive Pro',
  details:'Audio interface for live streaming with remote control\n24-bit/48kHz with onboard DSP (Reverb, EQ, Vocal Tune)\nBuilt-in 5000mAh battery up to 6 hours\nMic input mini-XLR (48V) & 1/4-inch\nBluetooth for music & control',
  costs:4200, normalPrice:7990, promoPrice:5990, expiresDate:'2099-09-09',
  marketplacePrice:5990, dealer1:5600, dealer2:5400, dealer3:5200
}];

/* default templates */
function defaultTemplates(){
  return [
    { id:'t-a4',  name:'A4 (1 per sheet)', kind:'A4',  showLogo:true,
      styles:{ sku:{fs:16,color:'#ffffff',mt:0}, description:{fs:30,color:'#ffffff',mt:0},
        details:{fs:14,color:'#ffffff',mt:0}, price:{fs:72,color:'#ffffff',mt:0},
        oldPrice:{fs:20,color:'#ff4d4f',mt:0}, expire:{fs:13,color:'#ffffff',mt:0} } },
    { id:'t-a5',  name:'A5 (2 per A4 landscape)', kind:'A5',  showLogo:true,
      styles:{ sku:{fs:14,color:'#ffffff',mt:0}, description:{fs:26,color:'#ffffff',mt:0},
        details:{fs:13,color:'#ffffff',mt:0}, price:{fs:60,color:'#ffffff',mt:0},
        oldPrice:{fs:18,color:'#ff4d4f',mt:0}, expire:{fs:12,color:'#ffffff',mt:0} } },
    { id:'t-a6',  name:'A6 (4 per sheet)', kind:'A6',  showLogo:true,
      styles:{ sku:{fs:12,color:'#ffffff',mt:0}, description:{fs:22,color:'#ffffff',mt:0},
        details:{fs:12,color:'#ffffff',mt:0}, price:{fs:48,color:'#ffffff',mt:0},
        oldPrice:{fs:16,color:'#ff4d4f',mt:0}, expire:{fs:11,color:'#ffffff',mt:0} } },
    { id:'t-acc', name:'Accessories (12 per sheet)', kind:'ACC', showLogo:true,
      styles:{ sku:{fs:11,color:'#ffffff',mt:2}, description:{fs:15,color:'#ffffff',mt:0, align:'center'},
        price:{fs:22,color:'#ffffff',mt:0}, oldPrice:{fs:12,color:'#B91C1C',mt:0}, expire:{fs:10,color:'#ffffff',mt:0} } }
  ];
}

/* ================= UTILITIES ================= */
const $  = (s,r=document)=>r.querySelector(s);
const $$ = (s,r=document)=>Array.from(r.querySelectorAll(s));
const money = n => isFinite(n) ? n.toLocaleString('th-TH',{maximumFractionDigits:0}) : '-';
const toDateInput = v => v ? new Date(v).toISOString().slice(0,10) : '';
const fromExcelDate = v => {
  if (v instanceof Date) return v.toISOString().slice(0,10);
  if (typeof v==='number'){ const d=new Date(Math.round((v-25569)*86400*1000)); return d.toISOString().slice(0,10); }
  if (typeof v==='string' && /^\d{4}-\d{2}-\d{2}$/.test(v)) return v;
  return '';
};
const gpPct = (price,cost)=> (cost>0 ? ((price - (cost||0))/cost)*100 : 0); // (Price - Cost)/Cost*100
const log = (action,meta='')=>{
  const logs = JSON.parse(localStorage.getItem(LS.LOGS)||'[]');
  logs.unshift({ts:new Date().toISOString(), user:currentUser?.username||'-', action, meta});
  localStorage.setItem(LS.LOGS, JSON.stringify(logs.slice(0,3000)));
};
const ellip = (s,max=40)=> !s ? '' : (s.length<=max? s : s.slice(0,max-3)+'...');

/* ================= APP STATE ================= */
let currentUser=null, products=[], templates=[], editingIndex=-1, dealerNames=defaultDealerNames;

function loadState(){
  if(!localStorage.getItem(LS.USERS)) localStorage.setItem(LS.USERS, JSON.stringify(defaultUsers));
  products = JSON.parse(localStorage.getItem(LS.PRODUCTS)||'null') || sampleProducts;
  localStorage.setItem(LS.PRODUCTS, JSON.stringify(products));
  templates = JSON.parse(localStorage.getItem(LS.TEMPLATES)||'null') || defaultTemplates();
  localStorage.setItem(LS.TEMPLATES, JSON.stringify(templates));
  dealerNames = JSON.parse(localStorage.getItem(LS.DEALER_NAMES)||'null') || defaultDealerNames;
  localStorage.setItem(LS.DEALER_NAMES, JSON.stringify(dealerNames));
  const base64 = localStorage.getItem(LS.LOGO);
  if(base64){ $('#logoImg').src=base64; $('#logoImg').classList.remove('hidden'); $('#logoFallback').classList.add('hidden'); }
}
function getAppState(){
  return {
    version: 1,
    products, templates, dealerNames,
    users: JSON.parse(localStorage.getItem(LS.USERS)||'[]'),
    logo: localStorage.getItem(LS.LOGO)||'',
    logs: JSON.parse(localStorage.getItem(LS.LOGS)||'[]')
  };
}
function setAppState(data){
  if(data.products){ products = data.products; localStorage.setItem(LS.PRODUCTS, JSON.stringify(products)); }
  if(data.templates){ templates = data.templates; localStorage.setItem(LS.TEMPLATES, JSON.stringify(templates)); }
  if(data.dealerNames){ dealerNames = data.dealerNames; localStorage.setItem(LS.DEALER_NAMES, JSON.stringify(dealerNames)); }
  if(data.users){ localStorage.setItem(LS.USERS, JSON.stringify(data.users)); }
  if('logo' in data){ if(data.logo){ localStorage.setItem(LS.LOGO, data.logo); $('#logoImg').src=data.logo; $('#logoImg').classList.remove('hidden'); $('#logoFallback').classList.add('hidden'); } else { localStorage.removeItem(LS.LOGO); $('#logoImg').classList.add('hidden'); $('#logoFallback').classList.remove('hidden'); } }
  if(data.logs){ localStorage.setItem(LS.LOGS, JSON.stringify(data.logs)); }
  applyDealerNamesToUI(); renderTable();
}

/* ================= CLOUD SYNC (GitHub Gist) ================= */
function cloudCfg(){ return JSON.parse(localStorage.getItem(LS.CLOUD)||'{}'); }
function saveCloudCfg(cfg){ localStorage.setItem(LS.CLOUD, JSON.stringify(cfg)); }
async function gistRequest(method, path, body, token){
  const headers = { 'Accept':'application/vnd.github+json' };
  if(token) headers['Authorization'] = 'Bearer '+token;
  if(body) headers['Content-Type']='application/json';
  const res = await fetch('https://api.github.com'+path, { method, headers, body: body?JSON.stringify(body):undefined });
  if(!res.ok){ const t=await res.text(); throw new Error(`GitHub ${res.status}: ${t}`); }
  return res.json();
}
async function cloudCreateGist(){
  const cfg = cloudCfg(); if(!cfg.token) throw new Error('Token is required');
  const data = getAppState();
  const resp = await gistRequest('POST','/gists',{ public:false, files:{ 'proplugin-data.json':{ content: JSON.stringify(data,null,2) } } }, cfg.token);
  cfg.gistId = resp.id; cfg.autoSync = !!cfg.autoSync;
  saveCloudCfg(cfg); log('cloud_create_gist', cfg.gistId);
  alert('Gist created: '+cfg.gistId);
}
async function cloudSave(){
  const cfg = cloudCfg(); if(!cfg.gistId) throw new Error('Gist ID is required');
  const data = getAppState();
  const body = { files:{ 'proplugin-data.json':{ content: JSON.stringify(data,null,2) } } };
  await gistRequest('PATCH','/gists/'+cfg.gistId, body, cfg.token);
  log('cloud_save', cfg.gistId);
}
async function cloudLoad(){
  const cfg = cloudCfg(); if(!cfg.gistId) throw new Error('Gist ID is required');
  const resp = await gistRequest('GET','/gists/'+cfg.gistId, null, cfg.token);
  const file = resp.files?.['proplugin-data.json'];
  if(!file) throw new Error('proplugin-data.json not found in gist');
  const text = await fetch(file.raw_url).then(r=>r.text());
  const data = JSON.parse(text);
  setAppState(data); log('cloud_load', cfg.gistId);
  alert('Loaded from cloud.');
}
let autoSyncTimer=null;
function autoSyncSchedule(){
  const cfg = cloudCfg();
  if(!cfg || !cfg.autoSync || !cfg.gistId || !cfg.token) return; // ต้องมีครบถึงจะเขียนขึ้น Cloud ได้
  clearTimeout(autoSyncTimer);
  autoSyncTimer = setTimeout(()=>cloudSave().catch(e=>console.error('Auto-sync failed:', e)), 800);
}

/* ================= AUTH ================= */
function allUsers(){ return JSON.parse(localStorage.getItem(LS.USERS)); }
function setUsers(u){ localStorage.setItem(LS.USERS, JSON.stringify(u)); autoSyncSchedule(); }

function login(){
  const u=$('#loginUser').value.trim(); const p=$('#loginPass').value;
  const found = allUsers().find(x=>x.username===u && x.password===p);
  if(!found) return alert('Invalid credentials');
  currentUser=found; localStorage.setItem(LS.LASTUSER,u);
  $('#loginView').classList.add('hidden'); $('#appView').classList.remove('hidden');
  $('#roleBadge').textContent=`${currentUser.role} • ${currentUser.username}`;

  const isHost = currentUser.role==='Host';
  const isAdmin = currentUser.role==='Admin';
  $('#btnSettings').classList.toggle('hidden', !(isHost||isAdmin));
  $('#btnHistory').classList.toggle('hidden', !isHost);

  loadState();
  initFiltersForUser();
  applyDealerNamesToUI();
  renderTable();

  // Auto cloud-load (ถ้ามี Gist ID และเปิด Auto-Sync)
  try{
    const cfg=cloudCfg();
    if(cfg.gistId && cfg.autoSync){
      cloudLoad().catch(()=>{ /* ignore */ });
    }
  }catch{}
  log('login');
}
function logout(){ currentUser=null; $('#loginPass').value=''; $('#appView').classList.add('hidden'); $('#loginView').classList.remove('hidden'); }
document.addEventListener('keydown',(e)=>{ if(!$('#loginView').classList.contains('hidden') && (e.key==='Enter')) login(); });

/* ================= FILTERS & COLUMN VISIBILITY ================= */
function initFiltersForUser(){
  const sel=$('#channelSelect'); sel.innerHTML='';
  currentUser.channels.forEach(ch=>{ const o=document.createElement('option'); o.textContent=ch; sel.appendChild(o); });
  sel.value=currentUser.channels[0]; sel.disabled = currentUser.role==='User';

  $('#btnPrintModal').classList.toggle('hidden', !currentUser.canPrint);
  $('#thCosts').classList.toggle('hidden', !(currentUser.canSeeCosts || ['Host','Admin'].includes(currentUser.role)));
  updateColumnVisibility();
}
function updateColumnVisibility(){
  const ch=$('#channelSelect').value;
  const show={normal:false,promo:false,expire:false,market:false,marketgp:false,t1:false,gp1:false,t2:false,gp2:false,t3:false,gp3:false};
  if(ch==='Flagship'){ show.normal=show.promo=show.expire=true; }
  if(ch==='Marketplace'){ show.market=show.marketgp=true; }
  if(ch==='Dealer'){ show.t1=show.gp1=show.t2=show.gp2=show.t3=show.gp3=true; }
  const map={ 'col-normal':show.normal,'col-promo':show.promo,'col-expire':show.expire,'col-market':show.market,'col-marketgp':show.marketgp,'col-t1':show.t1,'col-gp1':show.gp1,'col-t2':show.t2,'col-gp2':show.gp2,'col-t3':show.t3,'col-gp3':show.gp3 };
  Object.entries(map).forEach(([cls,v])=> $$('.'+cls).forEach(el=>el.classList.toggle('hidden',!v)));
}

/* ================= APPLY DEALER NAMES ================= */
function applyDealerNamesToUI(){
  $('#lblT1').textContent = dealerNames.t1 || 'Dealer T1';
  $('#lblT2').textContent = dealerNames.t2 || 'Dealer T2';
  $('#lblT3').textContent = dealerNames.t3 || 'Dealer T3';
  $('#edLabelT1').textContent = dealerNames.t1 || 'Dealer T1';
  $('#edLabelT2').textContent = dealerNames.t2 || 'Dealer T2';
  $('#edLabelT3').textContent = dealerNames.t3 || 'Dealer T3';
}

/* ================= TABLE ================= */
function filteredProducts(){
  const q=$('#searchInput').value.trim().toLowerCase();
  const ds=$('#dateStart').value, de=$('#dateEnd').value;
  const isFlagship = $('#channelSelect').value==='Flagship';
  return products.filter(p=>{
    const hit = !q || p.sku.toLowerCase().includes(q) || p.description.toLowerCase().includes(q);
    let dateOk = true;
    if(isFlagship && (ds||de)){
      const ex = p.expiresDate ? new Date(p.expiresDate) : null;
      if(!ex) dateOk=false;
      if(ds && ex < new Date(ds)) dateOk=false;
      if(de && ex > new Date(de+'T23:59:59')) dateOk=false;
    }
    return hit && dateOk;
  });
}
function renderTable(){
  const body=$('#productBody'); body.innerHTML='';
  const showCosts = (currentUser.canSeeCosts || ['Host','Admin'].includes(currentUser.role));
  const canEdit = ['Host','Admin'].includes(currentUser.role);

  filteredProducts().forEach(p=>{
    const tr=document.createElement('tr');
    tr.className='border-b border-zinc-800 hover:bg-zinc-800/30';

    const gpM = gpPct(p.marketplacePrice, p.costs);
    const gp1 = gpPct(p.dealer1, p.costs);
    const gp2 = gpPct(p.dealer2, p.costs);
    const gp3 = gpPct(p.dealer3, p.costs);

    const detailsOneLine=(p.details||'').replace(/\n+/g,' • ');

    tr.innerHTML = `
      <td class="px-3 py-3 oneline" title="${p.sku}">${p.sku}</td>
      <td class="px-3 py-3 oneline" title="${p.description}"><div class="oneline" style="max-width:16rem">${p.description}</div></td>
      <td class="px-3 py-3 oneline" title="${detailsOneLine}"><div class="oneline" style="max-width:18rem">${detailsOneLine}</div></td>

      <td class="px-3 py-3 ${showCosts?'':'hidden'} oneline" title="${p.costs?money(p.costs):'-'}">${p.costs?money(p.costs):'-'}</td>

      <td class="px-3 py-3 col-normal oneline" title="${p.normalPrice?money(p.normalPrice):'-'}">${p.normalPrice?money(p.normalPrice):'-'}</td>
      <td class="px-3 py-3 col-promo oneline"  title="${p.promoPrice?money(p.promoPrice):'-'}">${p.promoPrice?money(p.promoPrice):'-'}</td>
      <td class="px-3 py-3 col-expire oneline" title="${p.expiresDate?toDateInput(p.expiresDate):'-'}">${p.expiresDate?toDateInput(p.expiresDate):'-'}</td>

      <td class="px-3 py-3 col-market oneline"   title="${p.marketplacePrice?money(p.marketplacePrice):'-'}">${p.marketplacePrice?money(p.marketplacePrice):'-'}</td>
      <td class="px-3 py-3 col-marketgp oneline" title="${gpM.toFixed(1)}%">${gpM.toFixed(1)}%</td>

      <td class="px-3 py-3 col-t1 oneline"  title="${p.dealer1?money(p.dealer1):'-'}">${p.dealer1?money(p.dealer1):'-'}</td>
      <td class="px-3 py-3 col-gp1 oneline" title="${gp1.toFixed(1)}%">${gp1.toFixed(1)}%</td>
      <td class="px-3 py-3 col-t2 oneline"  title="${p.dealer2?money(p.dealer2):'-'}">${p.dealer2?money(p.dealer2):'-'}</td>
      <td class="px-3 py-3 col-gp2 oneline" title="${gp2.toFixed(1)}%">${gp2.toFixed(1)}%</td>
      <td class="px-3 py-3 col-t3 oneline"  title="${p.dealer3?money(p.dealer3):'-'}">${p.dealer3?money(p.dealer3):'-'}</td>
      <td class="px-3 py-3 col-gp3 oneline" title="${gp3.toFixed(1)}%">${gp3.toFixed(1)}%</td>

      <td class="px-3 py-3">
        ${canEdit? `
          <div class="flex items-center gap-2">
            <button class="px-2 py-1 rounded-xl bg-zinc-900 hover:bg-zinc-800 border border-zinc-700 text-xs" data-edit="${p.sku}">Edit</button>
            <button title="Delete" class="px-2 py-1 rounded-xl bg-transparent border border-red-700 hover:bg-red-700/20 text-xs" data-del="${p.sku}">❌</button>
          </div>` : '-'}
      </td>
    `;
    body.appendChild(tr);
  });

  $$('button[data-edit]').forEach(b=>b.onclick=()=>openEditor(b.getAttribute('data-edit')));
  $$('button[data-del]').forEach(b=>b.onclick=()=>{
    const sku=b.getAttribute('data-del');
    if(confirm(`Delete SKU ${sku}? This cannot be undone.`)){
      products = products.filter(x=>x.sku!==sku);
      localStorage.setItem(LS.PRODUCTS, JSON.stringify(products));
      autoSyncSchedule();
      log('delete_sku', sku);
      renderTable(); updateColumnVisibility();
    }
  });

  updateColumnVisibility();
}

/* ================= EDITOR ================= */
function openEditor(sku){
  if(!['Host','Admin'].includes(currentUser.role)) return;
  editingIndex = products.findIndex(x=>x.sku===sku);
  const p=products[editingIndex];
  $('#edSku').value=p.sku; $('#edDesc').value=p.description; $('#edDetails').value=p.details||'';
  $('#edExpire').value=toDateInput(p.expiresDate);
  $('#edCosts').value=p.costs||''; $('#edNormal').value=p.normalPrice||''; $('#edPromo').value=p.promoPrice||'';
  $('#edMarket').value=p.marketplacePrice||''; $('#edT1').value=p.dealer1||''; $('#edT2').value=p.dealer2||''; $('#edT3').value=p.dealer3||'';
  applyDealerNamesToUI();
  $('#editorModal').classList.remove('hidden');
}
function closeEditor(){ $('#editorModal').classList.add('hidden'); }
$('#btnSaveEd').addEventListener('click', ()=>{
  if(editingIndex<0) return;
  const p=products[editingIndex];
  Object.assign(p,{
    sku:$('#edSku').value.trim(), description:$('#edDesc').value.trim(), details:$('#edDetails').value.trim(),
    expiresDate:$('#edExpire').value||'', costs:parseFloat($('#edCosts').value)||0,
    normalPrice:parseFloat($('#edNormal').value)||0, promoPrice:parseFloat($('#edPromo').value)||0,
    marketplacePrice:parseFloat($('#edMarket').value)||0, dealer1:parseFloat($('#edT1').value)||0,
    dealer2:parseFloat($('#edT2').value)||0, dealer3:parseFloat($('#edT3').value)||0
  });
  localStorage.setItem(LS.PRODUCTS, JSON.stringify(products));
  autoSyncSchedule();
  closeEditor(); renderTable(); log('edit_product', p.sku);
});

/* ================= SETTINGS ================= */
$('#btnSettings').onclick=()=>openSettings('data');
$('#btnCloseSettings').onclick=()=>$('#settingsPanel').classList.add('hidden');
$$('.set-tab').forEach(b=>b.onclick=()=>openSettings(b.dataset.tab));

function openSettings(tab){
  if(!['Host','Admin'].includes(currentUser.role)) return;
  $('#settingsPanel').classList.remove('hidden');
  renderSettings(tab);
}
function fileToBase64(f){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(f); }); }

function renderSettings(tab){
  const box=$('#settingsContent');
  $$('.set-tab').forEach(b=>b.classList.remove('ring-2','ring-brand.red'));
  const btn=$(`.set-tab[data-tab="${tab}"]`); if(btn) btn.classList.add('ring-2','ring-brand.red');

  const isHost=currentUser.role==='Host';
  const isAdmin=currentUser.role==='Admin';
  $$('.only-host').forEach(el=>el.classList.toggle('hidden', !isHost));
  $$('.only-host-admin').forEach(el=>el.classList.toggle('hidden', !(isHost||isAdmin)));

  if(tab==='data'){
    if(!(isHost||isAdmin)){ box.innerHTML='<div class="text-zinc-400">Not allowed.</div>'; return; }
    box.innerHTML=`
      <div class="text-2xl font-semibold mb-2">Manage Data</div>
      <div class="text-zinc-400 mb-4">Import / Export Excel (A–O columns; GP% auto-calculated)</div>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="p-4 rounded-2xl border border-zinc-800 bg-zinc-900/40">
          <div class="font-semibold mb-2">Import (.xlsx)</div>
          <input id="fileImport" type="file" accept=".xlsx,.xls" class="w-full">
          <p class="text-xs text-zinc-400 mt-2">Columns: A SKU, B Description, C Details, D Costs, E Normal, F Promotion, G Expires, H Marketplace, I Market GP% (ignored), J Dealer T1, K GP% T1 (ignored), L Dealer T2, M GP% T2 (ignored), N Dealer T3, O GP% T3 (ignored)</p>
          <button id="btnDoImport" class="mt-4 px-4 py-2 rounded-2xl bg-brand.red hover:bg-red-600 border border-red-700">Import</button>
        </div>
        <div class="p-4 rounded-2xl border border-zinc-800 bg-zinc-900/40">
          <div class="font-semibold mb-2">Export (.xlsx)</div>
          <button id="btnExport" class="px-4 py-2 rounded-2xl bg-zinc-900 hover:bg-zinc-800 border border-zinc-700">Export Excel</button>
          <p class="text-xs text-zinc-400 mt-2">Export colors: D = light green, F & G = yellow. GP% (Market/T1/T2/T3 & Promotion) auto-calculated.</p>
        </div>
      </div>
    `;
    $('#btnDoImport').onclick=doImport;
    $('#btnExport').onclick=doExport;
  }

  if(tab==='logo'){
    if(!isHost){ box.innerHTML='<div class="text-zinc-400">Host only.</div>'; return; }
    const base64 = localStorage.getItem(LS.LOGO)||'';
    box.innerHTML=`
      <div class="text-2xl font-semibold mb-2">Manage Logo</div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="p-4 rounded-2xl border border-zinc-800 bg-zinc-900/40">
          <div class="font-semibold mb-2">Upload logo</div>
          <input type="file" id="logoFile" accept="image/*">
          <p class="text-xs text-zinc-400 mt-2">PNG/JPG/SVG. Used on default templates (user templates never show logo).</p>
          <button id="btnSaveLogo" class="mt-4 px-4 py-2 rounded-2xl bg-brand.red hover:bg-red-600 border border-red-700">Save logo</button>
          <button id="btnRemoveLogo" class="mt-4 ml-2 px-4 py-2 rounded-2xl bg-zinc-900 hover:bg-zinc-800 border border-zinc-700">Remove</button>
        </div>
        <div class="p-4 rounded-2xl border border-zinc-800 bg-zinc-900/40">
          <div class="font-semibold mb-2">Preview</div>
          <div class="h-40 w-40 bg-white rounded-xl overflow-hidden grid place-items-center p-2">
            ${base64?`<img src="${base64}" class="max-h-full max-w-full object-contain">`:'<div class="text-zinc-800 text-4xl font-black">P</div>'}
          </div>
        </div>
      </div>
    `;
    $('#btnSaveLogo').onclick=async()=>{
      const f=$('#logoFile').files[0]; if(!f) return alert('Choose a file.');
      const b64=await fileToBase64(f); localStorage.setItem(LS.LOGO,b64);
      $('#logoImg').src=b64; $('#logoImg').classList.remove('hidden'); $('#logoFallback').classList.add('hidden');
      autoSyncSchedule();
      log('update_logo'); openSettings('logo');
    };
    $('#btnRemoveLogo').onclick=()=>{ localStorage.removeItem(LS.LOGO); $('#logoImg').classList.add('hidden'); $('#logoFallback').classList.remove('hidden'); autoSyncSchedule(); log('remove_logo'); openSettings('logo'); }
  }

  if(tab==='dealer'){
    if(!(isHost||isAdmin)){ box.innerHTML='<div class="text-zinc-400">Not allowed.</div>'; return; }
    const flag = JSON.parse(localStorage.getItem(LS.USERS_COST_FLAG)||'false');
    const names = JSON.parse(localStorage.getItem(LS.DEALER_NAMES)||'{}');
    box.innerHTML=`
      <div class="text-2xl font-semibold mb-4">Dealer Settings</div>
      <div class="p-4 rounded-2xl border border-zinc-800 bg-zinc-900/40 space-y-3">
        <div class="grid md:grid-cols-3 gap-3">
          <div><label class="text-xs text-zinc-400">Name for Dealer T1</label><input id="nameT1" class="mt-1 w-full px-3 py-2 rounded-xl bg-zinc-900 border border-zinc-700" value="${names.t1||'Dealer T1'}"></div>
          <div><label class="text-xs text-zinc-400">Name for Dealer T2</label><input id="nameT2" class="mt-1 w-full px-3 py-2 rounded-xl bg-zinc-900 border border-zinc-700" value="${names.t2||'Dealer T2'}"></div>
          <div><label class="text-xs text-zinc-400">Name for Dealer T3</label><input id="nameT3" class="mt-1 w-full px-3 py-2 rounded-xl bg-zinc-900 border border-zinc-700" value="${names.t3||'Dealer T3'}"></div>
        </div>
        <label class="flex items-center gap-3 mt-2">
          <input id="optShowCostsUsers" type="checkbox" class="accent-brand.red"> <span>Allow Users to see "Costs" column</span>
        </label>
        <p class="text-xs text-zinc-500">Host/Admin always see Costs regardless of this setting.</p>
        <button id="btnSaveDealer" class="mt-2 px-4 py-2 rounded-2xl bg-brand.red hover:bg-red-600 border border-red-700">Save</button>
      </div>
    `;
    $('#optShowCostsUsers').checked=!!flag;
    $('#btnSaveDealer').onclick=()=>{
      localStorage.setItem(LS.USERS_COST_FLAG, JSON.stringify($('#optShowCostsUsers').checked));
      dealerNames = {t1:$('#nameT1').value.trim()||'Dealer T1', t2:$('#nameT2').value.trim()||'Dealer T2', t3:$('#nameT3').value.trim()||'Dealer T3'};
      localStorage.setItem(LS.DEALER_NAMES, JSON.stringify(dealerNames));
      applyDealerNamesToUI();
      autoSyncSchedule();
      alert('Saved'); log('save_dealer_setting', JSON.stringify(dealerNames));
    };
  }

  if(tab==='users'){
    if(!(isHost||isAdmin)){ box.innerHTML='<div class="text-zinc-400">Host/Admin only.</div>'; return; }
    const list=allUsers();
    box.innerHTML=`
      <div class="flex items-center justify-between">
        <div class="text-2xl font-semibold mb-2">User Management</div>
        <button id="btnAddUser" class="px-3 py-2 rounded-2xl bg-brand.red hover:bg-red-600 border border-red-700">Add User</button>
      </div>

      <div id="addUserBox" class="hidden p-4 mb-4 rounded-2xl border border-zinc-800 bg-zinc-900/40">
        <div class="grid md:grid-cols-2 gap-3">
          <input id="nuName" placeholder="username" class="px-3 py-2 rounded-xl bg-zinc-900 border border-zinc-700">
          <input id="nuPass" placeholder="password" class="px-3 py-2 rounded-xl bg-zinc-900 border border-zinc-700">
          <select id="nuRole" class="px-3 py-2 rounded-xl bg-zinc-900 border border-zinc-700">
            <option>User</option><option>Admin</option><option>Host</option>
          </select>
          <div class="flex items-center gap-4">
            <label class="text-sm"><input type="checkbox" id="nuSeeCosts"> See Costs</label>
            <label class="text-sm"><input type="checkbox" id="nuCanPrint" checked> Can Print</label>
          </div>
          <div class="md:col-span-2">
            ${Channels.map(ch=>`<label class="mr-3 text-sm"><input type="checkbox" class="nuCh" value="${ch}" ${ch==='Flagship'?'checked':''}> ${ch}</label>`).join('')}
          </div>
        </div>
        <div class="mt-3"><button id="nuCreate" class="px-4 py-2 rounded-2xl bg-zinc-900 hover:bg-zinc-800 border border-zinc-700">Create</button></div>
      </div>

      <div class="overflow-auto border border-zinc-800 rounded-2xl">
        <table class="min-w-[900px] w-full text-sm">
          <thead class="bg-zinc-900/70 border-b border-zinc-800">
            <tr class="[&>th]:px-3 [&>th]:py-2 text-left">
              <th>User</th><th>Role</th><th>Channels</th><th>See Costs</th><th>Can Print</th><th>Password</th><th></th>
            </tr>
          </thead>
          <tbody id="userRows"></tbody>
        </table>
      </div>
    `;
    $('#btnAddUser').onclick=()=>$('#addUserBox').classList.toggle('hidden');
    $('#nuCreate').onclick=()=>{
      const name=$('#nuName').value.trim(); const pass=$('#nuPass').value.trim(); if(!name||!pass) return alert('Username & password required');
      if(allUsers().some(u=>u.username===name)) return alert('Username already exists');
      const role=$('#nuRole').value; const canSee=$('#nuSeeCosts').checked; const canPrint=$('#nuCanPrint').checked;
      const chs=$$('.nuCh').filter(x=>x.checked).map(x=>x.value); if(!chs.length) return alert('Select at least one channel');
      const list=allUsers(); list.push({username:name,password:pass,role,channels:chs,canSeeCosts:canSee,canPrint});
      setUsers(list); log('add_user',name); openSettings('users'); alert('User created');
    };

    const tbody=$('#userRows'); tbody.innerHTML='';
    list.forEach((u,i)=>{
      const tr=document.createElement('tr'); tr.className='border-b border-zinc-800';
      tr.innerHTML=`
        <td class="px-3 py-2">${u.username}</td>
        <td class="px-3 py-2">
          <select data-role="${i}" class="px-2 py-1 rounded-xl bg-zinc-900 border border-zinc-700">
            ${['Host','Admin','User'].map(r=>`<option ${u.role===r?'selected':''}>${r}</option>`).join('')}
          </select>
        </td>
        <td class="px-3 py-2">
          ${Channels.map(ch=>`<label class="mr-2"><input type="checkbox" data-ch="${i}|${ch}" ${u.channels.includes(ch)?'checked':''}> <span class="text-xs">${ch}</span></label>`).join('')}
        </td>
        <td class="px-3 py-2"><input type="checkbox" data-cost="${i}" ${u.canSeeCosts?'checked':''}></td>
        <td class="px-3 py-2"><input type="checkbox" data-print="${i}" ${u.canPrint?'checked':''}></td>
        <td class="px-3 py-2"><input type="text" data-pass="${i}" value="${u.password}" class="w-28 px-2 py-1 rounded-xl bg-zinc-900 border border-zinc-700"></td>
        <td class="px-3 py-2">
          <button class="px-2 py-1 rounded-xl bg-zinc-900 hover:bg-zinc-800 border border-zinc-700 text-xs" data-saveu="${i}">Save</button>
          <button class="ml-2 px-2 py-1 rounded-xl bg-transparent border border-red-700 hover:bg-red-700/20 text-xs" data-delu="${i}">❌</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
    $$('button[data-saveu]').forEach(b=>b.onclick=()=>{
      const i=+b.getAttribute('data-saveu'); const list=allUsers(); const u=list[i];
      u.role=$(`select[data-role="${i}"]`).value;
      u.canSeeCosts=$(`input[data-cost="${i}"]`).checked;
      u.canPrint=$(`input[data-print="${i}"]`).checked;
      u.password=$(`input[data-pass="${i}"]`).value;
      u.channels=Channels.filter(ch=> $(`input[data-ch="${i}|${ch}"]`).checked );
      setUsers(list);
      if(currentUser.username===u.username){ currentUser=u; initFiltersForUser(); renderTable(); }
      log('update_user',u.username); alert('Saved.');
    });
    $$('button[data-delu]').forEach(b=>b.onclick=()=>{
      const i=+b.getAttribute('data-delu'); const list=allUsers(); const u=list[i];
      if(u.username==='host') return alert('Cannot delete the default host account.');
      if(confirm(`Delete user "${u.username}"?`)){
        list.splice(i,1); setUsers(list); log('delete_user',u.username); openSettings('users');
      }
    });
  }

  if(tab==='templates'){
    if(!isHost){ box.innerHTML='<div class="text-zinc-400">Host only.</div>'; return; }
    const list=JSON.parse(localStorage.getItem(LS.TEMPLATES));
    box.innerHTML=`
      <div class="flex items-center justify-between">
        <div class="text-2xl font-semibold mb-2">Template Management</div>
        <div class="flex items-center gap-2">
          <button id="btnNewTpl" class="px-3 py-2 rounded-2xl bg-brand.red hover:bg-red-600 border border-red-700">New template</button>
          <label class="px-3 py-2 rounded-2xl bg-zinc-900 border border-zinc-700 cursor-pointer hover:bg-zinc-800">
            <input type="file" id="tplUpload" accept="application/json" class="hidden"> Upload JSON
          </label>
        </div>
      </div>
      <div class="text-sm text-zinc-400 mb-3">User-uploaded templates never show the company logo.</div>
      <div id="tplList" class="grid lg:grid-cols-2 gap-6 mt-2"></div>
    `;
    const listBox=$('#tplList'); listBox.innerHTML='';
    list.forEach((t,i)=>{
      const card=document.createElement('div');
      card.className='p-4 rounded-2xl border border-zinc-800 bg-zinc-900/40';
      card.innerHTML=`
        <div class="font-semibold">${t.name}</div>
        <div class="text-xs text-zinc-400 mb-3">${t.kind} ${t.showLogo?'• shows logo':'• no logo'}</div>
        <div class="grid grid-cols-2 gap-3">
          ${['sku','description','details','price','oldPrice','expire'].map(k=>`
            <div class="p-3 rounded-xl bg-zinc-900 border border-zinc-800">
              <div class="text-xs text-zinc-400 mb-1">${k}</div>
              <label class="text-xs">Font size</label>
              <input type="number" step="1" data-fs="${i}|${k}" value="${t.styles[k]?.fs||14}" class="w-full px-2 py-1 rounded-xl bg-zinc-950 border border-zinc-800 mb-1">
              <label class="text-xs">Color</label>
              <input type="color" data-color="${i}|${k}" value="${t.styles[k]?.color||'#ffffff'}" class="w-full h-8 rounded-xl bg-zinc-950 border border-zinc-800 mb-1">
              <label class="text-xs">Top margin (px)</label>
              <input type="number" step="1" data-mt="${i}|${k}" value="${t.styles[k]?.mt||0}" class="w-full px-2 py-1 rounded-xl bg-zinc-950 border border-zinc-800">
            </div>
          `).join('')}
        </div>
        <div class="mt-3 flex items-center justify-between">
          <label class="flex items-center gap-2 text-sm ${['t-a4','t-a5','t-a6','t-acc'].includes(t.id)?'':'hidden'}"><input type="checkbox" data-logo="${i}" ${t.showLogo?'checked':''}> Show logo (default templates only)</label>
          ${['t-a4','t-a5','t-a6','t-acc'].includes(t.id) ? '<span class="text-xs text-zinc-500">(cannot delete)</span>' : `<button class="px-3 py-1 rounded-2xl bg-zinc-900 hover:bg-zinc-800 border border-zinc-700" data-del="${i}">Delete</button>`}
        </div>
        <button class="mt-3 w-full px-3 py-2 rounded-2xl bg-brand.red hover:bg-red-600 border border-red-700" data-savtpl="${i}">Save template</button>
      `;
      listBox.appendChild(card);
    });
    $$('button[data-savtpl]').forEach(b=>b.onclick=()=>{
      const i=+b.getAttribute('data-savtpl'); const arr=JSON.parse(localStorage.getItem(LS.TEMPLATES)); const t=arr[i];
      ['sku','description','details','price','oldPrice','expire'].forEach(k=>{
        t.styles[k]=t.styles[k]||{}; t.styles[k].fs=parseInt($(`input[data-fs="${i}|${k}"]`).value)||14;
        t.styles[k].color=$(`input[data-color="${i}|${k}"]`).value||'#ffffff';
        t.styles[k].mt=parseInt($(`input[data-mt="${i}|${k}"]`).value)||0;
      });
      if(['t-a4','t-a5','t-a6','t-acc'].includes(t.id)){ t.showLogo=$(`input[data-logo="${i}"]`).checked; }
      localStorage.setItem(LS.TEMPLATES, JSON.stringify(arr)); templates=arr; autoSyncSchedule(); log('save_template',t.name); alert('Template saved');
    });
    $$('button[data-del]').forEach(b=>b.onclick=()=>{
      const i=+b.getAttribute('data-del'); const arr=JSON.parse(localStorage.getItem(LS.TEMPLATES)); const t=arr[i];
      if(confirm('Delete this template?')){ arr.splice(i,1); localStorage.setItem(LS.TEMPLATES, JSON.stringify(arr)); templates=arr; autoSyncSchedule(); log('delete_template', t.name); openSettings('templates'); }
    });
    $('#btnNewTpl').onclick=()=>{
      const nm=prompt('Template name'); if(!nm) return;
      const id='user-'+Math.random().toString(36).slice(2,8);
      const tpl={id,name:nm,kind:'ACC',showLogo:false,styles:{sku:{fs:12,color:'#fff',mt:0},description:{fs:16,color:'#fff',mt:0},details:{fs:12,color:'#fff',mt:0},price:{fs:22,color:'#fff',mt:0},oldPrice:{fs:12,color:'#B91C1C',mt:0},expire:{fs:10,color:'#fff',mt:0}}};
      const arr=JSON.parse(localStorage.getItem(LS.TEMPLATES)); arr.push(tpl); localStorage.setItem(LS.TEMPLATES, JSON.stringify(arr)); templates=arr; autoSyncSchedule(); log('create_template',nm); openSettings('templates');
    };
    $('#tplUpload').onchange=async(e)=>{
      const f=e.target.files[0]; if(!f) return;
      try{ const txt=await f.text(); const obj=JSON.parse(txt); if(!obj.id) obj.id='user-'+Math.random().toString(36).slice(2,8);
        obj.showLogo=false; const arr=JSON.parse(localStorage.getItem(LS.TEMPLATES)); arr.push(obj); localStorage.setItem(LS.TEMPLATES, JSON.stringify(arr)); templates=arr; autoSyncSchedule(); log('upload_template',obj.name||obj.id); openSettings('templates'); alert('Template uploaded.'); }
      catch{ alert('Invalid JSON template.'); }
    };
  }

  if(tab==='cloud'){
    if(!isHost){ box.innerHTML='<div class="text-zinc-400">Host only.</div>'; return; }
    const cfg=cloudCfg();
    box.innerHTML=`
      <div class="text-2xl font-semibold mb-2">Cloud Sync (GitHub Gist)</div>
      <p class="text-sm text-zinc-400 mb-4">Save and share data across browsers/devices. Create a Gist or link to an existing one. Only Host can configure this.</p>
      <div class="grid md:grid-cols-2 gap-6">
        <div class="p-4 rounded-2xl border border-zinc-800 bg-zinc-900/40 space-y-3">
          <label class="text-xs text-zinc-400">GitHub Personal Access Token (scope: gist)</label>
          <input id="cloudToken" type="password" class="w-full px-3 py-2 rounded-xl bg-zinc-900 border border-zinc-700" placeholder="ghp_..." value="${cfg.token||''}">
          <label class="text-xs text-zinc-400">Gist ID</label>
          <input id="cloudGistId" class="w-full px-3 py-2 rounded-xl bg-zinc-900 border border-zinc-700" placeholder="e.g. a1b2c3d4..." value="${cfg.gistId||''}">
          <label class="text-sm flex items-center gap-2"><input type="checkbox" id="cloudAuto" ${cfg.autoSync?'checked':''}> Auto-Sync</label>
          <div class="flex gap-2">
            <button id="cloudCreate" class="px-3 py-2 rounded-2xl bg-brand.red hover:bg-red-600 border border-red-700">Create New Gist</button>
            <button id="cloudSave" class="px-3 py-2 rounded-2xl bg-zinc-900 hover:bg-zinc-800 border border-zinc-700">Save to Cloud</button>
            <button id="cloudLoad" class="px-3 py-2 rounded-2xl bg-zinc-900 hover:bg-zinc-800 border border-zinc-700">Load from Cloud</button>
          </div>
        </div>
        <div class="p-4 rounded-2xl border border-zinc-800 bg-zinc-900/40">
          <div class="font-semibold mb-2">Notes</div>
          <ul class="list-disc pl-6 text-sm text-zinc-400 space-y-1">
            <li>Secret Gist is “unlisted” — anyone with the link can read. Do not store secrets.</li>
            <li>All data is in <code>proplugin-data.json</code> inside the Gist.</li>
          </ul>
        </div>
      </div>
    `;

    /* save config instantly when typing/toggling */
    const saveCfgInstant = ()=>{
      saveCloudCfg({
        token: $('#cloudToken').value.trim(),
        gistId: $('#cloudGistId').value.trim(),
        autoSync: $('#cloudAuto').checked
      });
    };
    $('#cloudToken').addEventListener('input', saveCfgInstant);
    $('#cloudGistId').addEventListener('input', saveCfgInstant);
    $('#cloudAuto').addEventListener('change', saveCfgInstant);
    saveCfgInstant();

    $('#cloudCreate').onclick=async()=>{
      try{
        saveCfgInstant();
        await cloudCreateGist();
        $('#cloudGistId').value=cloudCfg().gistId||'';
        alert('Gist created and saved.');
      }catch(e){ alert(e.message); }
    };
    $('#cloudSave').onclick=async()=>{
      try{ saveCfgInstant(); await cloudSave(); alert('Saved to cloud.'); }catch(e){ alert(e.message); }
    };
    $('#cloudLoad').onclick=async()=>{
      try{ saveCfgInstant(); await cloudLoad(); }catch(e){ alert(e.message); }
    };
  }

  if(tab==='history'){
    if(!isHost){ box.innerHTML='<div class="text-zinc-400">Host only.</div>'; return; }
    const logs=JSON.parse(localStorage.getItem(LS.LOGS)||'[]');
    box.innerHTML=`
      <div class="text-2xl font-semibold mb-2">Usage History</div>
      <div class="max-h-[65vh] overflow-auto border border-zinc-800 rounded-2xl">
        <table class="min-w-[700px] w-full text-sm">
          <thead class="bg-zinc-900/70 border-b border-zinc-800">
            <tr class="[&>th]:px-3 [&>th]:py-2 text-left"><th>Time</th><th>User</th><th>Action</th><th>Details</th></tr>
          </thead>
          <tbody>${logs.map(l=>`<tr class="border-b border-zinc-800"><td class="px-3 py-2">${new Date(l.ts).toLocaleString('th-TH')}</td><td class="px-3 py-2">${l.user}</td><td class="px-3 py-2">${l.action}</td><td class="px-3 py-2 text-zinc-400">${l.meta||''}</td></tr>`).join('')}</tbody>
        </table>
      </div>
    `;
  }
}

/* ================= IMPORT / EXPORT ================= */
async function doImport(){
  const fi=$('#fileImport'); if(!fi.files[0]) return alert('Choose a file');
  const data=await fi.files[0].arrayBuffer();
  const wb=XLSX.read(data,{type:'array'}); const ws=wb.Sheets[wb.SheetNames[0]];
  const rows=XLSX.utils.sheet_to_json(ws,{header:1,defval:''});
  const start=rows.findIndex(r=> (r[0]||'').toString().trim() && (r[0]||'')!=='SKU');
  const newItems=[];
  for(let i=start;i<rows.length;i++){
    const r=rows[i]; if(!(r[0]||'').toString().trim()) continue;
    newItems.push({
      sku:(r[0]||'').toString().trim(), description:(r[1]||'').toString().trim(), details:(r[2]||'').toString().trim(),
      costs:parseFloat(r[3]||0)||0, normalPrice:parseFloat(r[4]||0)||0, promoPrice:parseFloat(r[5]||0)||0,
      expiresDate:fromExcelDate(r[6]||''), marketplacePrice:parseFloat(r[7]||0)||0, dealer1:parseFloat(r[9]||0)||0,
      dealer2:parseFloat(r[11]||0)||0, dealer3:parseFloat(r[13]||0)||0
    });
  }
  if(!newItems.length) return alert('No data found');
  products=newItems; localStorage.setItem(LS.PRODUCTS, JSON.stringify(products)); renderTable(); autoSyncSchedule(); log('import_excel', `${newItems.length} rows`);
  alert('Imported: '+newItems.length+' rows');
}
async function doExport(){
  const wb=await XlsxPopulate.fromBlankAsync(); const sh=wb.sheet(0).name('PriceData');
  const header=['SKU','Description','Details','Costs','Normal Price','Promotion Price','Expires Date','Marketplace Price','Marketplace GP%','Dealer Price Tier 1','GP% T1','Dealer Price Tier 2','GP% T2','Dealer Price Tier 3','GP% T3','Promotion GP%'];
  const dataRows = products.map(p=>[
    p.sku,p.description,p.details,p.costs,p.normalPrice,p.promoPrice,p.expiresDate?toDateInput(p.expiresDate):'',
    p.marketplacePrice, +gpPct(p.marketplacePrice,p.costs).toFixed(2),
    p.dealer1, +gpPct(p.dealer1,p.costs).toFixed(2),
    p.dealer2, +gpPct(p.dealer2,p.costs).toFixed(2),
    p.dealer3, +gpPct(p.dealer3,p.costs).toFixed(2),
    +gpPct(p.promoPrice,p.costs).toFixed(2)
  ]);
  const matrix=[header,...dataRows];
  sh.cell('A1').value(matrix);
  sh.row(1).style({bold:true});
  const lastRow=matrix.length;
  const lightGreen='FFCCFFCC', yellow='FFFFFF99';
  if(lastRow>1){
    sh.range(`D2:D${lastRow}`).style({fill:lightGreen});
    sh.range(`F2:G${lastRow}`).style({fill:yellow});
  }
  const widths=[12,28,50,12,14,16,16,16,14,14,12,14,12,14,12,14];
  widths.forEach((w,i)=>sh.column(i+1).width(w));
  const blob=await wb.outputAsync();
  const url=URL.createObjectURL(new Blob([blob],{type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'}));
  const a=document.createElement('a'); a.href=url; a.download='price_data_export.xlsx'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  log('export_excel', `${products.length} rows`);
}

/* ================= PRINT FLOW ================= */
function togglePrintModal(show){ $('#printModal').classList.toggle('hidden', !show); }
$('#btnPrintModal').onclick=()=>{ if(!currentUser.canPrint) return; buildPrintList(); fillTemplateDropdown(); const items=filteredProducts(); renderPreview(items[0], templates[0]); togglePrintModal(true); };

function buildPrintList(){
  const box=$('#printList'); box.innerHTML='';
  const items=filteredProducts();
  const frag=document.createDocumentFragment();
  items.forEach(p=>{
    const row=document.createElement('div');
    row.className='flex items-center gap-3 bg-zinc-900/60 border border-zinc-800 rounded-2xl p-2';
    row.innerHTML=`
      <label class="flex items-center gap-2 w-6">
        <input type="checkbox" data-sel="${p.sku}">
      </label>
      <div class="flex-1">
        <div class="font-medium oneline" title="${p.sku}">${p.sku}</div>
        <div class="text-xs text-zinc-400 oneline" title="${p.description}">${ellip(p.description, 46)}</div>
      </div>
      <div class="flex items-center gap-1">
        <span class="text-xs text-zinc-400">Qty</span>
        <input type="number" min="1" value="1" data-qty="${p.sku}" class="w-20 px-2 py-1 rounded-xl bg-zinc-950 border border-zinc-800">
      </div>
    `;
    frag.appendChild(row);
  });
  box.appendChild(frag);
  $('#printCheckAll').checked=false;
  $('#printCheckAll').onchange=()=> $$('#printList input[type="checkbox"]').forEach(c=>c.checked=$('#printCheckAll').checked);
  $('#printSearch').oninput=()=>{
    const q=$('#printSearch').value.toLowerCase();
    $$('#printList > div').forEach(div=>{
      const sku=div.querySelector('[data-sel]').getAttribute('data-sel').toLowerCase();
      const desc=div.querySelector('.text-xs').getAttribute('title').toLowerCase();
      div.style.display = (!q || sku.includes(q) || desc.includes(q)) ? '' : 'none';
    });
  };
  updatePrintSummary();
  $$('#printList input').forEach(i=>i.oninput=updatePrintSummary);
}
function updatePrintSummary(){
  const selected=$$('#printList input[type="checkbox"]:checked');
  let count=0; selected.forEach(c=>{ const sku=c.getAttribute('data-sel'); const qty=parseInt($(`[data-qty="${sku}"]`).value)||0; count+=qty; });
  $('#printSummary').textContent = `${selected.length} SKUs selected • ${count} tags total`;
}
function fillTemplateDropdown(){
  const dd=$('#printTemplate'); dd.innerHTML='';
  templates.forEach(t=>{ const o=document.createElement('option'); o.value=t.id; o.textContent=t.name; dd.appendChild(o); });
  dd.onchange=()=>{ const first=filteredProducts()[0]; renderPreview(first, templates.find(t=>t.id===dd.value)); };
}

/* ---------- Live Preview: fit-to-pane + observer ---------- */
function baseSize(kind){
  if(kind==='A4') return {w:744,h:1052};  // portrait
  if(kind==='A5') return {w:526,h:744};   // portrait A5 (เหมือน A4/A6 แต่ย่อ)
  if(kind==='A6') return {w:372,h:526};   // portrait
  return {w:640,h:320}; // ACC (label aspect ~2:1)
}
function styleInline(o){ return `font-size:${o.fs||14}px;color:${o.color||'#fff'};margin-top:${o.mt||0}px;`; }
function truncateMiddle(str,max){ if(!str) return ''; if(str.length<=max) return str; const half=Math.floor((max-3)/2); return str.slice(0,half)+'...'+str.slice(-half); }

function renderTagInnerHTML(p,tpl){
  if(tpl.kind==='ACC'){
    const s=tpl.styles;
    return `
      <div style="position:absolute;left:6mm;top:4mm;${styleInline(s.sku)}" class="text-elevate">${p.sku}</div>
      <div style="display:flex;align-items:center;justify-content:center;text-align:center;height:100%;padding:10mm 8mm;" class="text-elevate">
        <div style="${styleInline(s.description)};max-width:100%;word-break:break-word">${truncateMiddle(p.description, 44)}</div>
      </div>
      <div style="position:absolute;left:6mm;bottom:4mm;${styleInline(s.expire)}" class="text-elevate">Expire ${p.expiresDate?toDateInput(p.expiresDate):''}</div>
      <div style="position:absolute;right:6mm;bottom:4mm;text-align:right">
        <div style="${styleInline(s.oldPrice)}" class="line-through text-elevate">${money(p.normalPrice)}.-</div>
        <div style="font-weight:900;${styleInline(s.price)}" class="text-elevate">${money(p.promoPrice)}.-</div>
      </div>
    `;
  }
  const s=tpl.styles;
  const bullets=(p.details||'').split(/\n+/).filter(Boolean).slice(0,5).map(t=>`
    <div class="flex gap-2 items-start text-elevate" style="${styleInline(s.details)}"><span>•</span><span>${t}</span></div>`).join('');
  return `
    <div style="padding:10mm">
      <div style="${styleInline(s.sku)};opacity:.9" class="text-right text-elevate">${p.sku}</div>
      <div style="font-weight:800;line-height:1.2;${styleInline(s.description)}" class="mt-2 text-elevate">${p.description}</div>
      <div class="mt-3 space-y-1">${bullets}</div>
      <div class="mt-4 flex items-end justify-between">
        <div style="${styleInline(s.expire)}" class="text-elevate">Expire : ${p.expiresDate?toDateInput(p.expiresDate):''}</div>
        <div class="text-right">
          <div style="${styleInline(s.oldPrice)}" class="line-through text-elevate">${money(p.normalPrice)}.-</div>
          <div style="font-weight:900;${styleInline(s.price)}" class="text-elevate">${money(p.promoPrice)}.-</div>
        </div>
      </div>
    </div>
  `;
}
function buildPreviewTag(p,tpl){
  const {w,h}=baseSize(tpl.kind);
  const outer=document.createElement('div');
  outer.style.width=w+'px'; outer.style.height=h+'px';
  outer.style.borderRadius='12px'; outer.style.overflow='hidden';
  outer.style.border='2px solid #1f1f22'; outer.style.background = tpl.kind==='ACC'?'#000':'#0b0b0c'; outer.style.color='#fff'; outer.style.position='relative';
  if(tpl.showLogo){
    const logo=localStorage.getItem(LS.LOGO);
    outer.innerHTML += logo? `<img src="${logo}" style="position:absolute;right:10px;top:10px;width:64px">`
                           : `<div style="position:absolute;right:10px;top:10px;width:64px;color:#fff;font-weight:800;text-align:right">P</div>`;
  }
  const inner=document.createElement('div');
  inner.innerHTML=renderTagInnerHTML(p,tpl);
  inner.style.width='100%'; inner.style.height='100%';
  outer.appendChild(inner);
  return {node:outer, w, h};
}
function renderPreview(item,tpl){
  const box=$('#previewBox'); box.innerHTML='';
  if(!item){ box.innerHTML='<div class="text-zinc-500">No items</div>'; return; }
  const {node,w,h}=buildPreviewTag(item,tpl);
  node.style.transformOrigin='top left';
  const holder=document.createElement('div');
  holder.style.position='relative';
  holder.appendChild(node);
  box.appendChild(holder);

  function fit(){
    const availW=box.clientWidth;
    const availH=box.clientHeight;
    const scale=Math.max(0.1, Math.min(availW/w, availH/h));
    node.style.transform=`scale(${scale})`;
    holder.style.width=(w*scale)+'px';
    holder.style.height=(h*scale)+'px';
    holder.style.margin='auto';
  }
  fit();
  window.addEventListener('resize', fit, {passive:true});
  $('#printTemplate')?.addEventListener('change', fit, {passive:true});
  const ro = new ResizeObserver(()=>fit()); ro.observe(box);
}

/* ---------- Print page (A5 portrait on A4 landscape, 2-up) ---------- */
function openPrintTab(list,tpl){
  const items=[]; list.forEach(({p,qty})=>{ for(let i=0;i<qty;i++) items.push(p); });
  if(!items.length){ alert('Select at least one SKU.'); return; }

  const w=window.open('', '_blank');
  if(!w){ alert('Pop-up blocked. Please allow pop-ups and click "Open Print Page" again.'); return; }

  const logo=localStorage.getItem(LS.LOGO)||'';
  let cols=1, rows=1, pad='8mm', logoW='28mm';
  let pageSize='A4'; // default

  if(tpl.kind==='A4'){ cols=1; rows=1; pad='10mm'; logoW='32mm'; pageSize='A4'; }
  else if(tpl.kind==='A5'){ cols=2; rows=1; pad='10mm'; pageSize='A4 landscape'; }   // 2-up on A4 landscape
  else if(tpl.kind==='A6'){ cols=2; rows=2; pad='8mm'; pageSize='A4'; }
  else { cols=2; rows=6; pad='6mm'; logoW='20mm'; pageSize='A4'; }

  const style=`
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;600;700;800;900&family=Prompt:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
      @page { size: ${pageSize}; margin: 8mm; }
      html,body{
        background:#000;
        -webkit-print-color-adjust: exact; print-color-adjust: exact;
        font-family:'Kanit','Prompt',sans-serif;
      }

      ${pageSize==='A4 landscape'
        ? `
          /* A4 landscape: 297 x 210 mm */
          .sheet{
            width:  calc(297mm - 16mm);
            height: calc(210mm - 16mm);
            margin: 0 auto;
            display: grid;
            grid-template-columns: repeat(${cols}, 1fr); /* 2 columns for A5 */
            grid-template-rows:    repeat(${rows}, 1fr); /* 1 row */
            gap: 0;
            page-break-after: always;
          }
        `
        : `
          /* A4 portrait */
          .sheet{
            width:  calc(210mm - 16mm);
            height: calc(297mm - 16mm);
            margin: 0 auto;
            display: grid;
            grid-template-columns: repeat(${cols}, 1fr);
            grid-template-rows:    repeat(${rows}, 1fr);
            gap: 0;
            page-break-after: always;
          }
        `
      }

      .tag{ width:100%; height:100%; padding:${pad}; box-sizing:border-box; }
      .card{
        position:relative; width:100%; height:100%;
        border-radius:12px; overflow:hidden; border:2px solid #1f1f22;
        background:${tpl.kind==='ACC'?'#000':'#0b0b0c'}; color:#fff;
      }
      .logo{ position:absolute; right:8mm; top:6mm; width:${logoW}; }
      .text-elevate{ text-shadow: 0 1px 2px rgba(0,0,0,.9), 0 0 1px rgba(0,0,0,.7); }
    </style>
  `;

  const perSheet = cols*rows;
  const pages=[]; for(let i=0;i<items.length;i+=perSheet) pages.push(items.slice(i,i+perSheet));
  const logoTag = (tpl.showLogo && logo) ? `<img src="${logo}" class="logo">` : (tpl.showLogo ? `<div class="logo" style="color:#fff;font-weight:800">P</div>` : '');

  const body = pages.map(pg=>{
    const inner=pg.map(p=>`
      <div class="tag"><div class="card">${logoTag}${renderTagInnerHTML(p,tpl)}</div></div>
    `).join('');
    return `<div class="sheet">${inner}</div>`;
  }).join('');

  w.document.write(`<!doctype html><html><head><meta charset="utf-8"><title>Print</title>${style}</head><body>${body}</body></html>`);
  w.document.close();
  log('open_print', `${items.length} tags, tpl=${tpl.name}`);
}

/* ================= EVENTS ================= */
$('#btnLogin').onclick=login;
$('#btnLogout').onclick=()=>{ log('logout'); logout(); };

['#searchInput','#dateStart','#dateEnd'].forEach(s=>$(s).addEventListener('input', renderTable));
$('#channelSelect').addEventListener('change', ()=>{ updateColumnVisibility(); renderTable(); });

/* Costs visibility propagation if global flag enables for Users */
const observer=new MutationObserver(()=>{
  const flag=JSON.parse(localStorage.getItem(LS.USERS_COST_FLAG)||'false');
  if(currentUser && currentUser.role==='User' && flag){
    currentUser.canSeeCosts=true; $('#thCosts').classList.remove('hidden');
  }
});
observer.observe(document.body,{childList:true,subtree:true});

/* ================= STARTUP ================= */
loadState();
const last=localStorage.getItem(LS.LASTUSER)||''; if(last) $('#loginUser').value=last;

/* Keyboard shortcut for search */
window.addEventListener('keydown',e=>{ if((e.metaKey||e.ctrlKey)&&e.key.toLowerCase()==='k'){ e.preventDefault(); $('#searchInput').focus(); }});

/* Bind print "Open Print Page" */
document.addEventListener('click', (e)=>{
  if(e.target && e.target.id==='btnOpenPrint'){
    const picks=$$('#printList input[type="checkbox"]:checked').map(c=>c.getAttribute('data-sel'));
    const list=picks.map(sku=>products.find(p=>p.sku===sku)).filter(Boolean)
                    .map(p=>({p,qty:parseInt($(`[data-qty="${p.sku}"]`).value)||1}));
    const tpl=templates.find(t=>t.id===$('#printTemplate').value) || templates[0];
    openPrintTab(list,tpl);
  }
});
</script>
</body>
</html>
