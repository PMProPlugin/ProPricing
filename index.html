<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Price Tag Manager — ProPlugin (Calibrated Print)</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  <style>
    :root{ --bg:#0b0b0b; --fg:#fff; --accent:#e6192b; --card:#101214; --gap:14px }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font-family:"Kanit",system-ui,Segoe UI,Roboto,Arial,Helvetica,sans-serif}
    body,button,input,select,table,.tag,.tag *{font-family:"Kanit",system-ui,Segoe UI,Roboto,Arial,Helvetica,sans-serif!important}
    .container{max-width:1200px;margin:0 auto;padding:18px}
    .stack{display:flex;gap:var(--gap)}.v{flex-direction:column}
    .card{background:var(--card);border:1px solid #23292f;border-radius:16px;padding:16px}
    .btn{background:#171b20;border:1px solid #2c333b;border-radius:12px;color:#fff;padding:10px 14px;font-weight:600;cursor:pointer}
    .btn.red{background:var(--accent);border-color:transparent}
    .input,.select{background:#0f1215;border:1px solid #2a3139;border-radius:12px;color:#fff;padding:10px 12px;width:100%}
    table{width:100%;border-collapse:collapse} thead th{background:#0f1215;border-bottom:1px solid #303841;text-align:left;padding:10px} tbody td{border-bottom:1px solid #1b2229;padding:10px}

    /* ==== PRINTABLE TAG PRIMITIVES (values filled from JS via <style id=tplStyle>) ==== */
    .tag{position:relative;display:flex;flex-direction:column;background:#fff;color:#000;overflow:hidden}
    .frame{position:absolute;inset:0;border:var(--frame,12mm) solid #000}
    .tag-inner{position:absolute;inset:var(--inset,12mm);display:flex;flex-direction:column}
    .tag-logo{position:absolute;left:var(--logo-x,14mm);top:var(--logo-y,14mm);height:var(--logo-h,16mm)}
    .sku{position:absolute;right:var(--sku-x,15mm);top:var(--sku-y,16mm);font-size:6mm;font-weight:600}
    .title{margin-top:35mm;margin-left:14mm;margin-right:14mm;font-size:16mm;line-height:1.05;font-weight:800}
    .bullets{margin:4mm 14mm 0 14mm;font-size:7mm;line-height:1.35}
    .price-area{position:absolute;left:14mm;right:14mm;bottom:14mm;display:grid;grid-template-columns:1fr auto;align-items:end}
    .expire{font-size:6mm;font-weight:800}
    .price-now{font-size:22mm;font-weight:900}
    .price-was{font-size:8mm;font-weight:800;color:#b71c1c;text-decoration:line-through}

    /* A4 page container the sheets mount into */
    .print-sheet{page-break-after:always;break-after:page;display:grid;background:#fff;width:210mm}

    @media print{
      @page{ size:A4; margin: var(--pg-margin,5mm); }
      .no-print{display:none!important}
      body{background:#fff}
      /* print calibration: scale whole sheet if needed */
      .print-root{ transform-origin:top left; transform:scale(var(--print-scale,1)); width: calc(210mm / var(--print-scale,1)); }
    }
  </style>
</head>
<body>
<div class="container v">
  <div class="card">
    <div class="stack" style="justify-content:space-between;align-items:center">
      <strong>Price Tag Manager — Calibrated Print</strong>
      <div class="stack">
        <button class="btn" id="btnTpl">ตั้งค่าเทมเพลต/พิมพ์</button>
        <button class="btn" id="btnPreview">พรีวิว/พิมพ์</button>
      </div>
    </div>
  </div>

  <div class="card">
    <div id="tableWrap"></div>
  </div>
</div>

<!-- Settings Modal -->
<div id="tplModal" class="no-print" style="position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;padding:20px">
  <div class="card" style="width:min(100%,950px);max-height:90vh;overflow:auto">
    <div class="stack" style="justify-content:space-between;align-items:center"><strong>ตั้งค่าเทมเพลต & การพิมพ์</strong><button class="btn" id="tplClose">ปิด</button></div>
    <div class="stack v" style="margin-top:12px">
      <div class="stack" style="gap:16px;flex-wrap:wrap">
        <div>
          <div><b>A4 Tag</b></div>
          <label>กว้าง (mm) <input class="input" id="wA4" type="number" step=".1"></label>
          <label>สูง (mm) <input class="input" id="hA4" type="number" step=".1"></label>
        </div>
        <div>
          <div><b>A5 Tag</b></div>
          <label>กว้าง (mm) <input class="input" id="wA5" type="number" step=".1"></label>
          <label>สูง (mm) <input class="input" id="hA5" type="number" step=".1"></label>
        </div>
        <div>
          <div><b>A6 Tag</b></div>
          <label>กว้าง (mm) <input class="input" id="wA6" type="number" step=".1"></label>
          <label>สูง (mm) <input class="input" id="hA6" type="number" step=".1"></label>
        </div>
        <div>
          <div><b>Accessories Tag</b></div>
          <label>กว้าง (mm) <input class="input" id="wACC" type="number" step=".1"></label>
          <label>สูง (mm) <input class="input" id="hACC" type="number" step=".1"></label>
        </div>
        <div>
          <div><b>องค์ประกอบ</b></div>
          <label>ความหนากรอบ (mm) <input class="input" id="frameMM" type="number" step=".1"></label>
          <label>ระยะขอบด้านใน (mm) <input class="input" id="insetMM" type="number" step=".1"></label>
        </div>
        <div>
          <div><b>การพิมพ์</b></div>
          <label>ขอบหน้ากระดาษ (mm) <input class="input" id="pgMargin" type="number" step=".1"></label>
          <label>สเกลการพิมพ์ (%) <input class="input" id="printScale" type="number" step="1" min="50" max="150"></label>
          <small>Tips: พิมพ์ไม้บรรทัด 100mm ทดสอบ → วัดจริง แล้วปรับสเกลให้ตรง</small>
        </div>
      </div>
      <div>
        <button class="btn red" id="saveTpl">บันทึก</button>
        <button class="btn" id="resetTpl">รีเซ็ตเป็นค่าเริ่มต้น</button>
      </div>
    </div>
  </div>
</div>

<!-- Preview Modal -->
<div id="pvModal" class="no-print" style="position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;padding:20px">
  <div class="card" style="width:min(100%,1100px);max-height:90vh;overflow:auto">
    <div class="stack" style="justify-content:space-between;align-items:center"><strong>พรีวิว</strong><div class="stack"><select class="select" id="selTpl"><option>A4</option><option>A5</option><option>A6</option><option>ACC</option></select><button class="btn red" id="btnPrint">พิมพ์ / PDF</button><button class="btn" id="pvClose">ปิด</button></div></div>
    <div id="pvHost" style="margin-top:12px"></div>
  </div>
</div>

<script>
// ===== CONFIG (editable & persisted) =====
const DEF={
  sizes:{ A4:{w:210,h:297}, A5:{w:148,h:210}, A6:{w:105,h:148}, ACC:{w:99,h:35} },
  frame:12, inset:12, pgMargin:5, printScale:100
};
const loadCfg=()=>{try{return JSON.parse(localStorage.getItem('tpl_cfg'))||DEF}catch(e){return DEF}}
const saveCfg=(cfg)=>localStorage.setItem('tpl_cfg',JSON.stringify(cfg))
let CFG=loadCfg();

// inject dynamic CSS based on CFG
function applyTplCSS(){
  let css=`:root{--frame:${CFG.frame}mm;--inset:${CFG.inset}mm;--pg-margin:${CFG.pgMargin}mm;--print-scale:${(CFG.printScale/100).toFixed(3)};}`;
  // Tag size classes
  css+=`.tpl-A4{width:${CFG.sizes.A4.w}mm;height:${CFG.sizes.A4.h}mm}`;
  css+=`.tpl-A5{width:${CFG.sizes.A5.w}mm;height:${CFG.sizes.A5.h}mm}`;
  css+=`.tpl-A6{width:${CFG.sizes.A6.w}mm;height:${CFG.sizes.A6.h}mm}`;
  css+=`.tpl-ACC{width:${CFG.sizes.ACC.w}mm;height:${CFG.sizes.ACC.h}mm}`;
  // Sheet rows auto-rows should follow selected template; we'll compute inline styles per sheet at build time
  let el=document.getElementById('tplStyle'); if(!el){el=document.createElement('style'); el.id='tplStyle'; document.head.appendChild(el);} el.textContent=css;
}
applyTplCSS();

// ===== SAMPLE ROWS =====
const ROWS=[{ sku:'MP-00010', description:'iCon Pro Audio', details:'GoLive Pro...\nออดิโออินเตอร์เฟสสำหรับสตรีมมิ่งพร้อมรีโมทคอนโทรล\nคุณภาพเสียง 24-bit / 48kHz พร้อม DSP ในตัว (Reverb, EQ, Vocal Tune)\nแบตเตอรี่ในตัว 5000mAh ใช้งานได้สูงสุด 6 ชั่วโมง\nรองรับ Mic Input ทั้งแบบ mini-XLR (พร้อม 48V) และ 1/4 นิ้ว\nเชื่อมต่อ Bluetooth สำหรับเล่นเพลงและควบคุม', normal_price:7990, promo_price:5990, expire_date:'2099-09-09'}];

function fmt(n){return new Intl.NumberFormat('th-TH').format(Number(n||0))}
function dstr(d){try{const o=new Date(d);return String(o.getDate()).padStart(2,'0')+'-'+String(o.getMonth()+1).padStart(2,'0')+'-'+o.getFullYear()}catch(e){return d}}

// ===== TABLE =====
(function drawTable(){
  const t=document.createElement('table');
  t.innerHTML='<thead><tr><th>เลือก</th><th>Item No.</th><th>สินค้า</th><th>รายละเอียด</th><th>ราคาปกติ</th><th>โปร</th><th>Expire</th></tr></thead>';
  const tb=document.createElement('tbody');
  for(const r of ROWS){
    const bullets=(r.details||'').split(/\n|•/).filter(Boolean).slice(0,5).map(x=>'• '+x.trim()).join('<br>');
    const tr=document.createElement('tr');
    tr.innerHTML=`<td><input type="checkbox" data-sel="${r.sku}" checked></td><td>${r.sku}</td><td>${r.description}</td><td>${bullets}</td><td style="text-align:right">${fmt(r.normal_price)}</td><td style="text-align:right">${fmt(r.promo_price)}</td><td>${dstr(r.expire_date)}</td>`;
    tb.appendChild(tr);
  }
  t.appendChild(tb); document.getElementById('tableWrap').appendChild(t);
})();

// ===== RENDER TAG =====
function renderTag(r,tpl){
  const tag=document.createElement('div'); tag.className='tag tpl-'+tpl;
  tag.innerHTML=`<div class="frame"></div><div class="tag-inner"></div>`; const box=tag.querySelector('.tag-inner');
  const sku=document.createElement('div'); sku.className='sku'; sku.textContent=r.sku; box.appendChild(sku);
  const title=document.createElement('div'); title.className='title'; title.textContent=r.description; box.appendChild(title);
  const bullets=(r.details||'').split(/\n|•/).filter(Boolean).slice(0,5).map(x=>x.trim());
  const ul=document.createElement('ul'); ul.className='bullets'; ul.innerHTML=bullets.map(x=>`<li>${x}</li>`).join(''); box.appendChild(ul);
  const area=document.createElement('div'); area.className='price-area'; area.innerHTML=`<div class="expire">Expire : ${dstr(r.expire_date)}</div><div style="text-align:right"><div class="price-was">${fmt(r.normal_price)}.-</div><div class="price-now">${fmt(r.promo_price)}.-</div></div>`; box.appendChild(area);
  return tag;
}

// ===== PREVIEW/PRINT =====
function buildSheets(items,tpl){
  // Remove existing
  document.querySelectorAll('.print-root').forEach(n=>n.remove());
  const root=document.createElement('div'); root.className='print-root'; document.body.appendChild(root);

  const size=CFG.sizes[tpl];
  // Decide how many per row/col to fit A4 (210 x 297)
  const perCol=Math.max(1,Math.floor(210/size.w));
  const perRow=Math.max(1,Math.floor(297/size.h));
  const perPage=perCol*perRow;

  for(let i=0;i<items.length;i+=perPage){
    const sheet=document.createElement('div'); sheet.className='print-sheet';
    sheet.style.gridTemplateColumns=`repeat(${perCol}, ${size.w}mm)`;
    sheet.style.gridAutoRows=`${size.h}mm`;
    sheet.style.gap='0mm';
    for(let j=0;j<perPage && (i+j)<items.length;j++) sheet.appendChild(renderTag(items[i+j],tpl));
    root.appendChild(sheet);
  }
}

// ===== SETTINGS UI =====
const m=$=>document.getElementById($);
function openTpl(){
  m('tplModal').style.display='flex';
  m('wA4').value=CFG.sizes.A4.w; m('hA4').value=CFG.sizes.A4.h;
  m('wA5').value=CFG.sizes.A5.w; m('hA5').value=CFG.sizes.A5.h;
  m('wA6').value=CFG.sizes.A6.w; m('hA6').value=CFG.sizes.A6.h;
  m('wACC').value=CFG.sizes.ACC.w; m('hACC').value=CFG.sizes.ACC.h;
  m('frameMM').value=CFG.frame; m('insetMM').value=CFG.inset; m('pgMargin').value=CFG.pgMargin; m('printScale').value=CFG.printScale;
}
function saveTpl(){
  CFG={
    sizes:{
      A4:{w:+m('wA4').value,h:+m('hA4').value},
      A5:{w:+m('wA5').value,h:+m('hA5').value},
      A6:{w:+m('wA6').value,h:+m('hA6').value},
      ACC:{w:+m('wACC').value,h:+m('hACC').value}
    },
    frame:+m('frameMM').value,
    inset:+m('insetMM').value,
    pgMargin:+m('pgMargin').value,
    printScale:+m('printScale').value
  };
  saveCfg(CFG); applyTplCSS(); alert('บันทึกการตั้งค่าแล้ว'); m('tplModal').style.display='none';
}
function resetTpl(){ CFG=JSON.parse(JSON.stringify(DEF)); saveCfg(CFG); applyTplCSS(); openTpl(); }

m('btnTpl').onclick=openTpl; m('tplClose').onclick=()=>m('tplModal').style.display='none'; m('saveTpl').onclick=saveTpl; m('resetTpl').onclick=resetTpl;

// ===== PREVIEW EVENTS =====
const items=ROWS; // would be selection in full app
m('btnPreview').onclick=()=>{ m('pvModal').style.display='flex'; m('selTpl').value='A6'; buildSheets(items,'A6'); }
m('pvClose').onclick=()=>m('pvModal').style.display='none';
m('selTpl').onchange=e=>buildSheets(items,e.target.value);
m('btnPrint').onclick=()=>window.print();
</script>
</body>
</html>
