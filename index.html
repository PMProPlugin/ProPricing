<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ProPlugin ‚Ä¢ ProPricing</title>

<link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;600;700;800;900&family=Prompt:wght@400;600;700&display=swap" rel="stylesheet">

<script src="https://cdn.tailwindcss.com"></script>
<script>
  tailwind.config = {
    darkMode: 'class',
    theme: {
      extend: {
        fontFamily: { sans: ['Kanit','Prompt','system-ui','sans-serif'] },
        colors: { brand: { dark:'#0b0b0c', red:'#E11D2E' } },
        boxShadow: { soft: '0 6px 18px rgba(0,0,0,.25)' }
      }
    }
  }
</script>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx-populate/browser/xlsx-populate.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/litepicker/dist/litepicker.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/litepicker/dist/css/litepicker.css"/>


<style>
  :root { color-scheme: dark; }
  html,body{ height:100%; background:#0b0b0c }
  ::-webkit-scrollbar{width:10px;height:10px}::-webkit-scrollbar-thumb{background:#222;border-radius:10px}
  .oneline{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis }
  .text-elevate{ text-shadow:0 1px 2px rgba(0,0,0,.9),0 0 1px rgba(0,0,0,.7) }
  @media print { .no-print{display:none!important} .print-only{display:block} }
  
  .filter-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 18px;
    height: 18px;
    margin-left: 6px;
    border-radius: 4px;
    background-color: #333;
    border: 1px solid #555;
    transition: background-color 0.2s;
    vertical-align: middle;
  }
  .filter-btn:hover { background-color: #444; }
  .filter-btn.active { background-color: #E11D2E; border-color: #ff5566; }
  .filter-dropdown {
    display: none;
    position: absolute;
    z-index: 100;
    background-color: #18181b;
    border: 1px solid #555;
    border-radius: 8px;
    padding: 8px;
    margin-top: 4px;
    max-height: 300px;
    overflow-y: auto;
    box-shadow: 0 4px 12px rgba(0,0,0,0.5);
    min-width: 200px;
  }
  .filter-dropdown-content {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }
  .resizer {
    position: absolute;
    top: 0;
    right: 0;
    width: 5px;
    cursor: col-resize;
    user-select: none;
    height: 100%;
  }
  .resizer:hover, .resizing {
    background-color: #E11D2E;
  }
  table {
    table-layout: fixed;
    border-collapse: collapse;
  }
  table th, table td {
    border: 1px solid #3f3f46;
  }
  #productTHead { z-index: 20; }
  #productBody { position: relative; z-index: 1; }
  .style-btn {
    width: 28px; height: 28px; border-radius: 6px; border: 1px solid #555; background-color: #333;
    display: grid; place-items: center;
  }
  .style-btn.active { background-color: #E11D2E; border-color: #ff5566; }

  /* NEW: Notification System Styles */
  #toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; }
  .toast { padding: 12px 20px; border-radius: 8px; color: white; font-size: 14px; box-shadow: 0 4px 12px rgba(0,0,0,0.5); border: 1px solid #555; animation: toast-in 0.3s ease, toast-out 0.3s ease 2.7s; }
  .toast.info { background-color: #18181b; }
  .toast.success { background-color: #166534; border-color: #22c55e; }
  .toast.error { background-color: #991b1b; border-color: #ef4444; }
  @keyframes toast-in { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
  @keyframes toast-out { from { transform: translateX(0); opacity: 1; } to { transform: translateX(100%); opacity: 0; } }

  .confirm-overlay { position: fixed; inset: 0; background-color: rgba(0,0,0,0.7); backdrop-filter: blur(4px); z-index: 9990; display: grid; place-items: center; }
  .confirm-modal { background-color: #18181b; border: 1px solid #555; border-radius: 16px; padding: 24px; width: 100%; max-width: 400px; box-shadow: 0 8px 24px rgba(0,0,0,0.6); }

</style>
</head>

<body class="text-white font-sans">

<section id="setupView" class="hidden min-h-screen grid place-items-center">
  <div class="w-full max-w-md bg-zinc-900/80 border border-zinc-800 rounded-2xl p-8 shadow-soft">
    <div class="flex items-center gap-3 mb-6">
      <div class="w-11 h-11 rounded-xl bg-brand.red grid place-items-center text-xl font-extrabold">P</div>
      <div class="text-2xl font-semibold">First-Time Setup</div>
    </div>
    <div class="text-zinc-400 mb-4">Please create the primary 'host' account to begin.</div>
    <label class="text-sm text-zinc-400">Username</label>
    <input id="setupUser" class="w-full mt-1 px-4 py-3 rounded-2xl bg-zinc-900 border border-zinc-700" value="host" disabled />
    <label class="text-sm text-zinc-400 mt-4 block">Choose a strong password</label>
    <input id="setupPass" type="password" class="w-full mt-1 px-4 py-3 rounded-2xl bg-zinc-900 border border-zinc-700" placeholder="password" />
    <label class="text-sm text-zinc-400 mt-4 block">Confirm password</label>
    <input id="setupPassConfirm" type="password" class="w-full mt-1 px-4 py-3 rounded-2xl bg-zinc-900 border border-zinc-700" placeholder="confirm password" />
    <button id="btnCreateHost" class="mt-6 w-full py-3 rounded-2xl bg-brand.red hover:bg-red-600 border border-red-700 font-semibold">Create Host Account</button>
  </div>
</section>

<section id="loginView" class="hidden min-h-screen grid place-items-center">
  <div class="w-full max-w-md bg-zinc-900/80 border border-zinc-800 rounded-2xl p-8 shadow-soft">
    <div class="flex items-center gap-3 mb-6">
      <div class="w-11 h-11 rounded-xl bg-brand.red grid place-items-center text-xl font-extrabold">P</div>
      <div class="text-2xl font-semibold">ProPlugin ‚Ä¢ ProPricing</div>
    </div>
    <label class="text-sm text-zinc-400">Username</label>
    <input id="loginUser" class="w-full mt-1 px-4 py-3 rounded-2xl bg-zinc-900 border border-zinc-700 focus:outline-none focus:ring-2 focus:ring-brand.red" placeholder="username" />
    <label class="text-sm text-zinc-400 mt-4 block">Password</label>
    <input id="loginPass" type="password" class="w-full mt-1 px-4 py-3 rounded-2xl bg-zinc-900 border border-zinc-700 focus:outline-none focus:ring-2 focus:ring-brand.red" placeholder="password" />
    <button id="btnLogin" class="mt-6 w-full py-3 rounded-2xl bg-brand.red hover:bg-red-600 border border-red-700 font-semibold">Sign in</button>
  </div>
</section>

<section id="cloudSetupView" class="min-h-screen grid place-items-center">
  <div class="w-full max-w-md bg-zinc-900/80 border border-zinc-800 rounded-2xl p-8 shadow-soft">
    <div class="flex items-center gap-3 mb-6">
       <div class="w-11 h-11 rounded-xl bg-brand.red grid place-items-center text-xl font-extrabold">P</div>
      <div class="text-2xl font-semibold">Cloud Setup</div>
    </div>
    <p class="text-zinc-400 mb-4">Please set up GitHub Gist for cloud storage. You can create a new Gist or load from an existing one.</p>
    <label class="text-sm text-zinc-400">GitHub Personal Access Token (scope: gist)</label>
    <input id="cloudToken" type="password" class="w-full mt-1 px-4 py-3 rounded-2xl bg-zinc-900 border border-zinc-700" placeholder="ghp_..." />
    <label class="text-sm text-zinc-400 mt-4 block">Gist ID (optional for new Gist)</label>
    <input id="cloudGistId" class="w-full mt-1 px-4 py-3 rounded-2xl bg-zinc-900 border border-zinc-700" placeholder="e.g. a1b2c3d4..." />
    <div class="flex flex-col gap-4 mt-6">
      <button id="btnCloudCreate" class="w-full py-3 rounded-2xl bg-brand.red hover:bg-red-600 border border-red-700 font-semibold">Create New Gist</button>
      <button id="btnCloudLoad" class="w-full py-3 rounded-2xl bg-zinc-900 hover:bg-zinc-800 border border-zinc-700 font-semibold">Load from Existing Gist</button>
    </div>
  </div>
</section>

<section id="appView" class="hidden min-h-screen">
  <header class="sticky top-0 z-40 bg-brand.dark/95 backdrop-blur border-b border-zinc-800">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center gap-3">
      <div class="flex items-center gap-3">
        <div id="logoBox" class="w-10 h-10 rounded-xl bg-zinc-100 text-brand.dark font-black grid place-items-center overflow-hidden select-none">
          <span id="logoFallback">P</span>
          <img id="logoImg" class="hidden w-full h-full object-contain" alt="logo">
        </div>
        <div class="text-xl sm:text-2xl font-semibold tracking-wide">ProPricing</div>
        <span id="roleBadge" class="ml-2 text-xs px-2 py-1 rounded bg-zinc-800 border border-zinc-700"></span>
      </div>
      <div class="ml-auto flex items-center gap-2">
        <button id="btnSettings" class="hidden px-3 py-2 rounded-2xl bg-zinc-900 hover:bg-zinc-800 border border-zinc-700 text-sm">‚öôÔ∏è</button>
        <button id="btnLogout" class="px-3 py-2 rounded-2xl bg-[#FF0000] hover:bg-zinc-800 border border-zinc-700 text-sm">Sign out</button>
      </div>
    </div>
    <div class="max-w-7xl mx-auto px-4 pb-4 flex flex-col lg:flex-row gap-3">
<div class="relative flex-1">
  <input id="searchInput"
    class="w-full text-xl sm:text-2xl px-5 py-4 rounded-2xl border border-zinc-700 bg-white text-black focus:outline-none focus:ring-2 focus:ring-brand.red"
    placeholder="Search (SKU / Product Name)" />
  <div class="absolute right-4 top-1/2 -translate-y-1/2 text-black">üîé</div>
</div>
      <select id="channelSelect" class="px-4 py-3 rounded-2xl bg-zinc-900 border border-zinc-700 focus:outline-none focus:ring-2 focus:ring-brand.red"></select>
      <div class="px-3 py-2 rounded-2xl bg-zinc-950 border border-zinc-700 flex items-center gap-2">
        <span class="text-sm text-zinc-400">Select Expire Date</span>
        <input id="dateRangePicker" class="px-3 py-2 rounded-xl bg-zinc-900 border border-zinc-700 w-64 text-center">
        <input id="dateStart" type="date" class="hidden">
        <input id="dateEnd" type="date" class="hidden">
      </div>
      <button id="btnNewProduct" class="px-5 py-3 rounded-2xl bg-zinc-800 hover:bg-zinc-700 border border-zinc-700 font-semibold">Add +</button>
      <button id="btnPrintModal" class="px-5 py-3 rounded-2xl bg-brand.red hover:bg-red-600 border border-red-700 font-semibold">Print</button>
    </div>
  </header>
  <main class="max-w-7xl mx-auto px-4 py-6">
    <div class="overflow-auto border border-zinc-800 rounded-2xl">
      <table class="w-full text-sm">
        <thead id="productTHead" class="bg-zinc-900/70 border-b-2 border-zinc-700 sticky top-0"></thead>
        <tbody id="productBody" class="[&>tr:nth-child(odd)]:bg-zinc-800/60"></tbody>
      </table>
    </div>
    <div id="pagination" class="mt-4 flex justify-center items-center gap-2"></div>
  </main>
</section>

<div id="settingsPanel" class="hidden fixed inset-0 z-[60] bg-black/60 backdrop-blur-sm">
  <div class="absolute inset-4 bg-zinc-950/95 border border-zinc-800 rounded-2xl overflow-hidden grid grid-cols-[260px_1fr]">
    <aside class="bg-zinc-900/60 border-r border-zinc-800 p-3 space-y-2">
      <div class="text-sm text-zinc-400 px-2">Settings</div>
      <button data-tab="data" class="set-tab only-host-admin w-full text-left px-3 py-2 rounded-2xl bg-zinc-900 hover:bg-zinc-800 border border-zinc-700">Manage Master Data</button>
      <button data-tab="promo" class="set-tab only-host-admin w-full text-left px-3 py-2 rounded-2xl bg-zinc-900 hover:bg-zinc-800 border border-zinc-700">Manage Promotion</button>
      <button data-tab="logo" class="set-tab only-host w-full text-left px-3 py-2 rounded-2xl bg-zinc-900 hover:bg-zinc-800 border border-zinc-700">Manage Logo</button>
      <button data-tab="dealer" class="set-tab only-host-admin w-full text-left px-3 py-2 rounded-2xl bg-zinc-900 hover:bg-zinc-800 border border-zinc-700">Dealer Settings</button>
      <button data-tab="users" class="set-tab only-host-admin w-full text-left px-3 py-2 rounded-2xl bg-zinc-900 hover:bg-zinc-800 border border-zinc-700">User Management</button>
      <button data-tab="templates" class="set-tab only-host w-full text-left px-3 py-2 rounded-2xl bg-zinc-900 hover:bg-zinc-800 border border-zinc-700">Template Management</button>
      <button data-tab="cloud" class="set-tab only-host w-full text-left px-3 py-2 rounded-2xl bg-zinc-900 hover:bg-zinc-800 border border-zinc-700">Cloud Sync</button>
      <button data-tab="history" class="set-tab only-host w-full text-left px-3 py-2 rounded-2xl bg-zinc-900 hover:bg-zinc-800 border border-zinc-700">Usage History</button>
      <div class="absolute bottom-3 left-3 right-3">
        <button id="btnCloseSettings" class="w-full text-sm px-2 py-1.5 rounded-xl bg-brand.red hover:bg-red-600 border border-red-700">Close</button>
      </div>
    </aside>
    <section id="settingsContent" class="p-6 overflow-auto"></section>
  </div>
</div>

<div id="editorModal" class="hidden fixed inset-0 z-[70] bg-black/70">
  <div class="absolute inset-6 bg-zinc-950 border border-zinc-800 rounded-2xl overflow-hidden">
    <div class="flex items-center justify-between p-4 border-b border-zinc-800">
      <div id="editorTitle" class="text-xl font-semibold">Edit Product</div>
      <button id="btnCloseEditor" class="px-3 py-1 rounded-2xl bg-zinc-900 hover:bg-zinc-800 border border-zinc-700">Close</button>
    </div>
    <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-6 overflow-auto h-[calc(100%-100px)]">
      <div class="space-y-4">
        <div><label class="text-sm text-zinc-400">SKU</label><input id="edSku" class="w-full mt-1 px-3 py-2 rounded-2xl bg-zinc-900 border border-zinc-700"></div>
        <div><label class="text-sm text-zinc-400">Description</label><input id="edDesc" class="w-full mt-1 px-3 py-2 rounded-2xl bg-zinc-900 border border-zinc-700"></div>
        <div><label class="text-sm text-zinc-400">Details</label><textarea id="edDetails" rows="4" class="w-full mt-1 px-3 py-2 rounded-2xl bg-zinc-900 border border-zinc-700"></textarea></div>
        <div><label class="text-sm text-zinc-400">Brand</label><input id="edBrand" class="w-full mt-1 px-3 py-2 rounded-2xl bg-zinc-900 border border-zinc-700"></div>
        <div><label class="text-sm text-zinc-400">Category</label><input id="edCategory" class="w-full mt-1 px-3 py-2 rounded-2xl bg-zinc-900 border border-zinc-700"></div>
      </div>
      <div class="space-y-4">
        <div class="grid grid-cols-2 gap-4">
          <div><label class="text-sm text-zinc-400">Costs</label><input id="edCosts" type="number" step="0.01" class="w-full mt-1 px-3 py-2 rounded-2xl bg-zinc-900 border border-zinc-700"></div>
          <div><label class="text-sm text-zinc-400">Normal Price</label><input id="edNormal" type="number" step="0.01" class="w-full mt-1 px-3 py-2 rounded-2xl bg-zinc-900 border border-zinc-700"></div>
          <div><label class="text-sm text-zinc-400">Promotion Price</label><input id="edPromo" type="number" step="0.01" class="w-full mt-1 px-3 py-2 rounded-2xl bg-zinc-900 border border-zinc-700"></div>
           <div><label class="text-sm text-zinc-400">Expires Date</label><input id="edExpire" type="date" class="w-full mt-1 px-3 py-2 rounded-2xl bg-zinc-900 border border-zinc-700"></div>
          <div><label class="text-sm text-zinc-400">Marketplace Price</label><input id="edMarket" type="number" step="0.01" class="w-full mt-1 px-3 py-2 rounded-2xl bg-zinc-900 border border-zinc-700"></div>
          <div><label class="text-sm text-zinc-400"><span id="edLabelT1">Dealer T1</span></label><input id="edT1" type="number" step="0.01" class="w-full mt-1 px-3 py-2 rounded-2xl bg-zinc-900 border border-zinc-700"></div>
          <div><label class="text-sm text-zinc-400"><span id="edLabelT2">Dealer T2</span></label><input id="edT2" type="number" step="0.01" class="w-full mt-1 px-3 py-2 rounded-2xl bg-zinc-900 border border-zinc-700"></div>
          <div><label class="text-sm text-zinc-400"><span id="edLabelT3">Dealer T3</span></label><input id="edT3" type="number" step="0.01" class="w-full mt-1 px-3 py-2 rounded-2xl bg-zinc-900 border border-zinc-700"></div>
        </div>
        <button id="btnSaveEd" class="w-full mt-2 py-3 rounded-2xl bg-brand.red hover:bg-red-600 border border-red-700 font-semibold">Save</button>
      </div>
    </div>
  </div>
</div>

<div id="printModal" class="hidden fixed inset-0 z-[80] bg-black/70">
  <div class="absolute inset-6 bg-zinc-950 border border-zinc-800 rounded-2xl grid grid-rows-[auto_1fr] grid-cols-[480px_1fr] min-h-0">
    <div class="col-span-2 sticky top-0 z-10 bg-zinc-950 border-b border-zinc-800 p-4 flex items-center justify-between">
      <div class="text-xl font-semibold">Print Price Tags</div>
      <button id="btnClosePrintModal" class="px-3 py-1.5 rounded-2xl bg-zinc-900 hover:bg-zinc-800 border border-zinc-700">Close</button>
    </div>
    <div class="p-4 border-r border-zinc-800 space-y-4 overflow-auto">
      <div class="sticky top-0 bg-zinc-950 border-b border-zinc-800 pb-3 z-10">
        <div class="grid grid-cols-[1fr_auto] gap-2">
          <select id="printTemplate" class="w-full px-3 py-2 rounded-2xl bg-zinc-900 border border-zinc-700"></select>
          <button id="btnOpenPrint" class="px-4 py-2 rounded-2xl bg-brand.red hover:bg-red-600 border border-red-700 font-semibold">Open Print Page</button>
        </div>
        <div class="mt-3 px-3 py-2 rounded-2xl bg-zinc-900 border border-zinc-800 flex items-center gap-2">
          <input id="printSearch" class="flex-1 bg-transparent outline-none" placeholder="Search in list‚Ä¶">
          <label class="text-sm"><input type="checkbox" id="printCheckAll"> <span class="text-zinc-300">Select all</span></label>
        </div>
        <div class="text-sm text-zinc-400 mt-2">Select products and set qty per SKU</div>
      </div>
      <div id="printList" class="space-y-2 pt-2"></div>
      <div id="printSummary" class="text-sm text-zinc-400"></div>
    </div>
    <div class="flex flex-col w-full h-full min-h-0 min-w-0 p-4 overflow-hidden">
      <div class="text-sm text-zinc-400 mb-2 shrink-0">Live preview of the first selected item</div>
      <div id="previewBox" class="bg-zinc-900 rounded-2xl border border-zinc-800 flex-1 w-full h-full min-h-0 min-w-0 relative flex items-center justify-center overflow-hidden"></div>
    </div>
  </div>
</div>

<div id="toast-container"></div>
<div id="confirm-container"></div>

<script>
/* ================= CORE STATE / STORAGE ================= */
const LS = {
  // MODIFIED: Using sessionStorage for token for slightly better security.
  // WARNING: This is still NOT safe for public hosting. The token is accessible
  // via JavaScript during the session. Use this app locally or on a trusted internal network.
  GIST_ID: 'pp_cloud_gist_id_v2',
  TOKEN: 'pp_cloud_token_v2', // The key remains the same, but we'll use sessionStorage to store it.
  LAST_USER: 'pp_last_user_v2'
};
const defaultDealerNames = {t1:'Dealer T1', t2:'Dealer T2', t3:'Dealer T3'};
const Channels = ['Flagship','Marketplace','Dealer'];

const sampleProducts = [{
  sku:'MP-00010',
  brand:'iCon Pro Audio',
  category:'Audio Interface',
  description:'iCon Pro Audio GoLive Pro',
  details:'Audio interface for live streaming with remote control\\n24-bit/48kHz with onboard DSP (Reverb, EQ, Vocal Tune)\\nBuilt-in 5000mAh battery up to 6 hours\\nMic input mini-XLR (48V) & 1/4-inch\\nBluetooth for music & control',
  costs:4200, normalPrice:7990, promoPrice:5990, expiresDate:'2099-09-09',
  marketplacePrice:5990, dealer1:5600, dealer2:5400, dealer3:5200
}];

const defaultMargin = { top: 0, right: 0, bottom: 0, left: 0 };
const defaultFontStyle = { fw: 'normal', fs: 'normal', td: 'none' };
const defaultTextStyles = { fs: 14, color: '#ffffff', margin: defaultMargin, ...defaultFontStyle };

const defaultAppState = {
    version: 3.4, // Version bump
    products: sampleProducts,
    templates: [
        { id:'t-a4',  name:'A4', kind:'A4',  showLogo:true, imageData:null, logoStyles: { size: 64, margin: { top: 10, right: 10, bottom: 10, left: 10 } },
          styles:{ sku:{...defaultTextStyles, fs:16}, description:{...defaultTextStyles, fs:30}, details:{...defaultTextStyles, fs:14}, price:{...defaultTextStyles, fs:72}, oldPrice:{...defaultTextStyles, fs:20, color:'#ff4d4f'}, expire:{...defaultTextStyles, fs:13} } },
        { id:'t-a5',  name:'A5)', kind:'A5',  showLogo:true, imageData:null, logoStyles: { size: 50, margin: { top: 8, right: 8, bottom: 8, left: 8 } },
          styles:{ sku:{...defaultTextStyles, fs:14}, description:{...defaultTextStyles, fs:26}, details:{...defaultTextStyles, fs:13}, price:{...defaultTextStyles, fs:60}, oldPrice:{...defaultTextStyles, fs:18, color:'#ff4d4f'}, expire:{...defaultTextStyles, fs:12} } },
        { id:'t-a6',  name:'A6', kind:'A6',  showLogo:true, imageData:null, logoStyles: { size: 40, margin: { top: 6, right: 6, bottom: 6, left: 6 } },
          styles:{ sku:{...defaultTextStyles, fs:12}, description:{...defaultTextStyles, fs:22}, details:{...defaultTextStyles, fs:12}, price:{...defaultTextStyles, fs:48}, oldPrice:{...defaultTextStyles, fs:16, color:'#ff4d4f'}, expire:{...defaultTextStyles, fs:11} } },
        { id:'t-acc', name:'Accessories', kind:'ACC', showLogo:true, imageData:null, logoStyles: { size: 30, margin: { top: 4, right: 4, bottom: 4, left: 4 } },
          styles:{ sku:{...defaultTextStyles, fs:11, margin:{...defaultMargin, top:2}}, description:{...defaultTextStyles, fs:15, align:'center'}, details:{...defaultTextStyles, fs:10, color:'#cccccc'}, price:{...defaultTextStyles, fs:22}, oldPrice:{...defaultTextStyles, fs:12, color:'#B91C1C'}, expire:{...defaultTextStyles, fs:10} } },
        { id:'t-card', name:'Card', kind:'CARD', showLogo:true, imageData:null, logoStyles: { size: 24, margin: { top: 4, right: 4, bottom: 4, left: 4 } },
          styles:{ sku:{...defaultTextStyles, fs:10, margin:{...defaultMargin, top:2}}, description:{...defaultTextStyles, fs:14, align:'center'}, details:{...defaultTextStyles, fs:9, color:'#cccccc'}, price:{...defaultTextStyles, fs:20}, oldPrice:{...defaultTextStyles, fs:11, color:'#B91C1C'}, expire:{...defaultTextStyles, fs:9} } }
    ],
    dealerNames: defaultDealerNames,
    users: [],
    logo: '',
    logs: []
};


let appData = null;
let currentUser = null;
let editingIndex = -1;
let currentPage = 1;
const itemsPerPage = 20;

let sortState = { key: 'sku', direction: 'asc' };
let columnFilters = {};

/* ================= UTILITIES ================= */
const $  = (s,r=document)=>r.querySelector(s);
const $$ = (s,r=document)=>Array.from(r.querySelectorAll(s));
const money = n => isFinite(n) && n > 0 ? n.toLocaleString('th-TH',{maximumFractionDigits:0}) + ' ‡∏ø' :'' ;
const toDateInput = v => v ? new Date(v).toISOString().slice(0,10) : '';
const fromExcelDate = v => {
  if (v instanceof Date) return v.toISOString().slice(0,10);
  if (typeof v==='number'){ const d=new Date(Math.round((v-25569)*86400*1000)); return d.toISOString().slice(0,10); }
  if (typeof v==='string' && /^\d{4}-\d{2}-\d{2}$/.test(v)) return v;
  return '';
};
const gpPct = (price,cost)=> (cost > 0 && price > 0 ? ((price - cost) / cost) * 100 : 0);
async function hashPassword(password) {
  const encoder = new TextEncoder();
  const data = encoder.encode(password);
  const hashBuffer = await crypto.subtle.digest('SHA-256', data);
  const hashArray = Array.from(new Uint8Array(hashBuffer));
  return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
}
const ellip = (s,max=40)=> !s ? '' : (s.length<=max? s : s.slice(0,max-3)+'...');

// NEW: Debounce function for performance on large datasets
const debounce = (func, delay = 300) => {
    let timeoutId;
    return (...args) => {
        clearTimeout(timeoutId);
        timeoutId = setTimeout(() => {
            func.apply(this, args);
        }, delay);
    };
};

/* NEW: Notification System */
function showToast(message, type = 'info') { // types: info, success, error
    const container = $('#toast-container');
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.textContent = message;
    container.appendChild(toast);
    setTimeout(() => {
        toast.remove();
    }, 3000);
}

function showConfirm(title, message) {
    return new Promise(resolve => {
        const container = $('#confirm-container');
        const modalHTML = `
            <div class="confirm-overlay">
                <div class="confirm-modal">
                    <h3 class="text-xl font-bold mb-2">${title}</h3>
                    <p class="text-zinc-400 mb-6">${message}</p>
                    <div class="flex justify-end gap-3">
                        <button id="confirm-cancel" class="px-4 py-2 rounded-xl bg-zinc-800 hover:bg-zinc-700 border border-zinc-700">Cancel</button>
                        <button id="confirm-ok" class="px-4 py-2 rounded-xl bg-brand.red hover:bg-red-600 border border-red-700">Confirm</button>
                    </div>
                </div>
            </div>
        `;
        container.innerHTML = modalHTML;

        const overlay = $('.confirm-overlay');
        const btnOk = $('#confirm-ok');
        const btnCancel = $('#confirm-cancel');

        const cleanup = () => container.innerHTML = '';

        btnOk.onclick = () => {
            cleanup();
            resolve(true);
        };
        btnCancel.onclick = () => {
            cleanup();
            resolve(false);
        };
        overlay.onclick = (e) => {
            if (e.target === overlay) {
                cleanup();
                resolve(false);
            }
        };
    });
}

function log(action, meta = '') {
  if (!appData) return;
  if(!appData.logs) appData.logs = [];
  appData.logs.unshift({ ts: new Date().toISOString(), user: currentUser?.username || '-', action, meta });
  if (appData.logs.length > 3000) appData.logs.pop();
}

function updateLocalDataAndSave(newData) {
    if (newData) appData = newData;
    renderTableHeader();
    renderTable();
    applyDealerNamesToUI();
    if (appData.logo) {
        $('#logoImg').src = appData.logo;
        $('#logoImg').classList.remove('hidden');
        $('#logoFallback').classList.add('hidden');
    } else {
        $('#logoImg').classList.add('hidden');
        $('#logoFallback').classList.remove('hidden');
    }
    const gistId = localStorage.getItem(LS.GIST_ID);
    const token = localStorage.getItem(LS.TOKEN); // MODIFIED
    if (currentUser?.role === 'Host' && gistId && token) {
        cloudSave(gistId, token).catch(e => {
            console.error("Auto-save failed:", e);
            showToast('Auto-save to cloud failed.', 'error');
        });
    }
}

/* ================= CLOUD SYNC (GitHub Gist) ================= */
async function gistRequest(method, path, body, token){
  if(!token) throw new Error('GitHub Token is required for this operation.');
  const headers = { 'Accept':'application/vnd.github+json', 'Authorization': 'Bearer '+token };
  if(body) headers['Content-Type']='application/json';
  const res = await fetch('https://api.github.com'+path, { method, headers, body: body?JSON.stringify(body):undefined });
  if(!res.ok){ const t=await res.text(); throw new Error(`GitHub ${res.status}: ${t}`); }
  return res.json();
}
async function cloudCreateGist(token, appState){
  const resp = await gistRequest('POST','/gists',{ public:false, files:{ 'proplugin-data.json':{ content: JSON.stringify(appState) } } }, token);
  localStorage.setItem(LS.GIST_ID, resp.id);
  localStorage.setItem(LS.TOKEN, token); // MODIFIED
  return resp.id;
}
async function cloudSave(gistId, token){
  if(!gistId) throw new Error('Gist ID is required');
  const body = { files:{ 'proplugin-data.json':{ content: JSON.stringify(appData) } } };
  await gistRequest('PATCH','/gists/'+gistId, body, token);
}
async function cloudLoad(gistId, token){
  if (!gistId) throw new Error('Gist ID is required');
  const resp = await gistRequest('GET', '/gists/' + gistId, null, token);
  const file = resp.files?.['proplugin-data.json'];
  if (!file) throw new Error('proplugin-data.json not found in gist');
  const data = JSON.parse(file.content);
  appData = data;
  localStorage.setItem(LS.GIST_ID, gistId);
  localStorage.setItem(LS.TOKEN, token); // MODIFIED
}

/* ================= AUTH ================= */
function performLogin(user) {
    currentUser = user;
    localStorage.setItem(LS.LAST_USER, user.username);
    columnFilters = {};

    $('#setupView').classList.add('hidden');
    $('#loginView').classList.add('hidden');
    $('#cloudSetupView').classList.add('hidden');
    $('#appView').classList.remove('hidden');

    $('#roleBadge').textContent = `${currentUser.role} ‚Ä¢ ${currentUser.username}`;
    
    initFiltersForUser();
    bindAppEvents();
    updateLocalDataAndSave();
}

async function login(){
  const u = $('#loginUser').value.trim();
  const p = $('#loginPass').value;
  if (!appData || !appData.users) {
      showToast('Application data is not loaded. Please set up cloud storage.', 'error');
      return;
  }
  const pHash = await hashPassword(p);
  const found = appData.users.find(x => x.username === u && x.passwordHash === pHash);
  if(!found) {
      showToast('Invalid credentials.', 'error');
      return;
  }

  performLogin(found);
}

function logout(){
  log('logout');
  currentUser = null;
  columnFilters = {};
  localStorage.removeItem(LS.LAST_USER);
  localStorage.removeItem(LS.TOKEN); // MODIFIED
  
  $('#appView').classList.add('hidden');
  $('#loginView').classList.remove('hidden');
  $('#loginUser').value = '';
  $('#loginPass').value = '';
}

/* ================= UI VISIBILITY ================= */
function updateCostsVisibility() {
    if (!currentUser) return;
    const canSee = currentUser.canSeeCosts;
    $$('.col-costs').forEach(el => el.classList.toggle('hidden', !canSee));
}

function updateRoleBasedVisibility() {
    if (!currentUser) return;
    const canEdit = ['Host', 'Admin'].includes(currentUser.role);
    $$('.col-actions').forEach(el => el.classList.toggle('hidden', !canEdit));
}

function updateColumnVisibility(){
  const ch = $('#channelSelect').value;
  const show = {
      normal: ch === 'Flagship', promo: ch === 'Flagship', expire: ch === 'Flagship',
      market: ch === 'Marketplace', marketgp: ch === 'Marketplace',
      t1: ch === 'Dealer', gp1: ch === 'Dealer', t2: ch === 'Dealer',
      gp2: ch === 'Dealer', t3: ch === 'Dealer', gp3: ch === 'Dealer',
      details: ch === 'Flagship'
  };
  const map={ 'col-details':show.details, 'col-normal':show.normal,'col-promo':show.promo,'col-expire':show.expire,'col-market':show.market,'col-marketgp':show.marketgp,'col-t1':show.t1,'col-gp1':show.gp1,'col-t2':show.t2,'col-gp2':show.gp2,'col-t3':show.t3,'col-gp3':show.gp3 };
  Object.entries(map).forEach(([cls,v])=> $$('.'+cls).forEach(el=>el.classList.toggle('hidden',!v)));
  updateRoleBasedVisibility();
  updateCostsVisibility();
}

function initFiltersForUser(){
  const sel=$('#channelSelect');
  const currentChannel = sel.value;
  sel.innerHTML='';
  (currentUser.channels || []).forEach(ch=>{ const o=document.createElement('option'); o.textContent=ch; o.value = ch; sel.appendChild(o); });
  sel.value = currentChannel && currentUser.channels.includes(currentChannel) ? currentChannel : (currentUser.channels[0] || '');
  $('#btnSettings').classList.toggle('hidden', !['Host','Admin'].includes(currentUser.role));
  $('#btnPrintModal').classList.toggle('hidden', !currentUser.canPrint);
  updateColumnVisibility();
}

/* ================= APPLY DEALER NAMES ================= */
function applyDealerNamesToUI(){
    const dealerNames = appData?.dealerNames || defaultDealerNames;
    const uiIds = ['lblT1', 'lblT2', 'lblT3', 'edLabelT1', 'edLabelT2', 'edLabelT3'];
    uiIds.forEach(id => {
        const el = $(`#${id}`);
        if (el) {
            if (id.includes('T1')) el.textContent = dealerNames.t1 || 'Dealer T1';
            if (id.includes('T2')) el.textContent = dealerNames.t2 || 'Dealer T2';
            if (id.includes('T3')) el.textContent = dealerNames.t3 || 'Dealer T3';
        }
    });
}

/* ================= TABLE & PAGINATION ================= */
function filteredProducts(){
  if (!appData) return [];
  const q=$('#searchInput').value.trim().toLowerCase();
  const ds=$('#dateStart').value, de=$('#dateEnd').value;
  const isFlagship = $('#channelSelect').value==='Flagship';

  const filtered = (appData.products || []).filter(p=>{
    const generalSearchHit = !q || (p.sku||'').toLowerCase().includes(q) || (p.description||'').toLowerCase().includes(q);
    const columnFilterHit = Object.keys(columnFilters).every(key => {
        if (!columnFilters[key] || columnFilters[key].size === 0) return true;
        const value = p[key] || '';
        return columnFilters[key].has(value.toString());
    });
    let dateOk = true;
    if(isFlagship && (ds||de)){
      const ex = p.expiresDate ? new Date(p.expiresDate) : null;
      if(!ex) { dateOk=false; }
      else {
        if(ds && ex < new Date(ds)) dateOk=false;
        if(de && ex > new Date(de+'T23:59:59')) dateOk=false;
      }
    }
    return generalSearchHit && columnFilterHit && dateOk;
  });

  // Sorting logic
  const { key: sortKey, direction } = sortState;
  const dataKeyMap = {
      normal: 'normalPrice', promo: 'promoPrice', expire: 'expiresDate', market: 'marketplacePrice',
      t1: 'dealer1', t2: 'dealer2', t3: 'dealer3'
  };
  const dataKey = dataKeyMap[sortKey] || sortKey;

  filtered.sort((a, b) => {
      const valA = a[dataKey];
      const valB = b[dataKey];

      if (valA == null || valA === '') return 1;
      if (valB == null || valB === '') return -1;

      let comparison = 0;
      if (typeof valA === 'number' && typeof valB === 'number') {
          comparison = valA - valB;
      } else {
          comparison = String(valA).localeCompare(String(valB), undefined, { numeric: true, sensitivity: 'base' });
      }

      return direction === 'asc' ? comparison : -comparison;
  });

  return filtered;
}

function renderPagination(totalItems) {
  const pageBox = $('#pagination');
  pageBox.innerHTML = '';
  const totalPages = Math.ceil(totalItems / itemsPerPage);
  if (totalPages <= 1) return;
  for (let i = 1; i <= totalPages; i++) {
    const btn = document.createElement('button');
    btn.textContent = i;
    btn.className = `px-3 py-1 rounded-lg text-sm border ${currentPage === i ? 'bg-brand.red border-red-700' : 'bg-zinc-800 border-zinc-700 hover:bg-zinc-700'}`;
    btn.onclick = () => { currentPage = i; renderTable(); };
    pageBox.appendChild(btn);
  }
}

function renderTableHeader() {
    const thead = $('#productTHead');
    const columns = [
        { key: 'sku', label: 'SKU', width: '120px', sortable: true },
        { key: 'description', label: 'Description', width: '200px', sortable: true },
        { key: 'details', label: 'Details', width: '200px', class: 'col-details', sortable: false },
        { key: 'brand', label: 'Brand', width: '120px', sortable: true },
        { key: 'category', label: 'Category', width: '120px', sortable: true },
        { key: 'costs', label: 'Costs', width: '80px', class: 'col-costs', sortable: true },
        { key: 'normal', label: 'Normal', width: '80px', class: 'col-normal', sortable: true },
        { key: 'promo', label: 'Promotion', width: '80px', class: 'col-promo', sortable: true },
        { key: 'expire', label: 'Expire Date', width: '100px', class: 'col-expire', sortable: true },
        { key: 'market', label: 'Marketplace', width: '100px', class: 'col-market', sortable: true },
        { key: 'marketgp', label: 'Market GP%', width: '100px', class: 'col-marketgp', sortable: false },
        { key: 't1', label: `<span id="lblT1">Dealer T1</span>`, width: '100px', class: 'col-t1', sortable: true },
        { key: 'gp1', label: '(GP%)', width: '75px', class: 'col-gp1', sortable: false },
        { key: 't2', label: `<span id="lblT2">Dealer T2</span>`, width: '100px', class: 'col-t2', sortable: true },
        { key: 'gp2', label: '(GP%)', width: '75px', class: 'col-gp2', sortable: false },
        { key: 't3', label: `<span id="lblT3">Dealer T3</span>`, width: '100px', class: 'col-t3', sortable: true },
        { key: 'gp3', label: '(GP%)', width: '75px', class: 'col-gp3', sortable: false },
        { key: 'actions', label: 'Actions', width: '100px', class: 'col-actions', sortable: false }
    ];
    
    let headerHTML = `<tr class="[&>th]:px-3 [&>th]:py-3 text-left">`;
    columns.forEach(col => {
        let thClass = col.class || '';
        let thAttrs = '';
        let label = col.label;

        if (col.sortable) {
            thClass += ' cursor-pointer hover:bg-zinc-800 transition-colors';
            thAttrs += ` data-sort-key="${col.key}"`;
            if (sortState.key === col.key) {
                label += sortState.direction === 'asc' ? ' <span class="text-zinc-400">‚ñ≤</span>' : ' <span class="text-zinc-400">‚ñº</span>';
            }
        }
        
        let content;
        if (['sku', 'description', 'brand', 'category'].includes(col.key)) {
            const isActive = columnFilters[col.key] && columnFilters[col.key].size > 0;
            content = `<div class="flex items-center justify-between w-full">
              <div>${label}</div>
              <button class="filter-btn ${isActive ? 'active' : ''}" data-filter-key="${col.key}">‚ñº</button>
            </div>
            <div id="filter-dropdown-${col.key}" class="filter-dropdown"></div>`;
        } else {
            content = label;
        }

        headerHTML += `<th class="${thClass}" style="width:${col.width}; position: relative;" ${thAttrs}>
            ${content}
            <div class="resizer"></div>
        </th>`;
    });
    headerHTML += `</tr>`;
    thead.innerHTML = headerHTML;
    makeTableResizable();
}

function renderTable(){
  const body=$('#productBody'); body.innerHTML='';
  if(!appData) return;
  
  const allFiltered = filteredProducts();
  const paginatedItems = allFiltered.slice((currentPage - 1) * itemsPerPage, currentPage * itemsPerPage);
  const today = new Date();
  today.setHours(0, 0, 0, 0);

  paginatedItems.forEach(p=>{
    const tr=document.createElement('tr');
    tr.className='hover:bg-zinc-700/70';
    let isPromoExpired = p.expiresDate && new Date(p.expiresDate) < today;
    const displayedPromoPrice = isPromoExpired ? '-' : money(p.promoPrice);
    const promoPriceTitle = isPromoExpired ? 'Promotion Expired' : money(p.promoPrice);
    const gpM = gpPct(p.marketplacePrice, p.costs);
    const gp1 = gpPct(p.dealer1, p.costs);
    const gp2 = gpPct(p.dealer2, p.costs);
    const gp3 = gpPct(p.dealer3, p.costs);
    const detailsOneLine=(p.details||'').replace(/\\n+/g,' ‚Ä¢ ');

    tr.innerHTML = `
      <td class="px-3 py-3 oneline" title="${p.sku}">${p.sku || '-'}</td>
      <td class="px-3 py-3 oneline" title="${p.description}">${p.description || '-'}</td>
      <td class="px-3 py-3 oneline col-details" title="${detailsOneLine}">${detailsOneLine}</td>
      <td class="px-3 py-3 oneline" style="color: #E11D2E;" title="${p.brand}">${p.brand || '-'}</td>
      <td class="px-3 py-3 oneline" title="${p.category}">${p.category || '-'}</td>
      <td class="px-3 py-3 col-costs oneline" title="${money(p.costs)}">${money(p.costs)}</td>
      <td class="px-3 py-3 col-normal oneline" title="${money(p.normalPrice)}">${money(p.normalPrice)}</td>
      <td class="px-3 py-3 col-promo oneline" title="${promoPriceTitle}" style="color:${isPromoExpired ? '#666' : '#E11D2E'};"><span style="text-decoration:${isPromoExpired ? 'line-through' : 'none'};">${displayedPromoPrice}</span></td>
      <td class="px-3 py-3 col-expire oneline" title="${toDateInput(p.expiresDate)}" style="color:${isPromoExpired ? '#666' : '#E11D2E'};">${toDateInput(p.expiresDate)}</td>
      <td class="px-3 py-3 col-market oneline" title="${money(p.marketplacePrice)}">${money(p.marketplacePrice)}</td>
      <td class="px-3 py-3 col-marketgp oneline" style="color: #22c55e;" title="(${gpM.toFixed(1)}%)">(${gpM.toFixed(1)}%)</td>
      <td class="px-3 py-3 col-t1 oneline" title="${money(p.dealer1)}">${money(p.dealer1)}</td>
      <td class="px-3 py-3 col-gp1 oneline" style="color: #009900;" title="(${gp1.toFixed(1)}%)">(${gp1.toFixed(1)}%)</td>
      <td class="px-3 py-3 col-t2 oneline" title="${money(p.dealer2)}">${money(p.dealer2)}</td>
      <td class="px-3 py-3 col-gp2 oneline" style="color: #00CC00;" title="(${gp2.toFixed(1)}%)">(${gp2.toFixed(1)}%)</td>
      <td class="px-3 py-3 col-t3 oneline" title="${money(p.dealer3)}">${money(p.dealer3)}</td>
      <td class="px-3 py-3 col-gp3 oneline" style="color: #00FF00;" title="(${gp3.toFixed(1)}%)">(${gp3.toFixed(1)}%)</td>
      <td class="px-3 py-3 col-actions">
          <div class="flex items-center gap-2">
            <button class="px-2 py-1 rounded-xl bg-zinc-900 hover:bg-zinc-800 border border-zinc-700 text-xs" data-edit="${p.sku}">Edit</button>
            <button title="Delete" class="px-2 py-1 rounded-xl bg-transparent border border-red-700 hover:bg-red-700/20 text-xs" data-del="${p.sku}">‚ùå</button>
          </div>
      </td>
    `;
    body.appendChild(tr);
  });
  renderPagination(allFiltered.length);
  bindTableEvents();
  updateColumnVisibility();
}


/* ================= EDITOR ================= */
function openEditor(sku = null) {
  if(!['Host','Admin'].includes(currentUser.role)) return;
  if (sku) {
    editingIndex = appData.products.findIndex(x=>x.sku===sku);
    const p = appData.products[editingIndex];
    $('#editorTitle').textContent = 'Edit Product';
    $('#edSku').value = p.sku;
    $('#edSku').disabled = true;
    $('#edDesc').value = p.description || '';
    $('#edDetails').value = p.details || '';
    $('#edBrand').value = p.brand || '';
    $('#edCategory').value = p.category || '';
    $('#edExpire').value = toDateInput(p.expiresDate);
    $('#edCosts').value = p.costs || '';
    $('#edNormal').value = p.normalPrice || '';
    $('#edPromo').value = p.promoPrice || '';
    $('#edMarket').value = p.marketplacePrice || '';
    $('#edT1').value = p.dealer1 || '';
    $('#edT2').value = p.dealer2 || '';
    $('#edT3').value = p.dealer3 || '';
  } else {
    editingIndex = -1;
    $('#editorTitle').textContent = 'Add New Product';
    ['edSku', 'edDesc', 'edDetails', 'edBrand', 'edCategory', 'edExpire', 'edCosts', 'edNormal', 'edPromo', 'edMarket', 'edT1', 'edT2', 'edT3'].forEach(id => $(`#${id}`).value = '');
     $('#edSku').disabled = false;
  }
  applyDealerNamesToUI();
  $('#editorModal').classList.remove('hidden');
}
function closeEditor(){ $('#editorModal').classList.add('hidden'); }
async function saveEditor() {
  const sku = $('#edSku').value.trim();
  if (!sku) { 
    showToast('SKU is required.', 'error');
    return;
  }
  const newProductData = {
    sku: sku,
    description:$('#edDesc').value.trim(), 
    details:$('#edDetails').value.trim(),
    brand:$('#edBrand').value.trim(),
    category:$('#edCategory').value.trim(),
    expiresDate:$('#edExpire').value||'', 
    costs:parseFloat($('#edCosts').value)||0,
    normalPrice:parseFloat($('#edNormal').value)||0, 
    promoPrice:parseFloat($('#edPromo').value)||0,
    marketplacePrice:parseFloat($('#edMarket').value)||0, 
    dealer1:parseFloat($('#edT1').value)||0,
    dealer2:parseFloat($('#edT2').value)||0, 
    dealer3:parseFloat($('#edT3').value)||0
  };

  if (editingIndex > -1) {
    const oldProduct = appData.products[editingIndex];
    appData.products[editingIndex] = {...oldProduct, ...newProductData};
    log('edit_product', sku);
  } else {
    if (appData.products.some(p => p.sku === sku)) {
      showToast(`SKU "${sku}" already exists.`, 'error');
      return;
    }
    appData.products.unshift(newProductData);
    log('add_product', sku);
  }
  closeEditor();
  showToast(`Product ${sku} saved successfully.`, 'success');
  updateLocalDataAndSave();
}

/* ================= SETTINGS ================= */
function openSettings(tab){
  if(!['Host','Admin'].includes(currentUser.role)) return;
  $('#settingsPanel').classList.remove('hidden');
  renderSettings(tab);
}
function fileToBase64(f){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(f); }); }

function renderSettings(tab){
  const box=$('#settingsContent');
  $$('.set-tab').forEach(b=>b.classList.remove('ring-2','ring-brand.red'));
  const btn=$(`.set-tab[data-tab="${tab}"]`); if(btn) btn.classList.add('ring-2','ring-brand.red');
  const isHost=currentUser.role==='Host';
  const isAdmin=currentUser.role==='Admin';
  $$('.only-host').forEach(el=>el.classList.toggle('hidden', !isHost));
  $$('.only-host-admin').forEach(el=>el.classList.toggle('hidden', !(isHost||isAdmin)));

  if(tab==='data'){
    box.innerHTML=`
      <div class="text-2xl font-semibold mb-2">Manage Master Data</div>
      <div class="text-zinc-400 mb-4">Import or Export the main product data file.</div>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="p-4 rounded-2xl border border-zinc-800 bg-zinc-900/40">
          <div class="font-semibold mb-2">Import Master File (.xlsx)</div>
          <input id="fileImportMaster" type="file" accept=".xlsx,.xls" class="w-full">
          <p class="text-xs text-zinc-400 mt-2">Columns: A SKU, B Desc, C Details, D Brand, E Category, F Costs, G Normal, H Marketplace, I D1, J D2, K D3</p>
          <button id="btnDoImportMaster" class="mt-4 px-4 py-2 rounded-2xl bg-brand.red hover:bg-red-600 border border-red-700">Import Master</button>
        </div>
        <div class="p-4 rounded-2xl border border-zinc-800 bg-zinc-900/40">
          <div class="font-semibold mb-2">Export Master File (.xlsx)</div>
          <button id="btnExportMaster" class="px-4 py-2 rounded-2xl bg-zinc-900 hover:bg-zinc-800 border border-zinc-700">Export Master</button>
          <p class="text-xs text-zinc-400 mt-2">Exports a file compatible with the import format (without GP% columns).</p>
        </div>
      </div>
    `;
    bindSettingsEvents(tab);
  }
  if(tab==='promo'){
    box.innerHTML=`
      <div class="text-2xl font-semibold mb-2">Manage Promotion Data</div>
      <div class="text-zinc-400 mb-4">Import or Export promotion-specific data.</div>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="p-4 rounded-2xl border border-zinc-800 bg-zinc-900/40">
          <div class="font-semibold mb-2">Import Promotion File (.xlsx)</div>
          <input id="fileImportPromo" type="file" accept=".xlsx,.xls" class="w-full">
          <p class="text-xs text-zinc-400 mt-2">Columns: A SKU, B Desc, C Normal, D Promotion, E Expires</p>
          <button id="btnDoImportPromo" class="mt-4 px-4 py-2 rounded-2xl bg-brand.red hover:bg-red-600 border border-red-700">Import Promotion</button>
        </div>
        <div class="p-4 rounded-2xl border border-zinc-800 bg-zinc-900/40 space-y-3">
          <div>
            <div class="font-semibold mb-2">Export Promotion File (.xlsx)</div>
            <button id="btnExportPromo" class="px-4 py-2 rounded-2xl bg-zinc-900 hover:bg-zinc-800 border border-zinc-700">Export Promotion</button>
          </div>
          <div>
            <div class="font-semibold mb-2">Promotion Report</div>
            <button id="btnReportExpired" class="px-4 py-2 rounded-2xl bg-zinc-900 hover:bg-zinc-800 border border-zinc-700">Report Promotion Expire</button>
          </div>
        </div>
      </div>
    `;
    bindSettingsEvents(tab);
  }
  if(tab==='logo'){
    if(!isHost){ box.innerHTML='<div class="text-zinc-400">Host only.</div>'; return; }
    const base64 = appData.logo || '';
    box.innerHTML=`
      <div class="text-2xl font-semibold mb-2">Manage Logo</div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="p-4 rounded-2xl border border-zinc-800 bg-zinc-900/40">
          <div class="font-semibold mb-2">Upload logo</div>
          <input type="file" id="logoFile" accept="image/*">
          <p class="text-xs text-zinc-400 mt-2">PNG/JPG/SVG. Used on default templates.</p>
          <button id="btnSaveLogo" class="mt-4 px-4 py-2 rounded-2xl bg-brand.red hover:bg-red-600 border border-red-700">Save</button>
          <button id="btnRemoveLogo" class="mt-4 ml-2 px-4 py-2 rounded-2xl bg-zinc-900 hover:bg-zinc-800 border border-zinc-700">Remove</button>
        </div>
        <div class="p-4 rounded-2xl border border-zinc-800 bg-zinc-900/40">
          <div class="font-semibold mb-2">Preview</div>
          <div class="h-40 w-40 bg-white rounded-xl overflow-hidden grid place-items-center p-2">
            ${base64?`<img src="${base64}" class="max-h-full max-w-full object-contain">`:'<div class="text-zinc-800 text-4xl font-black">P</div>'}
          </div>
        </div>
      </div>
    `;
    bindSettingsEvents(tab);
  }
  if(tab==='dealer'){
     if(!(isHost||isAdmin)){ box.innerHTML='<div class="text-zinc-400">Not allowed.</div>'; return; }
    const names = appData.dealerNames || {};
    box.innerHTML=`
      <div class="text-2xl font-semibold mb-4">Dealer Settings</div>
      <div class="p-4 rounded-2xl border border-zinc-800 bg-zinc-900/40 space-y-3">
        <div class="grid md:grid-cols-3 gap-3">
          <div><label class="text-xs text-zinc-400">Name for Dealer T1</label><input id="nameT1" class="mt-1 w-full px-3 py-2 rounded-xl bg-zinc-900 border border-zinc-700" value="${names.t1||'Dealer T1'}"></div>
          <div><label class="text-xs text-zinc-400">Name for Dealer T2</label><input id="nameT2" class="mt-1 w-full px-3 py-2 rounded-xl bg-zinc-900 border border-zinc-700" value="${names.t2||'Dealer T2'}"></div>
          <div><label class="text-xs text-zinc-400">Name for Dealer T3</label><input id="nameT3" class="mt-1 w-full px-3 py-2 rounded-xl bg-zinc-900 border border-zinc-700" value="${names.t3||'Dealer T3'}"></div>
        </div>
        <button id="btnSaveDealer" class="mt-2 px-4 py-2 rounded-2xl bg-brand.red hover:bg-red-600 border border-red-700">Save</button>
      </div>
    `;
    bindSettingsEvents(tab);
  }
  if(tab==='users'){
    if(!(isHost||isAdmin)){ box.innerHTML='<div class="text-zinc-400">Not allowed.</div>'; return; }
    box.innerHTML=`
      <div class="flex items-center justify-between">
        <div class="text-2xl font-semibold mb-2">User Management</div>
        <button id="btnAddUser" class="px-3 py-2 rounded-2xl bg-brand.red hover:bg-red-600 border border-red-700">Add User</button>
      </div>
      <div id="addUserBox" class="hidden p-4 mb-4 rounded-2xl border border-zinc-800 bg-zinc-900/40">
        <div class="grid md:grid-cols-2 gap-3">
          <input id="nuName" placeholder="username" class="px-3 py-2 rounded-xl bg-zinc-900 border border-zinc-700">
          <input id="nuPass" placeholder="password" type="password" class="px-3 py-2 rounded-xl bg-zinc-900 border border-zinc-700">
          <select id="nuRole" class="px-3 py-2 rounded-xl bg-zinc-900 border border-zinc-700">
            <option>User</option><option>Admin</option>${isHost?'<option>Host</option>':''}
          </select>
          <div class="flex items-center gap-4">
            <label class="text-sm"><input type="checkbox" id="nuSeeCosts"> See Costs</label>
            <label class="text-sm"><input type="checkbox" id="nuCanPrint" checked> Can Print</label>
          </div>
          <div class="md:col-span-2">
            ${Channels.map(ch=>`<label class="mr-3 text-sm"><input type="checkbox" class="nuCh" value="${ch}" ${ch==='Flagship'?'checked':''}> ${ch}</label>`).join('')}
          </div>
        </div>
        <div class="mt-3"><button id="nuCreate" class="px-4 py-2 rounded-2xl bg-zinc-900 hover:bg-zinc-800 border border-zinc-700">Create</button></div>
      </div>
      <div class="overflow-auto border border-zinc-800 rounded-2xl">
        <table class="w-full text-sm">
          <thead class="bg-zinc-900/70 border-b border-zinc-800">
            <tr class="[&>th]:px-3 [&>th]:py-2 text-left">
              <th style="width: 15%;">User</th>
              <th style="width: 12%;">Role</th>
              <th style="width: 28%;">Channels</th>
              <th style="width: 10%;">See Costs</th>
              <th style="width: 10%;">Can Print</th>
              <th style="width: 12%;">New Pwd</th>
              <th style="width: 13%;"></th>
            </tr>
          </thead>
          <tbody id="userRows"></tbody>
        </table>
      </div>
    `;
    
    const tbody=$('#userRows'); tbody.innerHTML='';
    (appData.users || []).forEach((u,i)=>{
        if (isAdmin && (u.role === 'Host' || u.username === 'host')) return; // Admin cannot see Host
      const tr=document.createElement('tr'); tr.className='border-b border-zinc-800';
      tr.innerHTML=`
        <td class="px-3 py-2 oneline">${u.username}</td>
        <td class="px-3 py-2">
          <select data-role-idx="${i}" class="w-full px-2 py-1 rounded-xl bg-zinc-900 border border-zinc-700" ${u.username==='host'?'disabled':''}>
          ${(isHost?['Host','Admin','User']:['Admin','User']).map(r=>`<option ${u.role===r?'selected':''}>${r}</option>`).join('')}
          </select>
        </td>
        <td class="px-3 py-2 oneline">
          ${Channels.map(ch=>`<label class="mr-2"><input type="checkbox" data-ch-idx="${i}|${ch}" ${(u.channels||[]).includes(ch)?'checked':''}> <span class="text-xs">${ch}</span></label>`).join('')}
        </td>
        <td class="px-3 py-2 text-center"><input type="checkbox" data-cost-idx="${i}" ${u.canSeeCosts?'checked':''}></td>
        <td class="px-3 py-2 text-center"><input type="checkbox" data-print-idx="${i}" ${u.canPrint?'checked':''}></td>
        <td class="px-3 py-2"><input type="text" data-pass-idx="${i}"
  ${isAdmin && (u.username==='host' || u.role==='Host') ? 'disabled' : ''}
  class="w-full px-2 py-1 rounded-xl bg-zinc-900 border border-zinc-700">
</td>
        <td class="px-3 py-2">
          <button class="px-2 py-1 rounded-xl bg-zinc-900 hover:bg-zinc-800 border border-zinc-700 text-xs" data-saveu-idx="${i}">Save</button>
          ${u.username==='host' ? '' : `<button class="ml-2 px-2 py-1 rounded-xl bg-transparent border border-red-700 hover:bg-red-700/20 text-xs" data-delu-idx="${i}">‚ùå</button>`}
        </td>
      `;
      tbody.appendChild(tr);
    });
    bindSettingsEvents(tab);
  }
  if(tab==='templates'){
    if(!isHost){ box.innerHTML='<div class="text-zinc-400">Host only.</div>'; return; }
    box.innerHTML = `
      <div class="flex items-center justify-between mb-4">
        <div>
            <div class="text-2xl font-semibold">Template Management</div>
            <div class="text-sm text-zinc-400">Select a template to edit, or create a new one.</div>
        </div>
        <button id="btnShowAddTpl" class="px-3 py-2 rounded-2xl bg-brand.red hover:bg-red-600 border border-red-700">Add New Template</button>
      </div>
      <div id="addTplBox" class="hidden p-4 mb-4 rounded-2xl border border-zinc-800 bg-zinc-900/40 space-y-3">
        <h3 class="font-semibold">Create New Template</h3>
        <div>
          <label class="text-sm text-zinc-400">Template Base</label>
          <select id="newTplKind" class="w-full mt-1 px-3 py-2 rounded-xl bg-zinc-900 border border-zinc-700"></select>
        </div>
        <div>
          <label class="text-sm text-zinc-400">Template Name</label>
          <input id="newTplName" class="w-full mt-1 px-3 py-2 rounded-xl bg-zinc-900 border border-zinc-700" placeholder="e.g., My Custom A4">
        </div>
        <div class="flex gap-2">
          <button id="btnCreateTpl" class="px-4 py-2 rounded-xl bg-brand.red hover:bg-red-600 border border-red-700">Create</button>
          <button id="btnCancelTpl" class="px-4 py-2 rounded-xl bg-zinc-800 hover:bg-zinc-700 border border-zinc-700">Cancel</button>
        </div>
      </div>
      <select id="templateSelect" class="w-full max-w-sm px-3 py-2 rounded-xl bg-zinc-900 border border-zinc-700 mb-6"></select>
      <div id="templateEditorContainer"></div>
    `;
    
    const tplSelect = $('#templateSelect');
    tplSelect.innerHTML = '<option value="">-- Select a template to edit --</option>';
    (appData.templates || []).forEach((t, i) => {
      const opt = document.createElement('option');
      opt.value = i;
      opt.textContent = t.name;
      tplSelect.appendChild(opt);
    });
    
    tplSelect.onchange = () => {
        const idx = tplSelect.value;
        if(idx !== "") {
            renderTemplateEditor(parseInt(idx));
        } else {
            $('#templateEditorContainer').innerHTML = '';
        }
    };
    bindSettingsEvents(tab);
  }
  if(tab==='cloud'){
    if(!isHost){ box.innerHTML='<div class="text-zinc-400">Host only.</div>'; return; }
    const gistId = localStorage.getItem(LS.GIST_ID) || '';
    box.innerHTML=`
      <div class="text-2xl font-semibold mb-2">Cloud Sync (GitHub Gist)</div>
      <p class="text-sm text-zinc-400 mb-4">Current Gist ID: ${gistId || 'Not set'}</p>
      <button id="btnCloudLoadRefresh" class="px-3 py-2 rounded-2xl bg-zinc-900 hover:bg-zinc-800 border border-zinc-700 font-semibold">Refresh from Cloud</button>
      <p class="text-xs text-zinc-400 mt-2">Data will be automatically saved on every change.</p>
    `;
    bindSettingsEvents(tab);
  }
  if(tab==='history'){
     if(!isHost){ box.innerHTML='<div class="text-zinc-400">Host only.</div>'; return; }
    const logs=appData.logs || [];
    box.innerHTML=`
      <div class="text-2xl font-semibold mb-2">Usage History</div>
      <div class="max-h-[65vh] overflow-auto border border-zinc-800 rounded-2xl">
        <table class="min-w-[700px] w-full text-sm">
          <thead class="bg-zinc-900/70 border-b border-zinc-800">
            <tr class="[&>th]:px-3 [&>th]:py-2 text-left"><th>Time</th><th>User</th><th>Action</th><th>Details</th></tr>
          </thead>
          <tbody>${logs.map(l=>`<tr class="border-b border-zinc-800"><td class="px-3 py-2">${new Date(l.ts).toLocaleString('th-TH')}</td><td class="px-3 py-2">${l.user}</td><td class="px-3 py-2">${l.action}</td><td class="px-3 py-2 text-zinc-400">${l.meta||''}</td></tr>`).join('')}</tbody>
        </table>
      </div>
    `;
  }
}

// NEW: Renders the editor for a single template
function renderTemplateEditor(i) {
    const box = $('#templateEditorContainer');
    const t = appData.templates[i];
    if(!t) {
        box.innerHTML = '<p class="text-zinc-500">Template not found.</p>';
        return;
    }

    t.logoStyles = t.logoStyles || { size: 64, margin: { top: 10, right: 10, bottom: 10, left: 10 } };
    if(typeof t.logoStyles.margin !== 'object') t.logoStyles.margin = { top: t.logoStyles.margin, right: t.logoStyles.margin, bottom:0, left:0 };
    t.styles = t.styles || {};
    ['sku','description','details','price','oldPrice','expire'].forEach(k=>{
      t.styles[k] = t.styles[k] || { ...defaultTextStyles };
      if(typeof t.styles[k].margin !== 'object') t.styles[k].margin = { top: t.styles[k].mt || 0, right:0, bottom:0, left:0 };
      t.styles[k].fw = t.styles[k].fw || 'normal';
      t.styles[k].fst = t.styles[k].fst || 'normal';
      t.styles[k].td = t.styles[k].td || 'none';
    });

    const editorHTML = `
        <div class="p-4 rounded-2xl border border-zinc-800 bg-zinc-900/40">
            <div class="flex justify-between items-start">
              <input data-name-tpl="${i}" value="${t.name||'Untitled Template'}" class="bg-transparent text-white text-lg font-semibold px-2 py-1 outline-none border-b border-zinc-700 focus:border-brand.red">
              <button class="ml-2 px-3 py-1 rounded-2xl bg-zinc-900 hover:bg-zinc-800 border border-zinc-700" data-del-tpl="${i}">Delete</button>
            </div>
            <div class="text-xs text-zinc-400 mb-3">ID: ${t.id||'-'} ‚Ä¢ Kind: ${t.kind||'-'}</div>
            <div class="grid grid-cols-2 gap-4">
              <div>
                <div class="text-sm font-semibold mb-2">Background Image</div>
                <img src="${t.imageData||''}" alt="template" class="w-full rounded-lg border border-zinc-700 my-2 object-contain max-h-32 ${t.imageData?'':'hidden'}">
                <div class="${t.imageData?'hidden':''} text-xs text-zinc-500">No background image</div>
                <label class="w-full text-center block mt-2 px-3 py-2 rounded-2xl bg-zinc-800 hover:bg-zinc-700 border border-zinc-700 cursor-pointer">
                  <input type="file" data-img-tpl="${i}" accept="image/png, image/jpeg" class="hidden">
                  Upload/Change Image
                </label>
              </div>
              <div>
                <div class="text-sm font-semibold mb-2">Logo Settings</div>
                <label class="flex items-center gap-2 text-sm"><input type="checkbox" data-logo-tpl="${i}" ${t.showLogo?'checked':''}> Show logo</label>
                <div class="grid grid-cols-2 gap-2 mt-2">
                  <div><label class="text-xs text-zinc-400">Size (px)</label><input type="number" step="1" data-logosize-tpl="${i}" value="${t.logoStyles.size}" class="w-full px-2 py-1 rounded-xl bg-zinc-950 border border-zinc-800"></div>
                  <div><label class="text-xs text-zinc-400">Margin Top</label><input type="number" step="1" data-logomargintop-tpl="${i}" value="${t.logoStyles.margin.top}" class="w-full px-2 py-1 rounded-xl bg-zinc-950 border border-zinc-800"></div>
                  <div></div><div><label class="text-xs text-zinc-400">Margin Right</label><input type="number" step="1" data-logomarginright-tpl="${i}" value="${t.logoStyles.margin.right}" class="w-full px-2 py-1 rounded-xl bg-zinc-950 border border-zinc-800"></div>
                </div>
              </div>
            </div>
            <div class="grid grid-cols-2 gap-3 mt-4">
              ${['sku','description','details','price','oldPrice','expire'].map(k=>`
                <div class="p-3 rounded-xl bg-zinc-900 border border-zinc-800 space-y-2">
                  <div class="text-xs text-zinc-400 capitalize">${k.replace('oldPrice','Old Price')}</div>
                  <div class="grid grid-cols-2 gap-2">
                    <div><label class="text-xs">Font size</label><input type="number" step="1" data-val-tpl="${i}|${k}|fs" value="${t.styles[k].fs}" class="w-full px-2 py-1 rounded-xl bg-zinc-950 border border-zinc-800"></div>
                    <div><label class="text-xs">Color</label><input type="color" data-val-tpl="${i}|${k}|color" value="${t.styles[k].color}" class="w-full h-8 rounded-xl bg-zinc-950 border border-zinc-800"></div>
                  </div>
                  <div>
                    <label class="text-xs">Margin (T-R-B-L)</label>
                    <div class="grid grid-cols-4 gap-1">
                      <input type="number" step="1" placeholder="T" data-val-tpl="${i}|${k}|margin|top" value="${t.styles[k].margin.top}" class="w-full px-1 py-1 text-center rounded-md bg-zinc-950 border border-zinc-800">
                      <input type="number" step="1" placeholder="R" data-val-tpl="${i}|${k}|margin|right" value="${t.styles[k].margin.right}" class="w-full px-1 py-1 text-center rounded-md bg-zinc-950 border border-zinc-800">
                      <input type="number" step="1" placeholder="B" data-val-tpl="${i}|${k}|margin|bottom" value="${t.styles[k].margin.bottom}" class="w-full px-1 py-1 text-center rounded-md bg-zinc-950 border border-zinc-800">
                      <input type="number" step="1" placeholder="L" data-val-tpl="${i}|${k}|margin|left" value="${t.styles[k].margin.left}" class="w-full px-1 py-1 text-center rounded-md bg-zinc-950 border border-zinc-800">
                    </div>
                  </div>
                  <div>
                    <label class="text-xs">Font Style</label>
                    <div class="grid grid-cols-4 gap-1">
                      <button data-style-tpl="${i}|${k}|fw|bold" class="style-btn ${t.styles[k].fw === 'bold' ? 'active':''}"><b>B</b></button>
                      <button data-style-tpl="${i}|${k}|fst|italic" class="style-btn ${t.styles[k].fst === 'italic' ? 'active':''}"><i>I</i></button>
                      <button data-style-tpl="${i}|${k}|td|underline" class="style-btn ${t.styles[k].td.includes('underline') ? 'active':''}"><u>U</u></button>
                      <button data-style-tpl="${i}|${k}|td|line-through" class="style-btn ${t.styles[k].td.includes('line-through') ? 'active':''}"><s>S</s></button>
                    </div>
                  </div>
                </div>
              `).join('')}
            </div>
            <button class="mt-4 w-full px-3 py-2 rounded-2xl bg-brand.red hover:bg-red-600 border border-red-700" data-savetpl-idx="${i}">Save Template</button>
        </div>
    `;
    box.innerHTML = editorHTML;
    bindSettingsEvents('templates'); // Re-bind events for the new elements
}

/* ================= IMPORT / EXPORT ================= */
async function doImportMaster(){
  const fi=$('#fileImportMaster'); if(!fi.files[0]) { showToast('Please choose a file first.', 'error'); return; }
  try {
    const data=await fi.files[0].arrayBuffer();
    const wb=XLSX.read(data,{type:'array'}); const ws=wb.Sheets[wb.SheetNames[0]];
    const rows=XLSX.utils.sheet_to_json(ws,{header:1,defval:''});
    let headerRowIndex = rows.findIndex(row => (row[0] || '').toString().toLowerCase().trim() === 'sku');
    if (headerRowIndex === -1) { showToast('Cannot find header row "SKU".', 'error'); return; }
    const start=headerRowIndex + 1;
    const newItems=[], existingSkus = new Set(appData.products.map(p => p.sku));
    let skippedCount = 0;
    for(let i=start;i<rows.length;i++){
      const r=rows[i]; const sku = (r[0]||'').toString().trim(); if(!sku) continue;
      if (existingSkus.has(sku)) { skippedCount++; continue; }
      existingSkus.add(sku);
      newItems.push({
        sku,
        description: (r[1] || '').toString().trim(), details: (r[2] || '').toString().trim(),
        brand: (r[3] || '').toString().trim(), category: (r[4] || '').toString().trim(),
        costs: parseFloat(r[5] || 0) || 0, normalPrice: parseFloat(r[6] || 0) || 0,
        marketplacePrice: parseFloat(r[7] || 0) || 0, dealer1: parseFloat(r[8] || 0) || 0,
        dealer2: parseFloat(r[9] || 0) || 0, dealer3: parseFloat(r[10] || 0) || 0,
        promoPrice: 0, expiresDate: ''
      });
    }
    if(!newItems.length && skippedCount === 0) { showToast('No new valid products found to import.', 'info'); return; }
    appData.products=[...newItems, ...appData.products];
    log('import_master', `${newItems.length} rows`);
    showToast(`Import complete. Added: ${newItems.length}, Skipped: ${skippedCount}`, 'success');
    updateLocalDataAndSave();
  } catch(e){ showToast('An error occurred during import: ' + e.message, 'error'); }
}
async function doExportMaster(){
  const wb=await XlsxPopulate.fromBlankAsync(); const sh=wb.sheet(0).name('MasterPriceData');
  const header=['SKU','Description','Details','Brand','Category','Costs','Normal Price','Marketplace Price','Dealer T1','Dealer T2','Dealer T3'];
  const dataRows = (appData.products || []).map(p=>[
    p.sku, p.description, p.details, p.brand, p.category, p.costs, p.normalPrice,
    p.marketplacePrice, p.dealer1, p.dealer2, p.dealer3
  ]);
  sh.cell('A1').value([header,...dataRows]);
  sh.row(1).style({bold:true});
  if(dataRows.length > 0) sh.range(`F2:K${dataRows.length+1}`).style({fill:'FFFFFFCC'});
  [15,30,40,20,20,12,14,16,14,14,14].forEach((w,i)=>sh.column(i+1).width(w));
  const blob=await wb.outputAsync();
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='master_price_data.xlsx'; a.click(); a.remove(); URL.revokeObjectURL(url);
  log('export_master', `${appData.products.length} rows`);
}
async function doImportPromo() {
    const fi = $('#fileImportPromo'); if (!fi.files[0]) { showToast('Please choose a file first.', 'error'); return; }
    try {
        const data = await fi.files[0].arrayBuffer();
        const wb = XLSX.read(data, { type: 'array' }); const ws = wb.Sheets[wb.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(ws, { header: 1, defval: '' });
        let headerRowIndex = rows.findIndex(row => (row[0] || '').toString().toLowerCase().trim() === 'sku');
        if (headerRowIndex === -1) { showToast('Cannot find header row "SKU".', 'error'); return; }
        const start = headerRowIndex + 1;
        let updatedCount = 0; let notFoundCount = 0;
        const productMap = new Map(appData.products.map(p => [p.sku, p]));
        for (let i = start; i < rows.length; i++) {
            const r = rows[i]; const sku = (r[0] || '').toString().trim(); if (!sku) continue;
            const product = productMap.get(sku);
            if (product) {
                product.promoPrice = parseFloat(r[3] || 0) || 0;
                product.expiresDate = fromExcelDate(r[4] || '');
                updatedCount++;
            } else { notFoundCount++; }
        }
        log('import_promo', `${updatedCount} rows updated`);
        showToast(`Promo import complete. Updated: ${updatedCount}, Not Found: ${notFoundCount}`, 'success');
        updateLocalDataAndSave();
    } catch(e){ showToast('An error occurred during import: ' + e.message, 'error'); }
}
async function doExportPromo() {
    const wb = await XlsxPopulate.fromBlankAsync(); const sh = wb.sheet(0).name('PromotionData');
    const header = ['SKU', 'Description', 'Normal Price', 'Promotion Price', 'Expires Date', 'Promotion GP%'];
    const dataRows = (appData.products || []).map(p => [
        p.sku, p.description, p.normalPrice, p.promoPrice,
        p.expiresDate ? toDateInput(p.expiresDate) : '', +gpPct(p.promoPrice, p.costs).toFixed(2)
    ]);
    sh.cell('A1').value([header, ...dataRows]);
    sh.row(1).style({ bold: true });
    if(dataRows.length > 0) sh.range(`D2:E${dataRows.length+1}`).style({fill:'FFFFFF99'});
    [15, 30, 14, 16, 16, 14].forEach((w, i) => sh.column(i + 1).width(w));
    const blob = await wb.outputAsync();
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download = 'promotion_data.xlsx'; a.click(); a.remove(); URL.revokeObjectURL(url);
    log('export_promo', `${appData.products.length} rows`);
}
async function showExpiredPromoReport() {
    const today = new Date(); today.setHours(0, 0, 0, 0);
    const expiredProducts = (appData.products || []).filter(p => p.expiresDate && new Date(p.expiresDate) < today);
    if (expiredProducts.length === 0) {
        showToast('No expired promotions found.', 'info');
        return;
    }
    const reportText = expiredProducts
        .map(p => `SKU: ${p.sku}, Desc: ${ellip(p.description, 40)}, Expired: ${toDateInput(p.expiresDate)}`)
        .join('\n');
    await showConfirm('Expired Promotions Report', `Found ${expiredProducts.length} expired items. The list is long and will be shown in a system dialog.`);
    alert(`--- Expired Promotions Report ---\n\n${reportText}`);
    log('report_expired_promo', `${expiredProducts.length} items`);
}

/* ================= PRINT FLOW & OTHERS ================= */
function togglePrintModal(show){ $('#printModal').classList.toggle('hidden', !show); }
function buildPrintList(){
  const box=$('#printList'); box.innerHTML='';
  const items=filteredProducts();
  const frag=document.createDocumentFragment();
  items.forEach(p=>{
    const row=document.createElement('div');
    row.className='flex items-center gap-3 bg-zinc-900/60 border border-zinc-800 rounded-2xl p-2';
    row.innerHTML=`
      <label class="flex items-center gap-2 w-6"><input type="checkbox" data-sel="${p.sku}"></label>
      <div class="flex-1">
        <div class="font-medium oneline" title="${p.sku}">${p.sku}</div>
        <div class="text-xs text-zinc-400 oneline" title="${p.description}">${ellip(p.description, 46)}</div>
      </div>
      <div class="flex items-center gap-1">
        <span class="text-xs text-zinc-400">Qty</span>
        <input type="number" min="1" value="1" data-qty="${p.sku}" class="w-20 px-2 py-1 rounded-xl bg-zinc-950 border border-zinc-800">
      </div>
    `;
    frag.appendChild(row);
  });
  box.appendChild(frag);
  $('#printCheckAll').checked=false;
  $('#printCheckAll').onchange=()=> $$('#printList input[type="checkbox"]').forEach(c=>c.checked=$('#printCheckAll').checked);
  $('#printSearch').oninput=()=>{
    const q=$('#printSearch').value.toLowerCase();
    $$('#printList > div').forEach(div=>{
      const textContent = div.textContent.toLowerCase();
      div.style.display = textContent.includes(q) ? '' : 'none';
    });
  };
  updatePrintSummary();
  $$('#printList input').forEach(i=>i.oninput=updatePrintSummary);
}
function updatePrintSummary(){
  const selected=$$('#printList input[type="checkbox"]:checked');
  let count=0; selected.forEach(c=>{ const sku=c.dataset.sel; const qty=parseInt($(`[data-qty="${sku}"]`).value)||0; count+=qty; });
  $('#printSummary').textContent = `${selected.length} SKUs selected ‚Ä¢ ${count} tags total`;
}
function fillTemplateDropdown(){
  const dd=$('#printTemplate'); dd.innerHTML='';
  (appData.templates || []).forEach(t=>{ const o=document.createElement('option'); o.value=t.id; o.textContent=t.name; dd.appendChild(o); });
  dd.onchange=()=>{ 
    const firstSelectedSku = $('#printList input[type="checkbox"]:checked')?.dataset.sel;
    const firstItem = appData.products.find(p => p.sku === firstSelectedSku) || filteredProducts()[0];
    renderPreview(firstItem, appData.templates.find(t=>t.id===dd.value)); 
  };
}

function generateSingleTagHTML(p, tpl) {
    const logo = appData.logo || '';
    const pad = '0.5'; // MODIFIED: Print margin removed

    const style = `
        <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;600;700;800;900&family=Prompt:wght@400;600;700&display=swap" rel="stylesheet">
        <style>
            html,body { margin: 0; padding: 0; font-family:'Kanit','Prompt',sans-serif; width: 100%; height: 100%; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .tag { width: 100%; 
                   height: 100%; 
                   padding-top: 2mm;
                   padding-right: 1mm;
                   padding-bottom: 2mm;
                   padding-left: 1mm; 
                   box-sizing:border-box; 
                   position:relative; 
                   display: flex; 
                   align-items: center; 
                   justify-content: center; }
            .card { position:relative; width:100%; height:100%; border-radius:12px; overflow:hidden; border:2px solid #1f1f22; background-color:${tpl.imageData ? 'transparent' : (tpl.kind==='ACC'?'#000':'#0b0b0c')}; color:#fff; background-image: ${tpl.imageData ? `url(${tpl.imageData})` : 'none'}; background-size: cover; background-position: center; }
            .logo { position:absolute; }
            .text-elevate { text-shadow: 0 1px 2px rgba(0,0,0,.9), 0 0 1px rgba(0,0,0,.7); }
        </style>
    `;

    let logoTag = '';
    if (tpl.showLogo && logo) {
        const { size = 64, margin = {top:10, right:10} } = tpl.logoStyles || {};
        logoTag = `<img src="${logo}" class="logo" style="top:${margin.top}px; right:${margin.right}px; width:${size}px; height:auto;">`;
    }
    const content = renderTagInnerHTML(p, tpl);
    const cardHTML = `<div class="card">${logoTag}${content}</div>`;
    const tagHTML = `<div class="tag">${cardHTML}</div>`;
    
    return `<!doctype html><html><head><title>Preview</title>${style}</head><body style="margin:0;padding:0;">${tagHTML}</body></html>`;
}

function renderPreview(item, tpl) {
  const box = $('#previewBox');
  box.innerHTML = '';
  if (!item || !tpl) {
    box.innerHTML = '<div class="text-zinc-500">No items or template selected</div>';
    return;
  }

  const size = baseSize(tpl.kind);
  const aspectW = size.w;
  const aspectH = size.h;

  const iframe = document.createElement('iframe');
  iframe.style.width = `${aspectW}px`;
  iframe.style.height = `${aspectH}px`;
  iframe.style.border = 'none';
  iframe.style.transformOrigin = 'top left';
  iframe.scrolling = 'no';
  
  iframe.srcdoc = generateSingleTagHTML(item, tpl);

  box.appendChild(iframe);
  
  function fit() {
    if(!box || !iframe) return;
    const availW = box.clientWidth;
    const availH = box.clientHeight;
    const scale = Math.min(availW / aspectW, availH / aspectH) * 0.95;
    iframe.style.transform = `scale(${scale})`;
    const left = (availW - (aspectW * scale)) / 2;
    const top = (availH - (aspectH * scale)) / 2;
    iframe.style.position = 'absolute';
    iframe.style.left = `${left}px`;
    iframe.style.top = `${top}px`;
  }
  
  iframe.onload = () => {
      fit();
      const ro = new ResizeObserver(() => fit());
      ro.observe(box);
  };
}

function renderTagInnerHTML(p, tpl){
  const innerPadding = '10mm'; // This padding is now inside the card content, not the printable area.
  const styleInline = (o) => {
    const m = o.margin || defaultMargin;
    return `font-size:${o.fs||14}px; color:${o.color||'#fff'}; font-weight:${o.fw||'normal'}; font-style:${o.fst||'normal'}; text-decoration:${o.td||'none'}; margin: ${m.top}px ${m.right}px ${m.bottom}px ${m.left}px;`;
  };
  const content = `
    <div style="position:absolute; top:0; left:0; right:0; bottom:0; padding:${innerPadding}; display:flex; flex-direction:column;">
        <div style="${styleInline(tpl.styles.sku)}" class="text-right text-elevate">${p.sku}</div>
        <div style="font-weight:800;line-height:1.2; ${styleInline(tpl.styles.description)}" class="text-elevate">${p.description}</div>
        <div class="space-y-1">${(p.details||'').split(/\\n|\n+/).filter(Boolean).slice(0,5).map(t=>`
            <div class="flex gap-2 items-start text-elevate" style="${styleInline(tpl.styles.details)}"><span>‚Ä¢</span><span>${t}</span></div>`).join('')}</div>
        <div class="mt-auto flex items-end justify-between">
            <div style="${styleInline(tpl.styles.expire)}" class="text-elevate">Expire : ${p.expiresDate?toDateInput(p.expiresDate):''}</div>
            <div class="text-right">
            <div style="${styleInline(tpl.styles.oldPrice)}" class="line-through text-elevate">${money(p.normalPrice)}</div>
            <div style="font-weight:900; ${styleInline(tpl.styles.price)}" class="text-elevate">${money(p.promoPrice)}</div>
            </div>
        </div>
    </div>
  `;
  if(tpl.kind === 'ACC' || tpl.kind === 'CARD'){
      const s = tpl.styles;
      const detailsLines = (p.details || '').split(/\\n|\n+/).filter(Boolean).slice(0, 2)
          .map(line => `<div style="font-size: ${(s.details.fs || 9)}px; color: ${(s.details.color || '#cccccc')}; margin-top: 2px; line-height: 1.2;">‚Ä¢ ${ellip(line, 40)}</div>`)
          .join('');

      return `
      <div style="position:absolute;left:6mm;top:4mm;${styleInline(s.sku)}" class="text-elevate">${p.sku}</div>
      <div style="display:flex; flex-direction: column; align-items:center; justify-content:center; text-align:center; height:100%; padding:10mm 8mm;" class="text-elevate">
          <div style="${styleInline(s.description)};max-width:100%;word-break:break-word">${ellip(p.description, 44)}</div>
          <div style="margin-top: 4px; max-width: 100%;">${detailsLines}</div>
      </div>
      <div style="position:absolute;left:6mm;bottom:4mm;${styleInline(s.expire)}" class="text-elevate">Expire ${p.expiresDate?toDateInput(p.expiresDate):''}</div>
      <div style="position:absolute;right:6mm;bottom:4mm;text-align:right">
          <div style="${styleInline(s.oldPrice)}" class="line-through text-elevate">${money(p.normalPrice)}</div>
          <div style="font-weight:900;${styleInline(s.price)}" class="text-elevate">${money(p.promoPrice)}</div>
      </div>
      `;
  }
  return content;
}


function baseSize(kind){
  if(kind==='A4') return {w:744,h:1052};
  if(kind==='A5') return {w:526,h:744};
  if(kind==='A6') return {w:372,h:526};
  if(kind==='CARD') return {w:265, h:374}; // 70mm x 99mm for 3x3 on A4 portrait
  return {w:640,h:320}; // ACC or default for IMAGE
}

function openPrintTab(list,tpl){
  const items=[]; list.forEach(({p,qty})=>{ for(let i=0;i<qty;i++) items.push(p); });
  if(!items.length){ showToast('Select at least one SKU.', 'info'); return; }
  const w=window.open('', '_blank');
  if(!w){ showToast('Pop-up blocked. Please allow pop-ups.', 'error'); return; }
  const logo=appData.logo||'';
  let cols=1, rows=1, pageSize='A4';
  const pad = '0.5'; // MODIFIED: Print margin removed

  if(tpl.kind==='A4'){ cols=1; rows=1; pageSize='A4'; }
  else if(tpl.kind==='A5'){ cols=2; rows=1; pageSize='A4 landscape'; }
  else if(tpl.kind==='A6'){ cols=2; rows=2; pageSize='A4'; }
  else if(tpl.kind==='CARD'){ cols=3; rows=3; pageSize='A4'; }
  else if(tpl.kind==='ACC'){ cols=2; rows=6; pageSize='A4'; }
  else { cols=1; rows=1; pageSize='A4'; } // Default for IMAGE

  const style=`
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;600;700;800;900&family=Prompt:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
      @page { size: ${pageSize}; margin: 0; }
      html,body{ background:#fff; -webkit-print-color-adjust: exact; print-color-adjust: exact; font-family:'Kanit','Prompt',sans-serif; margin: 0; padding: 0; }
      .sheet{ width: ${pageSize.includes('landscape') ? '287mm' : '200mm'}; height: ${pageSize.includes('landscape') ? '200mm' : '287mm'}; margin: 0 auto; display: grid; grid-template-columns: repeat(${cols}, 1fr); grid-template-rows: repeat(${rows}, 1fr); gap: 0; page-break-after: always; box-sizing: border-box; }
      .tag{ width:100%; 
            height:100%; 
            padding-top: 2mm;
            padding-right: 1mm;
            padding-bottom: 2mm;
            padding-left: 1mm;
            box-sizing:border-box; 
            position:relative; 
            display: flex; 
            align-items: center; 
            justify-content: center;}
      .card{ position:relative; width:100%; height:100%; border-radius:0px; overflow:hidden; border:2px solid #1f1f22; background-color:${tpl.imageData ? 'transparent' : (tpl.kind==='ACC'?'#000':'#0b0b0c')}; color:#fff; background-image: ${tpl.imageData ? `url(${tpl.imageData})` : 'none'}; background-size: cover; background-position: center; }
      .logo{ position:absolute; }
      .text-elevate{ text-shadow: 0 1px 2px rgba(0,0,0,.9), 0 0 1px rgba(0,0,0,.7); }
    </style>
  `;
  const perSheet = cols*rows;
  const pages=[]; for(let i=0;i<items.length;i+=perSheet) pages.push(items.slice(i,i+perSheet));
  const body = pages.map(pg=>{
    const inner=pg.map(p=>{
      let logoTag = '';
      if(tpl.showLogo && logo) {
        const { size = 64, margin = {top:10, right:10} } = tpl.logoStyles || {};
        logoTag = `<img src="${logo}" class="logo" style="top:${margin.top}px; right:${margin.right}px; width:${size}px; height:auto;">`;
      }
      const content = renderTagInnerHTML(p, tpl);
      return `<div class="tag"><div class="card">${logoTag}${content}</div></div>`;
    }).join('');
    return `<div class="sheet">${inner}</div>`;
  }).join('');
  w.document.write(`<!doctype html><html><head><meta charset="utf-8"><title>Print</title>${style}</head><body>${body}</body></html>`);
  w.document.close();
  w.focus(); 
  setTimeout(() => w.print(), 500);
  log('open_print', `${items.length} tags, tpl=${tpl.name}`);
}

function closeAllFilterDropdowns(exceptKey = null) {
  const g = $('#global-filter-dropdown');
  if (g && (!exceptKey || g.dataset.key !== exceptKey)) g.style.display = 'none';
  $$('.filter-dropdown').forEach(d => { d.style.display = 'none'; });
}

function openFilterDropdown(key) {
  let g = document.querySelector('#global-filter-dropdown');
  if (!g) {
    g = document.createElement('div');
    g.id = 'global-filter-dropdown';
    g.className = 'filter-dropdown';
    document.body.appendChild(g);
  }
  g.style.position = 'fixed';
  g.style.zIndex = '9999';

  const btn = document.querySelector(`.filter-btn[data-filter-key="${key}"]`);
  if (!btn) return;

  const isVisible = g.style.display === 'block' && g.dataset.key === String(key);
  closeAllFilterDropdowns(key);
  if (isVisible) { g.style.display = 'none'; return; }

  const allValues = [...new Set((appData.products || [])
    .map(p => (p[key] ?? '').toString())
    .filter(Boolean))];

  let sortDir = 'asc';
  let viewValues = [...allValues].sort((a,b)=>a.localeCompare(b,undefined,{numeric:true}));
  const currentFilter = columnFilters[key] || new Set();

  g.dataset.key = key;
  g.innerHTML = `
    <div class="filter-dropdown-content">
      <input id="filter-search-${key}" class="px-2 py-1 rounded bg-zinc-800 border border-zinc-700 outline-none" placeholder="Search..." />
      <div class="flex gap-2 my-1">
        <button id="filter-sort-asc-${key}" class="flex-1 px-2 py-1 text-xs rounded bg-zinc-800 border border-zinc-700 hover:bg-zinc-700">Sort A‚ÄìZ</button>
        <button id="filter-sort-desc-${key}" class="flex-1 px-2 py-1 text-xs rounded bg-zinc-800 border border-zinc-700 hover:bg-zinc-700">Sort Z‚ÄìA</button>
      </div>
      <label class="flex items-center gap-2 text-sm hover:bg-zinc-700 p-1 rounded">
        <input type="checkbox" id="filter-select-all-${key}"> Select All (visible)
      </label>
      <div id="filter-values-${key}" class="max-h-60 overflow-auto rounded border border-zinc-800"></div>
      <div class="flex gap-2 mt-2">
        <button data-apply-filter="${key}" class="flex-1 px-2 py-1 text-xs rounded bg-brand.red hover:bg-red-600" data-total-values="${allValues.length}">Apply</button>
        <button data-clear-filter="${key}" class="flex-1 px-2 py-1 text-xs rounded bg-zinc-700 hover:bg-zinc-600">Clear</button>
      </div>
    </div>
  `;

  const $valsBox = g.querySelector(`#filter-values-${key}`);
  const $selectAll = g.querySelector(`#filter-select-all-${key}`);
  const $search = g.querySelector(`#filter-search-${key}`);

  function renderList() {
    $valsBox.innerHTML = '';
    const q = ($search.value || '').toString().trim().toLowerCase();
    let display = viewValues.filter(v => v.toLowerCase().includes(q));
    display.sort((a,b)=> sortDir==='asc' ? a.localeCompare(b,undefined,{numeric:true}) : b.localeCompare(a,undefined,{numeric:true}));
    for (const v of display) {
      const checked = (currentFilter.size===0) ? true : currentFilter.has(v);
      const row = document.createElement('label');
      row.className = 'flex items-center gap-2 text-sm hover:bg-zinc-700 p-1 rounded';
      row.title = v;
      row.innerHTML = `<input type="checkbox" class="filter-item-${key}" value="${v}" ${checked ? 'checked' : ''}><span class="oneline">${ellip(v, 40)}</span>`;
      $valsBox.appendChild(row);
    }
    const visibleChecks = Array.from($valsBox.querySelectorAll(`.filter-item-${key}`));
    $selectAll.checked = visibleChecks.length > 0 && visibleChecks.every(cb => cb.checked);
    visibleChecks.forEach(cb => { cb.onchange = () => { $selectAll.checked = visibleChecks.length > 0 && visibleChecks.every(x => x.checked); }; });
  }

  g.querySelector(`#filter-sort-asc-${key}`).onclick = () => { sortDir = 'asc'; renderList(); };
  g.querySelector(`#filter-sort-desc-${key}`).onclick = () => { sortDir = 'desc'; renderList(); };
  $search.oninput = () => renderList();
  g.setAttribute('tabindex', -1);
  g.onkeydown = (e) => { if (e.key === 'Enter') { e.preventDefault(); g.querySelector(`[data-apply-filter="${key}"]`).click(); } };
  $selectAll.onchange = (e) => { Array.from($valsBox.querySelectorAll(`.filter-item-${key}`)).forEach(cb => cb.checked = e.target.checked); };
  
  const r = btn.getBoundingClientRect();
  g.style.left = `${r.left}px`;
  g.style.top  = `${r.bottom + 4}px`;
  g.style.display = 'block';
  renderList();
}

function makeTableResizable() {
    const header = $('#productTHead');
    if (!header) return;
    let th, startX, startWidth;
    function onMouseMove(e) {
        const newWidth = startWidth + (e.clientX - startX);
        if (newWidth > 50) { th.style.width = `${newWidth}px`; }
    }
    function onMouseUp() {
        document.removeEventListener('mousemove', onMouseMove);
        document.removeEventListener('mouseup', onMouseUp);
        const resizer = th.querySelector('.resizer');
        if(resizer) resizer.classList.remove('resizing');
        document.body.style.cursor = 'default';
        document.body.style.userSelect = 'auto';
    }
    header.addEventListener('mousedown', (e) => {
        if (e.target.classList.contains('resizer')) {
            e.preventDefault();
            th = e.target.parentElement;
            startX = e.clientX;
            startWidth = th.offsetWidth;
            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
            e.target.classList.add('resizing');
            document.body.style.cursor = 'col-resize';
            document.body.style.userSelect = 'none';
        }
    });
}


/* ================= EVENTS BINDING ================= */
function bindAuthEvents() {
    $('#btnCreateHost').onclick = async () => {
        const pass = $('#setupPass').value;
        if (pass.length < 4) { showToast('Password must be at least 4 characters long.', 'error'); return; }
        if (pass !== $('#setupPassConfirm').value) { showToast('Passwords do not match.', 'error'); return; }
        if (!appData) appData = JSON.parse(JSON.stringify(defaultAppState));
        appData.users = [{ username: 'host', passwordHash: await hashPassword(pass), role: 'Host', channels: [...Channels], canSeeCosts: true, canPrint: true }];
        const gistId = localStorage.getItem(LS.GIST_ID);
        const token = sessionStorage.getItem(LS.TOKEN); // MODIFIED
        if(gistId && token) {
            try {
                await cloudSave(gistId, token);
                showToast('Host account created and saved. Please log in.', 'success');
                $('#setupView').classList.add('hidden');
                $('#loginView').classList.remove('hidden');
            } catch (err) { showToast('Failed to save host account: ' + err.message, 'error'); }
        } else { showToast('Error: Gist credentials not found.', 'error'); }
    };

    $('#btnLogin').onclick = login;
    $('#loginPass').onkeydown = (e) => { if (e.key === 'Enter') login(); };

    $('#btnCloudCreate').onclick = async () => {
        const token = $('#cloudToken').value.trim();
        if (!token) { showToast('GitHub Token is required.', 'error'); return; }
        try {
            const gistId = await cloudCreateGist(token, defaultAppState);
            showToast('Gist created: ' + gistId, 'success');
            showToast('Please create the host account.', 'info');
            appData = JSON.parse(JSON.stringify(defaultAppState));
            $('#cloudSetupView').classList.add('hidden');
            $('#setupView').classList.remove('hidden');
        } catch (err) { showToast('Error creating Gist: ' + err.message, 'error'); }
    };

    $('#btnCloudLoad').onclick = async () => {
        const token = $('#cloudToken').value.trim();
        const gistId = $('#cloudGistId').value.trim();
        if (!token || !gistId) { showToast('Token and Gist ID are required.', 'error'); return; }
        try {
            await cloudLoad(gistId, token);
            showToast('Loaded from Gist. Please log in.', 'success');
            $('#cloudSetupView').classList.add('hidden');
            $('#loginView').classList.remove('hidden');
        } catch (err) { showToast('Error loading from Gist: ' + err.message, 'error'); }
    };
}

function bindAppEvents() {
    $('#btnLogout').onclick = logout;
    $('#btnNewProduct').onclick = () => openEditor();
    $('#btnSettings').onclick = () => openSettings('data');
    $('#btnPrintModal').onclick = () => {
        if (!currentUser || !currentUser.canPrint) return;
        buildPrintList();
        fillTemplateDropdown();
        renderPreview(filteredProducts()[0], (appData.templates||[])[0]);
        togglePrintModal(true);
    };

    $('#searchInput').oninput = debounce(() => { currentPage = 1; renderTable(); }, 300);
    
    // BUG FIX: Simplified the onchange handler
    $('#channelSelect').onchange = () => { 
        currentPage = 1; 
        renderTable(); 
    };

    $('#btnCloseSettings').onclick = () => $('#settingsPanel').classList.add('hidden');
    $$('.set-tab').forEach(b => b.onclick = () => openSettings(b.dataset.tab));
    $('#btnCloseEditor').onclick = closeEditor;
    $('#btnSaveEd').onclick = saveEditor;
    $('#btnClosePrintModal').onclick = () => togglePrintModal(false);
    $('#btnOpenPrint').onclick = () => {
        const picks = $$('#printList input[type="checkbox"]:checked').map(c => c.dataset.sel);
        const list = picks.map(sku => ({ p: appData.products.find(p => p.sku === sku), qty: parseInt($(`[data-qty="${sku}"]`).value) || 1 })).filter(item => item.p);
        const tpl = appData.templates.find(t => t.id === $('#printTemplate').value) || appData.templates[0];
        openPrintTab(list, tpl);
    };

    $('#productTHead').addEventListener('click', (e) => {
        const headerCell = e.target.closest('th[data-sort-key]');
        if (!headerCell) return;
        
        const key = headerCell.dataset.sortKey;

        if (sortState.key === key) {
            sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
        } else {
            sortState.key = key;
            sortState.direction = 'asc';
        }
        
        renderTableHeader();
        renderTable();
    });
}

function bindTableEvents() {
    $$('button[data-edit]').forEach(b => b.onclick = () => openEditor(b.dataset.edit));
    $$('button[data-del]').forEach(b => b.onclick = async () => {
        const sku = b.dataset.del;
        const confirmed = await showConfirm('Delete Product?', `Are you sure you want to delete SKU ${sku}? This cannot be undone.`);
        if (confirmed) {
            appData.products = appData.products.filter(x => x.sku !== sku);
            log('delete_sku', sku);
            showToast(`SKU ${sku} deleted.`, 'success');
            updateLocalDataAndSave();
        }
    });

    $$('.filter-btn').forEach(btn => {
        btn.onclick = (e) => {
            e.stopPropagation();
            openFilterDropdown(btn.dataset.filterKey);
        }
    });
}

function bindSettingsEvents(tab) {
    if (tab === 'data') {
        $('#btnDoImportMaster').onclick=doImportMaster;
        $('#btnExportMaster').onclick=doExportMaster;
    } 
    if (tab === 'promo') {
        $('#btnDoImportPromo').onclick=doImportPromo;
        $('#btnExportPromo').onclick=doExportPromo;
        $('#btnReportExpired').onclick=showExpiredPromoReport;
    }
    if (tab === 'logo') {
        $('#btnSaveLogo').onclick=async()=>{
            const f=$('#logoFile').files[0]; if(!f) { showToast('Choose a file.', 'error'); return; }
            appData.logo = await fileToBase64(f);
            log('update_logo');
            updateLocalDataAndSave();
            showToast('Logo updated.', 'success');
            openSettings('logo');
        };
        $('#btnRemoveLogo').onclick=()=>{
            appData.logo = '';
            log('remove_logo');
            updateLocalDataAndSave();
            showToast('Logo removed.', 'success');
            openSettings('logo');
        }
    }
    if (tab === 'dealer') {
        $('#btnSaveDealer').onclick=()=>{
            appData.dealerNames = {t1:$('#nameT1').value.trim()||'Dealer T1', t2:$('#nameT2').value.trim()||'Dealer T2', t3:$('#nameT3').value.trim()||'Dealer T3'};
            log('save_dealer_names', JSON.stringify(appData.dealerNames));
            updateLocalDataAndSave();
            showToast('Dealer names saved.', 'success');
        };
    }
    if (tab === 'users') {
        $('#btnAddUser').onclick = () => $('#addUserBox').classList.toggle('hidden');
        $('#nuCreate').onclick = async () => {
            const name = $('#nuName').value.trim();
            const pass = $('#nuPass').value.trim();
            if (!name || !pass) { showToast('Username & password required', 'error'); return; }
            if ((appData.users || []).some(u => u.username === name)) { showToast('Username already exists', 'error'); return; }
            const role = $('#nuRole').value;
            const canSee = $('#nuSeeCosts').checked;
            const canPrint = $('#nuCanPrint').checked;
            const chs = $$('.nuCh').filter(x => x.checked).map(x => x.value);
            if (!chs.length) { showToast('Select at least one channel', 'error'); return; }
            appData.users.push({ username: name, passwordHash: await hashPassword(pass), role, channels: chs, canSeeCosts: canSee, canPrint });
            log('add_user', name);
            updateLocalDataAndSave();
            showToast('User created successfully.', 'success');
            openSettings('users');
        };

$$('button[data-saveu-idx]').forEach(b => {
  b.onclick = async (e) => {
    const i = +e.target.dataset.saveuIdx;
    const u = appData.users[i];
    if (!u) return;

    if (currentUser.role === 'Admin' && (u.role === 'Host' || u.username === 'host')) {
      showToast('Admin cannot modify Host accounts.', 'error');
      return;
    }

    const roleSel = $(`select[data-role-idx="${i}"]`);
    const newRole = roleSel ? roleSel.value : u.role;
    if (currentUser.role === 'Admin' && newRole === 'Host') {
      showToast('Admin cannot assign Host role.', 'error');
      if (roleSel) roleSel.value = u.role;
      return;
    } else {
      u.role = newRole;
    }

    u.canSeeCosts = $(`input[data-cost-idx="${i}"]`).checked;
    u.canPrint   = $(`input[data-print-idx="${i}"]`).checked;

    const newPass = $(`input[data-pass-idx="${i}"]`).value.trim();
    if (!(currentUser.role === 'Admin' && (u.role === 'Host' || u.username === 'host'))) {
      if (newPass) { 
        if(newPass.length < 4) {
            showToast('New password must be at least 4 characters long.', 'error');
            return;
        }
        u.passwordHash = await hashPassword(newPass); 
      }
    }

    u.channels = Channels.filter(ch => $(`input[data-ch-idx="${i}|${ch}"]`).checked);
    if(u.channels.length === 0) {
        showToast('User must have at least one channel.', 'error');
        return;
    }

    if (currentUser.username === u.username) {
      currentUser = u;
      initFiltersForUser();
    }

    log('update_user', u.username);
    updateLocalDataAndSave();
    showToast(`User ${u.username} updated.`, 'success');
    openSettings('users');
  };
});

        $$('button[data-delu-idx]').forEach(b => {
            b.onclick = async (e) => {
                const i = +e.target.dataset.deluIdx;
                const u = appData.users[i];
                if(!u) return;
                if (u.username === 'host') { showToast('Cannot delete host account.', 'error'); return; }
                const confirmed = await showConfirm('Delete User?', `Are you sure you want to delete user "${u.username}"?`);
                if (confirmed) {
                    appData.users.splice(i, 1);
                    log('delete_user', u.username);
                    updateLocalDataAndSave();
                    showToast(`User ${u.username} deleted.`, 'success');
                    openSettings('users');
                }
            };
        });
    } 
    if (tab === 'templates') {
        $('#btnShowAddTpl').onclick = () => $('#addTplBox').classList.toggle('hidden');
        $('#btnCancelTpl').onclick = () => $('#addTplBox').classList.add('hidden');
        $('#btnCreateTpl').onclick = async () => {
            const kind = $('#newTplKind').value;
            const name = $('#newTplName').value.trim();
            if (!name) { showToast('Please enter a template name.', 'error'); return; }

            const baseTemplate = defaultAppState.templates.find(t => t.kind === kind);
            const newTpl = JSON.parse(JSON.stringify(baseTemplate));
            newTpl.id = 'user-' + Math.random().toString(36).slice(2, 10);
            newTpl.name = name;
            newTpl.imageData = null;
            
            appData.templates.push(newTpl);
            log('add_template', name);
            updateLocalDataAndSave();
            showToast('New template created.', 'success');
            openSettings('templates');
        };
        const kindSelect = $('#newTplKind');
        if (kindSelect && kindSelect.options.length === 0) {
            const kinds = defaultAppState.templates.map(t => t.kind).filter((v, i, a) => a.indexOf(v) === i);
            kinds.forEach(k => {
                const opt = document.createElement('option'); opt.value = k; opt.textContent = k; kindSelect.appendChild(opt);
            });
        }
        
        $$('[data-style-tpl]').forEach(btn => {
          btn.onclick = () => btn.classList.toggle('active');
        });
        $$('[data-savetpl-idx]').forEach(btn => {
            btn.onclick = async () => {
                const confirmed = await showConfirm('Save Template?', 'Are you sure you want to save changes to this template?');
                if(!confirmed) return;
                
                const i = +btn.dataset.savetplIdx;
                const t = appData.templates[i];
                if(!t) return;
                t.name = $(`[data-name-tpl="${i}"]`).value.trim() || 'Untitled Template';
                ['sku','description','details','price','oldPrice','expire'].forEach(k=>{
                    t.styles[k].fs = parseInt($(`[data-val-tpl="${i}|${k}|fs"]`).value) || 14;
                    t.styles[k].color = $(`[data-val-tpl="${i}|${k}|color"]`).value || '#ffffff';
                    t.styles[k].margin = {
                        top: parseInt($(`[data-val-tpl="${i}|${k}|margin|top"]`).value) || 0,
                        right: parseInt($(`[data-val-tpl="${i}|${k}|margin|right"]`).value) || 0,
                        bottom: parseInt($(`[data-val-tpl="${i}|${k}|margin|bottom"]`).value) || 0,
                        left: parseInt($(`[data-val-tpl="${i}|${k}|margin|left"]`).value) || 0,
                    };
                    t.styles[k].fw = $(`[data-style-tpl="${i}|${k}|fw|bold"]`).classList.contains('active') ? 'bold' : 'normal';
                    t.styles[k].fst = $(`[data-style-tpl="${i}|${k}|fst|italic"]`).classList.contains('active') ? 'italic' : 'normal';
                    let td = [];
                    if ($(`[data-style-tpl="${i}|${k}|td|underline"]`).classList.contains('active')) td.push('underline');
                    if ($(`[data-style-tpl="${i}|${k}|td|line-through"]`).classList.contains('active')) td.push('line-through');
                    t.styles[k].td = td.length > 0 ? td.join(' ') : 'none';
                });
                t.showLogo = $(`[data-logo-tpl="${i}"]`).checked;
                t.logoStyles.size = parseInt($(`[data-logosize-tpl="${i}"]`).value) || 64;
                t.logoStyles.margin = {
                    top: parseInt($(`[data-logomargintop-tpl="${i}"]`).value) || 10,
                    right: parseInt($(`[data-logomarginright-tpl="${i}"]`).value) || 10,
                    bottom: 0, left: 0
                };
                log('save_template', t.name);
                updateLocalDataAndSave();
                showToast('Template saved.', 'success');
                openSettings('templates');
            };
        });
        $$('[data-del-tpl]').forEach(btn => {
            btn.onclick = async () => {
                const i = +btn.dataset.delTpl;
                const t = appData.templates[i];
                if(!t) return;
                const confirmed = await showConfirm('Delete Template?', `Are you sure you want to delete template "${t.name}"?`);
                if (confirmed) {
                    appData.templates.splice(i, 1);
                    log('delete_template', t.name);
                    updateLocalDataAndSave();
                    showToast(`Template ${t.name} deleted.`, 'success');
                    openSettings('templates');
                }
            };
        });
$$('[data-img-tpl]').forEach(input => {
            input.onchange = async (e) => {
                const i = +e.target.dataset.imgTpl;
                const file = e.target.files[0];
                if (!file) return;

                // --- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ ---
                const MAX_FILE_SIZE = 200 * 1024; // 200 KB
                if (file.size > MAX_FILE_SIZE) {
                    showToast('Image file is too large. Please use a file under 200 KB.', 'error');
                    e.target.value = ''; // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
                    return;
                }
                // ---------------------------

                const t = appData.templates[i];
                if (!t) return;
                try {
                    t.imageData = await fileToBase64(file);
                    t.kind = t.kind || 'IMAGE';
                    log('update_template_image', t.name);
                    updateLocalDataAndSave();
                    showToast('Template image updated.', 'success');
                    renderTemplateEditor(i);
                } catch(err) { showToast('Failed to update image: '+err.message, 'error'); }
            };
        });
    }
    if (tab === 'cloud') {
        $('#btnCloudLoadRefresh').onclick=async()=>{
            const token = sessionStorage.getItem(LS.TOKEN); // MODIFIED
            const gistId = localStorage.getItem(LS.GIST_ID);
            if(!gistId || !token) { showToast('Gist ID and Token not found.', 'error'); return; }
            try {
                await cloudLoad(gistId, token);
                updateLocalDataAndSave();
                showToast('Refreshed from cloud successfully.', 'success');
            } catch(e){ showToast(e.message, 'error'); }
        };
    }
}


/* ================= STARTUP LOGIC ================= */
async function initialCheck() {
    const gistId = localStorage.getItem(LS.GIST_ID);
    const token = localStorage.getItem(LS.TOKEN); // MODIFIED

    if (gistId && token) {
        try {
            await cloudLoad(gistId, token);
            const lastUser = localStorage.getItem(LS.LAST_USER);
            const userToLogin = lastUser ? (appData.users || []).find(u => u.username === lastUser) : null;
            if (userToLogin) {
                performLogin(userToLogin);
            } else {
                $('#cloudSetupView').classList.add('hidden');
                $('#loginView').classList.remove('hidden');
            }
        } catch(e) {
            console.error("Critical error during initial load:", e);
            localStorage.removeItem(LS.GIST_ID);
            sessionStorage.removeItem(LS.TOKEN);
            localStorage.removeItem(LS.LAST_USER);
            $('#cloudSetupView').classList.remove('hidden');
            showToast("Cloud load failed, credentials have been cleared. Please set up again.", 'error');
        }
    } else {
        $('#cloudSetupView').classList.remove('hidden');
    }
}

function init() {
  bindAuthEvents();
  
  // MODIFIED: Initialize Litepicker
  const datePickerElement = $('#dateRangePicker');
  if (datePickerElement) {
    const picker = new Litepicker({ 
        element: datePickerElement,
        singleMode: false,
        format: 'DD MMM YYYY',
        tooltipText: {
            one: 'day',
            other: 'days'
        },
        setup: (picker) => {
            picker.on('selected', (date1, date2) => {
                $('#dateStart').value = date1 ? date1.format('YYYY-MM-DD') : '';
                $('#dateEnd').value = date2 ? date2.format('YYYY-MM-DD') : '';
                currentPage = 1;
                renderTable();
            });
        }
    });
  }
  
  document.addEventListener('click', (e) => {
      if (!e.target.closest('.filter-dropdown')) {
          closeAllFilterDropdowns();
      }
      
      const applyFilterBtn = e.target.closest('[data-apply-filter]');
      if (applyFilterBtn) {
        const key = applyFilterBtn.dataset.applyFilter;
        const total = +applyFilterBtn.dataset.totalValues || Infinity;

        const checkedValues = new Set(
          Array.from(document.querySelectorAll(`.filter-item-${key}:checked`)).map(cb => cb.value)
        );

        columnFilters[key] = (checkedValues.size >= total) ? new Set() : checkedValues;

        currentPage = 1;
        closeAllFilterDropdowns();
        updateLocalDataAndSave();
      }
      const clearFilterBtn = e.target.closest('[data-clear-filter]');
      if (clearFilterBtn) {
          const key = clearFilterBtn.dataset.clearFilter;
          if(columnFilters[key]) columnFilters[key].clear();
          currentPage = 1;
          closeAllFilterDropdowns();
          updateLocalDataAndSave();
      }
  });
  
  window.addEventListener('keydown', e => { 
      if ((e.metaKey || e.ctrlKey) && e.key.toLowerCase() === 'k') { 
          e.preventDefault(); 
          $('#searchInput')?.focus(); 
      }
  });
  
  initialCheck();
}

init();
</script>
</body>
</html>
