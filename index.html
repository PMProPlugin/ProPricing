<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ProPlugin • Price Tag Management (Dealer 3‑Tier + GP%)</title>
  <!-- 
  README — Quick Start (สำคัญมาก)
  =============================================================
  ▶ เปิดไฟล์นี้ได้ทันที (ดับเบิลคลิก index.html) — ไม่มี Backend
  ▶ เผยแพร่ได้เลยบน GitHub Pages / Vercel แบบ Static (ไฟล์เดียว)
  ▶ ใช้ได้บน Desktop / Tablet / Mobile (Responsive)

  DEMO LOGIN (ฮาร์ดโค้ด)
  - Host  : host1 / host123  (สิทธิ์สูงสุด + จัดการผู้ใช้)
  - Admin : admin1 / admin123 (จัดการสินค้า ราคา เทมเพลต ฯลฯ)
  - User1 : user1 / u1pass   (Flagship เท่านั้น)
  - User2 : user2 / u2pass   (Flagship เท่านั้น)
  - User3 : user3 / u3pass   (Dealer + D1/D2/D3 + GP%)
  - User4 : user4 / u4pass   (Marketplace + GP%)

  ไฟล์ Excel (หัวคอลัมน์รองรับทั้งไทย/อังกฤษ ตรงตาม Mapping นี้)
  - Item No.                 → sku
  - Description              → description
  - Details                  → details (คั่นด้วย \n หรือ •; แสดงสูงสุด 5 บรรทัด)
  - Normal Price             → normal_price
  - Promotion Price          → promo_price
  - Dealer Price T1/T2/T3    → dealer_price_t1 / t2 / t3
  - Dealer GP%  T1/T2/T3     → dealer_gp_t1 / t2 / t3 (แสดงตามไฟล์ ไม่คำนวณใหม่)
  - Flagship Price           → flagship_price
  - Marketplace Price        → marketplace_price
  - Marketplace GP%          → market_gp (ถ้ามี)
  - Cost (optional)          → cost (เฉพาะหน้า Admin ใช้อ้างอิง)
  - Expire date              → expire_date (รูปแบบที่ Excel/Google Sheets เข้าใจได้)

  กฎราคา (สำคัญ)
  - ช่องทางว่าง = ใช้ราคากลาง: สำหรับ Flagship ใช้ promo_price ถ้ามี ไม่งั้นใช้ normal_price
  - Flagship บนป้าย: ถ้า promo_price มี → โชว์ราคาโปรเป็นหลัก และโชว์ราคาปกติขีดฆ่า; ถ้าไม่มี → โชว์ราคาปกติอย่างเดียว
  - Dealer บนป้าย: เลือกชั้นราคาที่ต้องการ (D1/D2/D3) จากตัวเลือกใน Preview/Print
  - Marketplace: โชว์ราคา Marketplace + GP% (ถ้ามีในไฟล์)

  เทมเพลตป้าย (พิมพ์แบบ mm — ตรงสเกลแท้):
  - A4  (210×297 mm) → 1 ใบต่อหน้า A4
  - A5  (148×210 mm) → 2 ใบต่อหน้า A4
  - A6  (105×148 mm) → 4 ใบต่อหน้า A4
  - Accessories Tag (~1/3 ของ A6) → 12 ใบต่อหน้า A4
  โครงสร้าง CSS ใช้ตัวแปร (Template Manager) เพื่อจูนตำแหน่ง/ระยะ/ขนาด ให้ "แมตช์ภาพ/ไฟล์ PDF ของจริงแบบพิกเซลเป๊ะ"
  สามารถอัปโหลดโลโก้ 1 ครั้งแล้วระบบจำ (localStorage)

  การพิมพ์/ส่งออก PDF
  - ปุ่ม "พิมพ์/ส่งออก" จะสร้าง Layout ตามเทมเพลตด้วย @media print
  - เลือก Windows/Mac Printer → Save as PDF ได้ทันที (Multi‑page)

  LOGs (บันทึกลง localStorage)
  - ใคร/ทำอะไร/เมื่อไร (โซนเวลา Asia/Bangkok) ครอบคลุม Import/Export/แก้ไข/พิมพ์ ฯลฯ → ส่งออก CSV ได้จากหน้า Admin

  การดีพลอย
  - GitHub Pages: แค่อัปไฟล์ index.html นี้ขึ้น main branch → เปิดใช้งาน Pages
  - Vercel/Netlify: สร้างโปรเจกต์แบบ Static ให้ชี้มายังไฟล์นี้ได้เลย

  หมายเหตุเรื่อง "พิกเซลเป๊ะ"
  - แต่ละองค์กรใช้แม่แบบต่างกัน จึงมี Template Manager ให้ปรับค่าระยะ/ฟอนต์/น้ำหนัก/ตำแหน่งแบบ millimeter + Live Preview
  - คุณสามารถอัปโหลดภาพ PNG ของแม่แบบ (เช่นไฟล์ที่ส่งมา: A4/A5/A6/Acc) เป็นฉากหลังเพื่อเทียบตำแหน่งก่อนพิมพ์จริง
  =============================================================
  -->

  <!-- ฟอนต์ไทย -->
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700;800&family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- SheetJS (Excel) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root{
      /* Theme: black 80% / white 20% / red 10% */
      --c-bg:#0f0f10;          /* พื้นหลังหลัก */
      --c-surface:#141517;     /* การ์ด/พื้น */
      --c-muted:#222428;       /* เส้น/เขต */
      --c-text:#e9e9ea;        /* ตัวอักษรหลัก */
      --c-soft:#b9bcc4;        /* ตัวอักษรรอง */
      --c-red:#ff3b30;         /* ไฮไลต์แดง */
      --c-edge:#000;           /* กรอบ (บนป้าย) */
      --c-white:#fff;          

      --ff-1:"Kanit", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans Thai", sans-serif;
      --ff-2:"Prompt", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans Thai", sans-serif;

      --radius:14px;

      /* ตัวแปรสำหรับเทมเพลตป้าย (แก้ได้ใน Template Manager) */
      /* ===== A4 ===== */
      --A4-w-mm:210; --A4-h-mm:297; --A4-padding-mm:12; --A4-radius-mm:10;
      --A4-name-size:18; --A4-name-weight:800; --A4-sku-size:8.5; --A4-detail-size:10.5;
      --A4-price-size:38; --A4-price-weight:800; --A4-normal-size:16; --A4-expire-size:11.5;
      /* ===== A5 ===== */
      --A5-w-mm:148; --A5-h-mm:210; --A5-padding-mm:10; --A5-radius-mm:9;
      --A5-name-size:16; --A5-name-weight:800; --A5-sku-size:8; --A5-detail-size:9.5;
      --A5-price-size:32; --A5-price-weight:800; --A5-normal-size:14; --A5-expire-size:10.5;
      /* ===== A6 ===== */
      --A6-w-mm:105; --A6-h-mm:148; --A6-padding-mm:8; --A6-radius-mm:8;
      --A6-name-size:14; --A6-name-weight:800; --A6-sku-size:7.5; --A6-detail-size:8.5;
      --A6-price-size:26; --A6-price-weight:800; --A6-normal-size:12; --A6-expire-size:9.5;
      /* ===== ACC (1/3 A6 ชิดแนวนอน) ===== */
      --ACC-w-mm:105; --ACC-h-mm:45; --ACC-padding-mm:6; --ACC-radius-mm:6;
      --ACC-name-size:10.5; --ACC-name-weight:700; --ACC-sku-size:7; --ACC-detail-size:8;
      --ACC-price-size:16.5; --ACC-price-weight:800; --ACC-normal-size:10; --ACC-expire-size:8.5;

      /* โลโก้บนป้าย */
      --logo-w-mm:26; --logo-h-mm:auto; --logo-top-mm:8; --logo-left-mm:8;
      /* ตำแหน่ง SKU/ชื่อ/รายละเอียด */
      --sku-top-mm:8; --sku-right-mm:8;
      --name-top-mm:28; --name-left-mm:12; --name-right-mm:12;
      --detail-top-mm:48; --detail-left-mm:12; --detail-right-mm:12; --detail-gap-mm:2.6;
      /* พื้นที่ราคา */
      --price-area-bottom-mm:10; --price-area-left-mm:12; --price-area-right-mm:12;
      --expire-left-mm:12; --expire-bottom-mm:34; /* อยู่ซ้ายบนของพื้นที่ราคา */
      --normal-right-mm:12; --normal-bottom-mm:30; /* ราคาเดิม (ขีดฆ่า เมื่อมีโปร) */
      --promo-right-mm:12; --promo-bottom-mm:10;  /* ราคาโปร (ใหญ่สุด) */
    }

    html,body{height:100%;}
    body{margin:0;background:var(--c-bg);color:var(--c-text);font-family:var(--ff-1);}
    *{box-sizing:border-box}
    
    .app{max-width:1200px;margin:0 auto;padding:24px;}
    .topbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
    .brand{display:flex;gap:10px;align-items:center}
    .brand-logo{width:36px;height:36px;border-radius:8px;background:#1e1f22;display:grid;place-items:center;font-weight:800}
    .brand-name{font-weight:700;letter-spacing:.3px}
    .chip{padding:2px 8px;border-radius:999px;background:#1e1f22;color:#c9cbd2;font-size:12px;border:1px solid var(--c-muted)}

    .card{background:var(--c-surface);border:1px solid var(--c-muted);border-radius:var(--radius);}
    .login-card{max-width:460px;margin:8vh auto;padding:24px 20px}
    .login-card h1{margin:0 0 6px;font-size:22px}
    .muted{color:var(--c-soft)}
    .row{display:flex;gap:12px;align-items:center}
    .row.wrap{flex-wrap:wrap}
    .grid{display:grid;gap:12px}
    .grid.cols-2{grid-template-columns:1fr 1fr}
    .grid.cols-3{grid-template-columns:repeat(3,1fr)}

    input,select,button,textarea{font-family:var(--ff-1)}
    .inp,.sel{width:100%;padding:10px 12px;background:#0d0e10;color:var(--c-text);border:1px solid var(--c-muted);border-radius:10px}
    .btn{padding:10px 14px;border:1px solid var(--c-muted);background:#0d0e10;border-radius:10px;color:var(--c-text);cursor:pointer}
    .btn:hover{background:#111216}
    .btn.red{border-color:var(--c-red);color:#fff;background:linear-gradient(180deg,#a30 0,#700)}
    .btn.ghost{background:transparent}
    .btn.icon{display:inline-flex;align-items:center;gap:8px}
    .btn[disabled]{opacity:.5;cursor:not-allowed}

    .toolbar{padding:12px;border-bottom:1px solid var(--c-muted);display:flex;flex-wrap:wrap;gap:8px;align-items:center;justify-content:space-between}
    .toolbar .left,.toolbar .right{display:flex;gap:8px;align-items:center;flex-wrap:wrap}

    .table-wrap{overflow:auto}
    table{width:100%;border-collapse:separate;border-spacing:0}
    th,td{padding:10px;border-bottom:1px solid var(--c-muted);vertical-align:top}
    th{background:#121317;position:sticky;top:0;z-index:1;text-align:left}
    tr:hover td{background:#121318}

    .pagination{display:flex;justify-content:flex-end;gap:8px;padding:10px}

    .badge{display:inline-block;padding:2px 8px;border:1px solid var(--c-muted);border-radius:999px;font-size:12px}
    .strike{position:relative;display:inline-block}
    .strike:after{content:"";position:absolute;left:0;right:0;top:50%;border-top:2px solid var(--c-red)}

    /* MODAL */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;padding:20px;z-index:999}
    .modal.show{display:flex}
    .modal-card{width:min(1080px,98vw);max-height:92vh;overflow:auto;background:var(--c-surface);border:1px solid var(--c-muted);border-radius:14px}
    .modal-head{display:flex;align-items:center;justify-content:space-between;padding:12px;border-bottom:1px solid var(--c-muted)}
    .modal-body{padding:12px}

    /* TAG — ใช้หน่วย mm เพื่อการพิมพ์แม่นยำ */
    .tag{position:relative;background:var(--c-edge);color:var(--c-white);}
    .tag .inner{position:absolute;inset:calc(var(--pad) * 1mm);background:#fff;border-radius:calc(var(--radius-mm) * 1mm)}
    .tag .logo{position:absolute;top:calc(var(--logo-top-mm) * 1mm);left:calc(var(--logo-left-mm) * 1mm);width:calc(var(--logo-w-mm) * 1mm);height:auto}
    .tag .sku{position:absolute;top:calc(var(--sku-top-mm) * 1mm);right:calc(var(--sku-right-mm) * 1mm);font-weight:600}
    .tag .name{position:absolute;left:calc(var(--name-left-mm) * 1mm);right:calc(var(--name-right-mm) * 1mm);top:calc(var(--name-top-mm) * 1mm);font-weight:var(--name-weight);}
    .tag .details{position:absolute;left:calc(var(--detail-left-mm) * 1mm);right:calc(var(--detail-right-mm) * 1mm);top:calc(var(--detail-top-mm) * 1mm)}
    .tag .details ul{margin:0;padding-left:18px}
    .tag .price-area{position:absolute;left:calc(var(--price-area-left-mm) * 1mm);right:calc(var(--price-area-right-mm) * 1mm);bottom:calc(var(--price-area-bottom-mm) * 1mm)}
    .tag .expire{position:absolute;left:calc(var(--expire-left-mm) * 1mm);bottom:calc(var(--expire-bottom-mm) * 1mm);font-weight:700}
    .tag .normal{position:absolute;right:calc(var(--normal-right-mm) * 1mm);bottom:calc(var(--normal-bottom-mm) * 1mm);color:#c00}
    .tag .promo{position:absolute;right:calc(var(--promo-right-mm) * 1mm);bottom:calc(var(--promo-bottom-mm) * 1mm);font-weight:var(--price-weight);}

    /* ขนาดฟอนต์ต่อเทมเพลต */
    .tag.A4  {width:calc(var(--A4-w-mm) * 1mm); height:calc(var(--A4-h-mm) * 1mm); --pad:var(--A4-padding-mm); --radius-mm:var(--A4-radius-mm);}
    .tag.A5  {width:calc(var(--A5-w-mm) * 1mm); height:calc(var(--A5-h-mm) * 1mm); --pad:var(--A5-padding-mm); --radius-mm:var(--A5-radius-mm);}
    .tag.A6  {width:calc(var(--A6-w-mm) * 1mm); height:calc(var(--A6-h-mm) * 1mm); --pad:var(--A6-padding-mm); --radius-mm:var(--A6-radius-mm);}
    .tag.ACC {width:calc(var(--ACC-w-mm) * 1mm);height:calc(var(--ACC-h-mm) * 1mm); --pad:var(--ACC-padding-mm); --radius-mm:var(--ACC-radius-mm);}

    .tag.A4  .sku{font-size:calc(var(--A4-sku-size) * 1pt)}
    .tag.A5  .sku{font-size:calc(var(--A5-sku-size) * 1pt)}
    .tag.A6  .sku{font-size:calc(var(--A6-sku-size) * 1pt)}
    .tag.ACC .sku{font-size:calc(var(--ACC-sku-size) * 1pt)}

    .tag.A4  .name{font-size:calc(var(--A4-name-size) * 1pt); font-weight:calc(var(--A4-name-weight))}
    .tag.A5  .name{font-size:calc(var(--A5-name-size) * 1pt); font-weight:calc(var(--A5-name-weight))}
    .tag.A6  .name{font-size:calc(var(--A6-name-size) * 1pt); font-weight:calc(var(--A6-name-weight))}
    .tag.ACC .name{font-size:calc(var(--ACC-name-size) * 1pt); font-weight:calc(var(--ACC-name-weight))}

    .tag.A4  .details{font-size:calc(var(--A4-detail-size) * 1pt)}
    .tag.A5  .details{font-size:calc(var(--A5-detail-size) * 1pt)}
    .tag.A6  .details{font-size:calc(var(--A6-detail-size) * 1pt)}
    .tag.ACC .details{font-size:calc(var(--ACC-detail-size) * 1pt)}

    .tag.A4  .expire{font-size:calc(var(--A4-expire-size) * 1pt)}
    .tag.A5  .expire{font-size:calc(var(--A5-expire-size) * 1pt)}
    .tag.A6  .expire{font-size:calc(var(--A6-expire-size) * 1pt)}
    .tag.ACC .expire{font-size:calc(var(--ACC-expire-size) * 1pt)}

    .tag.A4  .normal{font-size:calc(var(--A4-normal-size) * 1pt)}
    .tag.A5  .normal{font-size:calc(var(--A5-normal-size) * 1pt)}
    .tag.A6  .normal{font-size:calc(var(--A6-normal-size) * 1pt)}
    .tag.ACC .normal{font-size:calc(var(--ACC-normal-size) * 1pt)}

    .tag.A4  .promo{font-size:calc(var(--A4-price-size) * 1pt); font-weight:calc(var(--A4-price-weight))}
    .tag.A5  .promo{font-size:calc(var(--A5-price-size) * 1pt); font-weight:calc(var(--A5-price-weight))}
    .tag.A6  .promo{font-size:calc(var(--A6-price-size) * 1pt); font-weight:calc(var(--A6-price-weight))}
    .tag.ACC .promo{font-size:calc(var(--ACC-price-size) * 1pt);font-weight:calc(var(--ACC-price-weight))}

    /* พื้นที่พิมพ์ */
    #printArea{display:none}
    @media print{
      body{background:#fff}
      .app,.modal{display:none !important}
      #printArea{display:block}
      .sheet{page-break-after:always;display:grid;place-content:center;gap:0}
      /* แผงจัดวางต่อหน้า ตามชนิดเทมเพลต */
      .sheet.A4{width:210mm;height:297mm;grid-template-columns:1fr;grid-auto-rows:1fr}
      .sheet.A5{width:210mm;height:297mm;grid-template-columns:1fr;grid-auto-rows:1fr}
      .sheet.A6{width:210mm;height:297mm;grid-template-columns:repeat(2,1fr);grid-auto-rows:1fr}
      .sheet.ACC{width:210mm;height:297mm;grid-template-columns:repeat(2,1fr);grid-auto-rows:1fr}
      .pad{padding:6mm}
    }

    /* Admin tabs */
    .tabs{display:flex;gap:6px;border-bottom:1px solid var(--c-muted);padding:6px}
    .tab{padding:8px 12px;border:1px solid var(--c-muted);border-bottom:none;border-radius:10px 10px 0 0;background:#0d0e10;cursor:pointer}
    .tab.active{background:#16171b}
    .panel{padding:12px}
    .tiny{font-size:12px;color:var(--c-soft)}
  </style>
</head>
<body>
  <div id="printArea"></div>

  <div class="app" id="app" style="display:none">
    <div class="topbar">
      <div class="brand">
        <div class="brand-logo">P</div>
        <div>
          <div class="brand-name">ProPlugin • Price Tag Management</div>
          <div class="muted" id="tenantInfo">Internal • ไม่มีเซิร์ฟเวอร์</div>
        </div>
      </div>
      <div class="row">
        <span id="roleChip" class="chip">Role</span>
        <button class="btn" id="btnAdmin" style="display:none">Admin Panel</button>
        <button class="btn" id="btnLogout">ออกจากระบบ</button>
      </div>
    </div>

    <div class="card">
      <div class="toolbar">
        <div class="left row wrap">
          <input id="q" class="inp" placeholder="ค้นหา SKU / ชื่อสินค้า (ไทย/อังกฤษ)" style="min-width:260px"/>
          <label class="tiny">วันที่ (ดูการเปลี่ยนแปลง/หมดอายุ)</label>
          <input id="dateFilter" type="date" class="inp" />
          <div class="row">
            <label class="tiny">ช่องทาง</label>
            <select id="channel" class="sel"></select>
          </div>
          <div class="row">
            <label class="tiny">เทมเพลตป้าย</label>
            <select id="template" class="sel">
              <option value="A4">A4</option>
              <option value="A5">A5</option>
              <option value="A6" selected>A6</option>
              <option value="ACC">Accessories Tag</option>
            </select>
          </div>
          <div class="row" id="dealerTierWrap" style="display:none">
            <label class="tiny">ดีลเลอร์ Tier</label>
            <select id="dealerTier" class="sel"></select>
          </div>
        </div>
        <div class="right row wrap">
          <button class="btn" id="btnPreview">ตัวอย่าง / พิมพ์</button>
          <button class="btn" id="btnExportPDF">ส่งออก PDF</button>
          <label class="btn ghost" for="fileExcel">นำเข้า Excel</label>
          <input id="fileExcel" type="file" accept=".xlsx,.xls" style="display:none" />
          <button class="btn" id="btnExportExcel">ส่งออก Excel</button>
        </div>
      </div>

      <div class="table-wrap" id="tableWrap"></div>
      <div class="pagination" id="pagination"></div>
    </div>
  </div>

  <!-- Login -->
  <div id="login" class="login-card card">
    <h1>เข้าสู่ระบบ</h1>
    <div class="muted">สำหรับใช้งานภายใน (Static Login)</div>
    <div class="grid cols-2" style="margin-top:12px">
      <div>
        <label class="tiny">ชื่อผู้ใช้</label>
        <input id="lgUser" class="inp" placeholder="เช่น user3" />
      </div>
      <div>
        <label class="tiny">รหัสผ่าน</label>
        <input id="lgPass" class="inp" type="password" placeholder="เช่น u3pass" />
      </div>
    </div>
    <div class="row" style="margin-top:12px;justify-content:space-between">
      <div>
        <button class="btn red" id="btnLogin">เข้าสู่ระบบ</button>
      </div>
      <div class="tiny">
        Host: host1/host123 • Admin: admin1/admin123 • User3: user3/u3pass
      </div>
    </div>
  </div>

  <!-- Modal: Preview / Print -->
  <div id="previewModal" class="modal">
    <div class="modal-card">
      <div class="modal-head">
        <div class="row">
          <strong>ตัวอย่างป้ายราคา</strong>
          <span id="selCount" class="chip">0 รายการ</span>
        </div>
        <div class="row">
          <select id="modalTemplate" class="sel">
            <option value="A4">A4</option>
            <option value="A5">A5</option>
            <option value="A6" selected>A6</option>
            <option value="ACC">Accessories Tag</option>
          </select>
          <select id="modalDealerTier" class="sel" style="display:none"></select>
          <button class="btn" id="btnModalPrint">พิมพ์/ส่งออก</button>
          <button class="btn" id="btnModalClose">ปิด</button>
        </div>
      </div>
      <div class="modal-body">
        <div id="tagPreview" class="row wrap" style="gap:16px"></div>
      </div>
    </div>
  </div>

  <!-- Modal: Admin Panel -->
  <div id="adminModal" class="modal">
    <div class="modal-card" style="width:min(1180px,98vw)">
      <div class="modal-head">
        <div class="row"><strong>Admin Panel</strong><span class="chip" id="adminTabsChip">SKU • เทมเพลต • โลโก้ • Dealer • ผู้ใช้ • Logs</span></div>
        <div class="row"><button class="btn" id="btnAdminClose">ปิด</button></div>
      </div>
      <div class="tabs">
        <div class="tab active" data-tab="sku">สินค้า/ราคา</div>
        <div class="tab" data-tab="tpl">เทมเพลต</div>
        <div class="tab" data-tab="logo">โลโก้</div>
        <div class="tab" data-tab="dealer">Dealer Settings</div>
        <div class="tab" data-tab="users">ผู้ใช้ (Host)</div>
        <div class="tab" data-tab="logs">Logs</div>
      </div>
      <div class="panel" id="panel-sku">
        <div class="row wrap" style="gap:12px;align-items:flex-end">
          <div style="min-width:240px">
            <label class="tiny">SKU</label>
            <input id="skuSku" class="inp" />
          </div>
          <div style="flex:1;min-width:260px">
            <label class="tiny">ชื่อสินค้า</label>
            <input id="skuName" class="inp" />
          </div>
          <div style="flex:1;min-width:240px">
            <label class="tiny">รายละเอียด (คั่นด้วย \n หรือ •)</label>
            <textarea id="skuDetails" class="inp" rows="2"></textarea>
          </div>
          <div><label class="tiny">ปกติ</label><input id="skuNP" class="inp" type="number" /></div>
          <div><label class="tiny">โปรฯ</label><input id="skuPP" class="inp" type="number" /></div>
          <div><label class="tiny">Flagship</label><input id="skuFS" class="inp" type="number" /></div>
          <div><label class="tiny">Market</label><input id="skuMP" class="inp" type="number" /></div>
          <div><label class="tiny">Market GP%</label><input id="skuMGP" class="inp" type="text" /></div>
          <div><label class="tiny">D1</label><input id="skuD1" class="inp" type="number" /></div>
          <div><label class="tiny">GP D1%</label><input id="skuG1" class="inp" type="text" /></div>
          <div><label class="tiny">D2</label><input id="skuD2" class="inp" type="number" /></div>
          <div><label class="tiny">GP D2%</label><input id="skuG2" class="inp" type="text" /></div>
          <div><label class="tiny">D3</label><input id="skuD3" class="inp" type="number" /></div>
          <div><label class="tiny">GP D3%</label><input id="skuG3" class="inp" type="text" /></div>
          <div><label class="tiny">Expire</label><input id="skuEX" class="inp" type="date" /></div>
          <div><label class="tiny">ต้นทุน (อ้างอิง)</label><input id="skuCost" class="inp" type="number" /></div>
          <div>
            <button class="btn" id="btnSkuSave">เพิ่ม/อัปเดต</button>
            <button class="btn" id="btnSkuClear">ล้าง</button>
          </div>
        </div>
        <div id="adminSkuList" style="margin-top:12px"></div>
      </div>

      <div class="panel" id="panel-tpl" style="display:none">
        <div class="grid cols-3">
          <div>
            <div class="tiny">ปรับตัวแปรพื้นฐาน (mm/pt)</div>
            <div class="grid">
              <label>โลโก้ W (mm) <input id="var-logo-w" class="inp" type="number" step="0.1"></label>
              <label>โลโก้ L (mm) <input id="var-logo-l" class="inp" type="number" step="0.1"></label>
              <label>SKU top/right (mm) <input id="var-sku-top" class="inp" type="number" step="0.1"><input id="var-sku-right" class="inp" type="number" step="0.1"></label>
              <label>Expire bottom/left (mm) <input id="var-exp-b" class="inp" type="number" step="0.1"><input id="var-exp-l" class="inp" type="number" step="0.1"></label>
              <label>ราคาโปร bottom/right (mm) <input id="var-pr-b" class="inp" type="number" step="0.1"><input id="var-pr-r" class="inp" type="number" step="0.1"></label>
              <label>ราคาเดิม bottom/right (mm) <input id="var-np-b" class="inp" type="number" step="0.1"><input id="var-np-r" class="inp" type="number" step="0.1"></label>
            </div>
            <div class="row" style="margin-top:8px"><button class="btn" id="btnTplApply">บันทึกการตั้งค่า</button></div>
            <div class="tiny" style="margin-top:8px">Tips: อัปโหลดภาพพื้นหลังเทมเพลต (PNG/PDF แปลงเป็น PNG) เพื่อเทียบตำแหน่งได้</div>
          </div>
          <div>
            <div class="tiny">Teplate Background (Preview เท่านั้น)</div>
            <input id="bgUpload" type="file" accept="image/*" class="inp" />
            <div class="tiny" style="margin-top:6px">ระบบจะไม่พิมพ์ภาพพื้นหลัง — ใช้เป็นฉากเทียบตำแหน่งเท่านั้น</div>
          </div>
          <div>
            <label class="tiny">ข้อความหน้า Expire</label>
            <select id="expireStyle" class="sel">
              <option value="Expire :">Expire :</option>
              <option value="Expire">Expire</option>
            </select>
            <label class="tiny" style="display:block;margin-top:8px">น้ำหนัก/ขนาดตัวอักษรต่อเทมเพลต (pt)</label>
            <div class="grid cols-2" style="margin-top:6px">
              <label>A4 Name <input id="pt-A4-name" class="inp" type="number" step="0.5"></label>
              <label>A4 Price <input id="pt-A4-price" class="inp" type="number" step="0.5"></label>
              <label>A5 Name <input id="pt-A5-name" class="inp" type="number" step="0.5"></label>
              <label>A5 Price <input id="pt-A5-price" class="inp" type="number" step="0.5"></label>
              <label>A6 Name <input id="pt-A6-name" class="inp" type="number" step="0.5"></label>
              <label>A6 Price <input id="pt-A6-price" class="inp" type="number" step="0.5"></label>
              <label>ACC Name <input id="pt-ACC-name" class="inp" type="number" step="0.5"></label>
              <label>ACC Price <input id="pt-ACC-price" class="inp" type="number" step="0.5"></label>
            </div>
          </div>
        </div>
        <div style="margin-top:12px">
          <div class="tiny">Live Preview (A6):</div>
          <div id="tplPreview" style="background:#111;padding:12px;border-radius:12px;display:inline-block"></div>
        </div>
      </div>

      <div class="panel" id="panel-logo" style="display:none">
        <div class="grid cols-2">
          <div>
            <div class="tiny">อัปโหลดโลโก้บริษัท (PNG/JPG; พื้นหลังโปร่งใสยิ่งดี)</div>
            <input id="logoUpload" type="file" accept="image/*" class="inp" />
            <div class="row" style="margin-top:8px"><button class="btn" id="btnLogoClear">ลบโลโก้</button></div>
          </div>
          <div>
            <div class="tiny">ดูตัวอย่างการวางโลโก้บนป้าย (A6)</div>
            <div id="logoPreview" style="margin-top:6px"></div>
          </div>
        </div>
      </div>

      <div class="panel" id="panel-dealer" style="display:none">
        <div class="grid cols-3">
          <label>ชื่อ Tier 1 <input id="labelT1" class="inp"></label>
          <label>ชื่อ Tier 2 <input id="labelT2" class="inp"></label>
          <label>ชื่อ Tier 3 <input id="labelT3" class="inp"></label>
          <label>ค่าเริ่มต้น (Preview/Print)
            <select id="defaultTier" class="sel">
              <option value="t1">Tier 1</option>
              <option value="t2">Tier 2</option>
              <option value="t3">Tier 3</option>
            </select>
          </label>
        </div>
        <div class="row" style="margin-top:8px"><button class="btn" id="btnDealerSave">บันทึก</button></div>
      </div>

      <div class="panel" id="panel-users" style="display:none">
        <div class="tiny">สำหรับ Host เท่านั้น</div>
        <div class="grid cols-3" style="margin-top:6px">
          <label>ชื่อผู้ใช้ <input id="userU" class="inp"></label>
          <label>รหัสผ่าน <input id="userP" class="inp"></label>
          <label>บทบาท
            <select id="userR" class="sel">
              <option>Host</option>
              <option>Admin</option>
              <option>User1</option>
              <option>User2</option>
              <option>User3</option>
              <option>User4</option>
            </select>
          </label>
        </div>
        <div class="row" style="margin-top:8px">
          <button class="btn" id="btnUserAdd">เพิ่ม/อัปเดตผู้ใช้</button>
          <button class="btn" id="btnUserReset">รีเซ็ตเป็นค่าเริ่มต้น</button>
        </div>
        <div id="userList" style="margin-top:12px"></div>
      </div>

      <div class="panel" id="panel-logs" style="display:none">
        <div class="row" style="justify-content:space-between">
          <div class="tiny">ประวัติกิจกรรม (Asia/Bangkok)</div>
          <button class="btn" id="btnExportLogs">ส่งออก CSV</button>
        </div>
        <div id="logList" style="margin-top:8px"></div>
      </div>
    </div>
  </div>

  <script>
  /******************* UTILITIES *******************/
  const LS_KEYS = {
    users: 'pp_users_v1',
    items: 'pp_items_v1',
    settings: 'pp_settings_v1',
    logs: 'pp_logs_v1'
  };
  const BKK_TZ = 'Asia/Bangkok';
  const fmtTH = new Intl.NumberFormat('th-TH');
  const currencyTH = n => (n==null||n==='')?'-': fmtTH.format(Number(n)) + '.-';
  const dtBKK = () => new Date().toLocaleString('th-TH',{hour12:false,timeZone:BKK_TZ});
  const ddmmyyyy = d => {
    if(!d) return '';
    const dt = new Date(d);
    const DD = String(dt.getDate()).padStart(2,'0');
    const MM = String(dt.getMonth()+1).padStart(2,'0');
    const YYYY = dt.getFullYear();
    return `${DD}-${MM}-${YYYY}`;
  };
  const str = s => (s==null? '': String(s));
  const bullets = raw => {
    if(!raw) return [];
    return str(raw).replace(/\u2022/g,'\n').split(/\n|\r|•/g).map(x=>x.trim()).filter(Boolean).slice(0,5);
  };
  const save = (k,v)=> localStorage.setItem(k, JSON.stringify(v));
  const load = (k,d)=>{ try{const v=JSON.parse(localStorage.getItem(k)); return v??d;}catch{return d} };
  const logEvent = (who, action, detail='') => {
    const logs = load(LS_KEYS.logs, []);
    logs.unshift({ts: dtBKK(), who, action, detail});
    save(LS_KEYS.logs, logs);
  };

  /******************* DEFAULT DATA *******************/
  const defaultUsers = [
    {u:'host1',  p:'host123',  r:'Host'},
    {u:'admin1', p:'admin123', r:'Admin'},
    {u:'user1',  p:'u1pass',   r:'User1'},
    {u:'user2',  p:'u2pass',   r:'User2'},
    {u:'user3',  p:'u3pass',   r:'User3'},
    {u:'user4',  p:'u4pass',   r:'User4'},
  ];
  const defaultSettings = {
    tierLabels: {t1:'Dealer Tier 1', t2:'Dealer Tier 2', t3:'Dealer Tier 3'},
    defaultTier: 't1',
    logo: null, // dataURL
    expireStyle: 'Expire :',
    tplVars: {
      logoW: 26, logoL: 8,
      skuTop: 8, skuRight: 8,
      expB: 34, expL: 12, prB: 10, prR: 12, npB: 30, npR: 12,
      // font sizes are managed via CSS variables; read-only sample here
    },
  };
  const sampleItems = [
    {
      sku:'MP-00010',
      description:'iCon Pro Audio GoLive Pro...',
      details:'ออดิโออินเทอร์เฟสสำหรับสตรีมมิ่งพร้อมรีโมทคอนโทรล\nคุณภาพเสียง 24-bit / 48kHz พร้อม DSP ในตัว (Reverb, EQ, Vocal Tune)\nแบตเตอรี่ในตัว 5000mAh ใช้งานได้สูงสุด 6 ชั่วโมง\nรองรับ Mic Input ทั้งแบบ mini-XLR (พร้อม 48V) และ 1/4 นิ้ว\nเชื่อมต่อ Bluetooth สำหรับเล่นเพลงและควบคุม',
      normal_price:7990, promo_price:5990,
      flagship_price:'',
      marketplace_price:'', market_gp:'',
      dealer_price_t1:'', dealer_price_t2:'', dealer_price_t3:'',
      dealer_gp_t1:'', dealer_gp_t2:'', dealer_gp_t3:'',
      expire_date:'2099-09-09'
    }
  ];

  /******************* STATE *******************/
  let users = load(LS_KEYS.users, defaultUsers);
  let items = load(LS_KEYS.items, sampleItems);
  let settings = load(LS_KEYS.settings, defaultSettings);
  let currentUser = null;

  const el = id => document.getElementById(id);

  const CHANNELS_BY_ROLE = {
    Host:['Flagship','Dealer','Marketplace'],
    Admin:['Flagship','Dealer','Marketplace'],
    User1:['Flagship'],
    User2:['Flagship'],
    User3:['Dealer'],
    User4:['Marketplace'],
  };

  function visibleChannels(){
    return CHANNELS_BY_ROLE[currentUser.r] || ['Flagship'];
  }

  function currentGPVisibility(){
    // GP columnแสดงเฉพาะ Dealer (User3/Host/Admin) และ Marketplace (User4/Host/Admin)
    return {
      dealer: ['Host','Admin','User3'].includes(currentUser.r),
      market: ['Host','Admin','User4'].includes(currentUser.r)
    };
  }

  /******************* LOGIN *******************/
  el('btnLogin').onclick = ()=>{
    const u = el('lgUser').value.trim();
    const p = el('lgPass').value.trim();
    const found = users.find(x=>x.u===u && x.p===p);
    if(!found){ alert('ชื่อผู้ใช้หรือรหัสไม่ถูกต้อง'); return; }
    currentUser = found;
    el('login').style.display = 'none';
    el('app').style.display = '';
    el('roleChip').innerText = `บทบาท: ${currentUser.r}`;
    setupToolbar();
    renderTable();
    logEvent(currentUser.u,'login');
    if(['Host','Admin'].includes(currentUser.r)) el('btnAdmin').style.display='';
    else el('btnAdmin').style.display='none';
  };
  el('btnLogout').onclick = ()=>{ location.reload() };

  /******************* TOOLBAR *******************/
  function setupToolbar(){
    // channels
    const ch = el('channel');
    ch.innerHTML = visibleChannels().map(c=>`<option>${c}</option>`).join('');
    ch.value = 'Flagship'; // default
    ch.onchange = ()=>{ toggleDealerTier(); renderTable(); };

    // template
    el('template').onchange = ()=>{};

    // search
    el('q').oninput = ()=> renderTable();

    // date filter
    el('dateFilter').onchange = ()=> renderTable();

    // dealer tier selector
    updateDealerTierSelect('dealerTier');
    el('dealerTier').onchange = ()=> renderTable();

    // Buttons
    el('btnPreview').onclick = openPreview;
    el('btnExportPDF').onclick = ()=>{ openPreview(true) };

    el('fileExcel').onchange = importExcel;
    el('btnExportExcel').onclick = exportExcel;

    el('btnAdmin').onclick = openAdmin;

    toggleDealerTier();
  }

  function toggleDealerTier(){
    const isDealer = el('channel').value==='Dealer';
    el('dealerTierWrap').style.display = isDealer && currentGPVisibility().dealer ? '' : 'none';
  }

  function updateDealerTierSelect(id){
    const sel = el(id);
    sel.innerHTML = `
      <option value="t1">${settings.tierLabels.t1}</option>
      <option value="t2">${settings.tierLabels.t2}</option>
      <option value="t3">${settings.tierLabels.t3}</option>`;
    sel.value = settings.defaultTier || 't1';
  }

  /******************* TABLE *******************/
  let page=1, pageSize=20, selected = new Set();

  function filtered(){
    const q = el('q').value.trim().toLowerCase();
    const channel = el('channel').value;
    const df = el('dateFilter').value;

    let rows = items.slice();
    if(q){ rows = rows.filter(r => str(r.sku).toLowerCase().includes(q) || str(r.description).toLowerCase().includes(q)); }

    if(df){
      // เงื่อนไข: แสดงรายการที่ expire_date ตรง หรือมี log การแก้ไขในวันนั้น
      const logs = load(LS_KEYS.logs, []);
      const matchLogsSku = new Set(
        logs.filter(l=>l.ts.includes(ddmmyyyy(df))).map(l=>l.detail?.split('|')[0]).filter(Boolean)
      );
      rows = rows.filter(r => (r.expire_date && ddmmyyyy(r.expire_date)===ddmmyyyy(df)) || matchLogsSku.has(r.sku));
    }

    // channel-specific fallback rule handled at render
    return rows;
  }

  function renderTable(){
    const channel = el('channel').value;
    const vis = currentGPVisibility();
    const rows = filtered();
    const totalPages = Math.max(1, Math.ceil(rows.length/pageSize));
    page = Math.min(page, totalPages);
    const start = (page-1)*pageSize;
    const pageRows = rows.slice(start, start+pageSize);

    let thead='';
    let tbody='';

    function tdPrice(p){ return `<td>${p? currencyTH(p): '-'}</td>` }

    if(channel==='Dealer'){
      // Dealer: D1/D2/D3 + GP columns (ตาม Excel)
      thead = `
        <thead><tr>
          <th style="width:36px"><input type="checkbox" id="chkAll"></th>
          <th>Item No.</th><th>ชื่อสินค้า</th><th>รายละเอียด</th>
          <th>D1</th><th>D2</th><th>D3</th>
          <th>GP D1%</th><th>GP D2%</th><th>GP D3%</th>
          <th>Expire</th>
        </tr></thead>`;
      tbody = pageRows.map(r=>{
        const d = bullets(r.details).map(x=>`<li>${x}</li>`).join('');
        return `<tr>
          <td><input type="checkbox" class="chk" data-sku="${r.sku}" ${selected.has(r.sku)?'checked':''}></td>
          <td>${r.sku}</td>
          <td>${r.description||''}</td>
          <td><ul style="margin:0;padding-left:18px">${d}</ul></td>
          ${tdPrice(r.dealer_price_t1)}
          ${tdPrice(r.dealer_price_t2)}
          ${tdPrice(r.dealer_price_t3)}
          <td>${str(r.dealer_gp_t1)||'-'}</td>
          <td>${str(r.dealer_gp_t2)||'-'}</td>
          <td>${str(r.dealer_gp_t3)||'-'}</td>
          <td>${r.expire_date? ddmmyyyy(r.expire_date): '-'}</td>
        </tr>`;
      }).join('');
    } else if(channel==='Marketplace'){
      thead = `
        <thead><tr>
          <th style="width:36px"><input type="checkbox" id="chkAll"></th>
          <th>Item No.</th><th>ชื่อสินค้า</th><th>รายละเอียด</th>
          <th>ราคาช่องทาง</th><th>GP%</th><th>Expire</th>
        </tr></thead>`;
      tbody = pageRows.map(r=>{
        const d = bullets(r.details).map(x=>`<li>${x}</li>`).join('');
        const price = r.marketplace_price || r.promo_price || r.normal_price;
        const gp = str(r.market_gp)||'-';
        return `<tr>
          <td><input type="checkbox" class="chk" data-sku="${r.sku}" ${selected.has(r.sku)?'checked':''}></td>
          <td>${r.sku}</td>
          <td>${r.description||''}</td>
          <td><ul style="margin:0;padding-left:18px">${d}</ul></td>
          ${tdPrice(price)}
          <td>${gp}</td>
          <td>${r.expire_date? ddmmyyyy(r.expire_date): '-'}</td>
        </tr>`;
      }).join('');
    } else {
      // Flagship
      thead = `
        <thead><tr>
          <th style="width:36px"><input type="checkbox" id="chkAll"></th>
          <th>Item No.</th><th>ชื่อสินค้า</th><th>รายละเอียด</th>
          <th>ราคาปกติ</th><th>ราคาช่องทาง</th><th>Expire</th>${['Host','Admin'].includes(currentUser.r)?'<th>GP%</th>':''}
        </tr></thead>`;
      tbody = pageRows.map(r=>{
        const d = bullets(r.details).map(x=>`<li>${x}</li>`).join('');
        const price = (r.flagship_price || r.promo_price || r.normal_price);
        const gp = str(r.flagship_gp || '')
        return `<tr>
          <td><input type="checkbox" class="chk" data-sku="${r.sku}" ${selected.has(r.sku)?'checked':''}></td>
          <td>${r.sku}</td>
          <td>${r.description||''}</td>
          <td><ul style="margin:0;padding-left:18px">${d}</ul></td>
          ${tdPrice(r.normal_price)}
          ${tdPrice(price)}
          <td>${r.expire_date? ddmmyyyy(r.expire_date): '-'}</td>
          ${['Host','Admin'].includes(currentUser.r)?`<td>${gp||'-'}</td>`:''}
        </tr>`;
      }).join('');
    }

    const tableHTML = `<table>${thead}<tbody>${tbody}</tbody></table>`;
    el('tableWrap').innerHTML = tableHTML;

    const chkAll = el('chkAll');
    if(chkAll){ chkAll.onchange = ()=>{
      document.querySelectorAll('.chk').forEach(ch=>{
        ch.checked = chkAll.checked;
        const sku = ch.dataset.sku; if(ch.checked) selected.add(sku); else selected.delete(sku);
      });
    } }
    document.querySelectorAll('.chk').forEach(ch=> ch.onchange = ()=>{
      const sku = ch.dataset.sku; if(ch.checked) selected.add(sku); else selected.delete(sku);
    });

    // pagination
    let pag='';
    const go = n=>`<button class="btn" data-pg="${n}" ${n===page?'disabled':''}>${n}</button>`;
    for(let i=1;i<=totalPages;i++) pag += go(i);
    el('pagination').innerHTML = pag;
    el('pagination').querySelectorAll('button').forEach(b=> b.onclick=()=>{page=Number(b.dataset.pg); renderTable();});
  }

  /******************* PREVIEW & PRINT *******************/
  function buildTagDOM(item, template, dealerTier, channel){
    const tag = document.createElement('div');
    tag.className = `tag ${template}`;
    tag.style.fontFamily = 'Kanit, Prompt, sans-serif';
    const inner = document.createElement('div'); inner.className='inner'; tag.appendChild(inner);

    const pad = document.createElement('div'); pad.style.position='absolute'; pad.style.inset='0'; pad.style.padding='0'; tag.appendChild(pad);

    // background preview (จาก Template Manager)
    const bg = load('pp_tpl_bg', null);
    if(bg){ const bgImg = new Image(); bgImg.src = bg; bgImg.style.position='absolute'; bgImg.style.inset='0'; bgImg.style.width='100%'; bgImg.style.height='100%'; bgImg.style.opacity='0.2'; tag.appendChild(bgImg); }

    // logo
    const logoURL = settings.logo;
    if(logoURL){ const img = new Image(); img.src = logoURL; img.className='logo'; tag.appendChild(img); }

    // sku
    const sku = document.createElement('div'); sku.className='sku'; sku.textContent = item.sku||''; tag.appendChild(sku);

    // name
    const name = document.createElement('div'); name.className='name'; name.textContent = str(item.description||''); tag.appendChild(name);

    // details
    const det = document.createElement('div'); det.className='details'; const ul=document.createElement('ul'); bullets(item.details).forEach(b=>{ const li=document.createElement('li'); li.textContent=b; ul.appendChild(li); }); det.appendChild(ul); tag.appendChild(det);

    // price area
    const pa = document.createElement('div'); pa.className='price-area'; tag.appendChild(pa);

    // expire
    const expireText = document.createElement('div'); expireText.className='expire'; expireText.textContent = `${settings.expireStyle} ${ddmmyyyy(item.expire_date)}`; tag.appendChild(expireText);

    // price selection by channel
    let promo = null, normal = null;
    if(channel==='Dealer'){
      const key = dealerTier==='t1'? 'dealer_price_t1': dealerTier==='t2'? 'dealer_price_t2': 'dealer_price_t3';
      promo = item[key] || item.promo_price || item.normal_price;
      normal = (item.promo_price? item.normal_price: null);
    } else if(channel==='Marketplace'){
      promo = item.marketplace_price || item.promo_price || item.normal_price;
      normal = (item.promo_price? item.normal_price: null);
    } else { // Flagship
      promo = (item.flagship_price || item.promo_price || item.normal_price);
      normal = (item.promo_price? item.normal_price: null);
    }

    if(normal){ const n = document.createElement('div'); n.className='normal'; n.innerHTML = `<span class="strike">${currencyTH(normal)}</span>`; tag.appendChild(n); }
    if(promo){ const p = document.createElement('div'); p.className='promo'; p.textContent = currencyTH(promo); tag.appendChild(p); }

    return tag;
  }

  function openPreview(exportOnly=false){
    const sel = items.filter(r=> selected.has(r.sku));
    if(sel.length===0){ alert('กรุณาเลือกสินค้าอย่างน้อย 1 รายการ'); return; }
    el('selCount').innerText = `${sel.length} รายการ`;

    const channel = el('channel').value;
    const showDealer = channel==='Dealer' && currentGPVisibility().dealer;
    el('modalDealerTier').style.display = showDealer? '': 'none';
    updateDealerTierSelect('modalDealerTier');

    const t = el('template').value;
    el('modalTemplate').value = t;

    const wrap = el('tagPreview'); wrap.innerHTML='';
    sel.forEach(it=> wrap.appendChild(buildTagDOM(it, t, el('modalDealerTier').value, channel)) );

    if(exportOnly){
      // เตรียม printArea แล้วสั่งพิมพ์ทันที
      buildPrintSheets(sel, t, channel, el('modalDealerTier').value);
      logEvent(currentUser.u, 'export_pdf', `${sel.length} items`);
      window.print();
      return;
    }

    el('previewModal').classList.add('show');

    el('modalTemplate').onchange = ()=>{
      const T = el('modalTemplate').value; wrap.innerHTML=''; sel.forEach(it=> wrap.appendChild(buildTagDOM(it, T, el('modalDealerTier').value, channel)) );
    };
    el('modalDealerTier').onchange = ()=>{
      const T = el('modalTemplate').value; wrap.innerHTML=''; sel.forEach(it=> wrap.appendChild(buildTagDOM(it, T, el('modalDealerTier').value, channel)) );
    };

    el('btnModalPrint').onclick = ()=>{
      buildPrintSheets(sel, el('modalTemplate').value, channel, el('modalDealerTier').value);
      logEvent(currentUser.u, 'print', `${sel.length} items`);
      window.print();
    };
    el('btnModalClose').onclick = ()=> el('previewModal').classList.remove('show');
  }

  function buildPrintSheets(rows, template, channel, dealerTier){
    const area = el('printArea'); area.innerHTML='';
    // จำนวนต่อแผ่น A4
    const perSheet = template==='A4'? 1: template==='A5'? 2: template==='A6'? 4: 12;
    for(let i=0;i<rows.length;i+=perSheet){
      const sheet = document.createElement('div'); sheet.className = `sheet ${template} pad`;
      const chunk = rows.slice(i, i+perSheet);
      chunk.forEach(it=> sheet.appendChild(buildTagDOM(it, template, dealerTier, channel)) );
      area.appendChild(sheet);
    }
  }

  /******************* EXCEL IO *******************/
  function mapHeaders(h){
    const m = {
      'item no.':'sku','item no':'sku','รหัส':'sku','รหัสสินค้า':'sku',
      'description':'description','ชื่อสินค้า':'description','ชื่อ':'description',
      'details':'details','รายละเอียด':'details',
      'normal price':'normal_price','ราคาปกติ':'normal_price',
      'promotion price':'promo_price','ราคาโปรโมชั่น':'promo_price','โปร':'promo_price',
      'flagship price':'flagship_price','ราคา flagship':'flagship_price',
      'marketplace price':'marketplace_price','ราคา marketplace':'marketplace_price','market price':'marketplace_price',
      'marketplace gp%':'market_gp','market gp%':'market_gp','gp marketplace':'market_gp',
      'dealer price t1':'dealer_price_t1','dealer price t2':'dealer_price_t2','dealer price t3':'dealer_price_t3',
      'dealer gp% t1':'dealer_gp_t1','dealer gp% t2':'dealer_gp_t2','dealer gp% t3':'dealer_gp_t3',
      'cost':'cost','ต้นทุน':'cost',
      'expire date':'expire_date','expire':'expire_date','วันหมดอายุ':'expire_date'
    };
    return m[h.trim().toLowerCase()] || h;
  }

  function importExcel(evt){
    const file = evt.target.files[0]; if(!file) return;
    const reader = new FileReader();
    reader.onload = e=>{
      const wb = XLSX.read(new Uint8Array(e.target.result), {type:'array'});
      const ws = wb.Sheets[wb.SheetNames[0]];
      const json = XLSX.utils.sheet_to_json(ws, {header:1, raw:false});
      const [head, ...rows] = json;
      const headers = head.map(mapHeaders);
      const out = rows.filter(r=> r.length>0).map(r=>{
        const o={}; headers.forEach((h,i)=> o[h]=r[i]); return o;
      }).map(o=>({
        sku: o.sku||'', description:o.description||'', details:o.details||'',
        normal_price: num(o.normal_price), promo_price: num(o.promo_price),
        flagship_price: num(o.flagship_price), marketplace_price: num(o.marketplace_price),
        market_gp: o.market_gp||'',
        dealer_price_t1: num(o.dealer_price_t1), dealer_price_t2: num(o.dealer_price_t2), dealer_price_t3: num(o.dealer_price_t3),
        dealer_gp_t1: o.dealer_gp_t1||'', dealer_gp_t2: o.dealer_gp_t2||'', dealer_gp_t3: o.dealer_gp_t3||'',
        cost: num(o.cost),
        expire_date: parseExcelDate(o.expire_date)
      }));
      items = out;
      save(LS_KEYS.items, items);
      renderTable();
      logEvent(currentUser.u,'import_excel', `${items.length} rows`);
      alert('นำเข้าข้อมูลสำเร็จ');
      evt.target.value='';
    };
    reader.readAsArrayBuffer(file);
  }

  function parseExcelDate(v){
    if(!v) return '';
    // รองรับทั้งรูปแบบวันที่ทั่วไป และเลข serial ของ Excel
    if(/^[0-9]+$/.test(String(v))){
      const dt = XLSX.SSF.parse_date_code(Number(v));
      const d = new Date(Date.UTC(dt.y, dt.m-1, dt.d));
      return d.toISOString().slice(0,10);
    }
    const d = new Date(v); if(!isNaN(+d)) return d.toISOString().slice(0,10);
    return '';
  }
  function num(v){ const n = Number(String(v).replace(/[^0-9.\-]/g,'')); return isFinite(n)? n: '' }

  function exportExcel(){
    const data = items.map(x=>({
      'Item No.':x.sku,
      'Description':x.description,
      'Details':x.details,
      'Normal Price':x.normal_price,
      'Promotion Price':x.promo_price,
      'Dealer Price T1':x.dealer_price_t1,
      'Dealer Price T2':x.dealer_price_t2,
      'Dealer Price T3':x.dealer_price_t3,
      'Dealer GP% T1':x.dealer_gp_t1,
      'Dealer GP% T2':x.dealer_gp_t2,
      'Dealer GP% T3':x.dealer_gp_t3,
      'Flagship Price':x.flagship_price,
      'Marketplace Price':x.marketplace_price,
      'Marketplace GP%':x.market_gp,
      'Cost':x.cost,
      'Expire date':x.expire_date
    }));
    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'PriceTags');
    const blob = XLSX.write(wb, {bookType:'xlsx', type:'array'});
    downloadBlob(blob, 'proplugin_price_tags.xlsx');
    logEvent(currentUser.u,'export_excel', `${items.length} rows`);
  }

  function downloadBlob(arrBuf, filename){
    const blob = new Blob([arrBuf], {type:'application/octet-stream'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = filename; a.click(); URL.revokeObjectURL(url);
  }

  /******************* ADMIN *******************/
  function openAdmin(){
    if(!['Host','Admin'].includes(currentUser.r)){ alert('สิทธิ์ไม่พอ'); return; }
    // tabs
    document.querySelectorAll('.tab').forEach(t=> t.onclick=()=> selectTab(t.dataset.tab));
    selectTab('sku');
    // init input values
    renderAdminSkuList();
    loadTplVarsToInputs();
    renderTplPreview();
    updateDealerTierSelect('defaultTier');
    el('labelT1').value = settings.tierLabels.t1; el('labelT2').value=settings.tierLabels.t2; el('labelT3').value=settings.tierLabels.t3;
    el('defaultTier').value = settings.defaultTier;
    // logo
    renderLogoPreview();

    // handlers
    el('btnSkuSave').onclick = saveSku;
    el('btnSkuClear').onclick = clearSkuForm;

    el('btnTplApply').onclick = applyTplVars;
    el('bgUpload').onchange = e=> loadBgPreview(e.target.files[0]);

    el('logoUpload').onchange = e=>{
      const f = e.target.files[0]; if(!f) return; const rd = new FileReader(); rd.onload=ev=>{ settings.logo = ev.target.result; save(LS_KEYS.settings, settings); renderLogoPreview(); }; rd.readAsDataURL(f);
    };
    el('btnLogoClear').onclick = ()=>{ settings.logo=null; save(LS_KEYS.settings, settings); renderLogoPreview(); };

    el('btnDealerSave').onclick = ()=>{
      settings.tierLabels.t1 = el('labelT1').value||'Dealer Tier 1';
      settings.tierLabels.t2 = el('labelT2').value||'Dealer Tier 2';
      settings.tierLabels.t3 = el('labelT3').value||'Dealer Tier 3';
      settings.defaultTier = el('defaultTier').value;
      save(LS_KEYS.settings, settings);
      updateDealerTierSelect('dealerTier');
      updateDealerTierSelect('modalDealerTier');
      alert('บันทึก Dealer Settings แล้ว');
    };

    // users
    renderUserList();
    el('btnUserAdd').onclick = saveUser;
    el('btnUserReset').onclick = ()=>{ if(confirm('รีเซ็ตผู้ใช้เป็นค่าเริ่มต้น?')){ users=defaultUsers.slice(); save(LS_KEYS.users, users); renderUserList(); } };

    // logs
    renderLogs();
    el('btnExportLogs').onclick = exportLogs;

    el('adminModal').classList.add('show');
    el('btnAdminClose').onclick = ()=> el('adminModal').classList.remove('show');
  }

  function selectTab(name){
    document.querySelectorAll('.tab').forEach(t=> t.classList.toggle('active', t.dataset.tab===name));
    ['sku','tpl','logo','dealer','users','logs'].forEach(id=> el(`panel-${id}`).style.display = id===name? '': 'none');
  }

  function saveSku(){
    const o = {
      sku: el('skuSku').value.trim(),
      description: el('skuName').value.trim(),
      details: el('skuDetails').value.trim(),
      normal_price: num(el('skuNP').value), promo_price: num(el('skuPP').value),
      flagship_price: num(el('skuFS').value), marketplace_price: num(el('skuMP').value), market_gp: el('skuMGP').value.trim(),
      dealer_price_t1: num(el('skuD1').value), dealer_price_t2: num(el('skuD2').value), dealer_price_t3: num(el('skuD3').value),
      dealer_gp_t1: el('skuG1').value.trim(), dealer_gp_t2: el('skuG2').value.trim(), dealer_gp_t3: el('skuG3').value.trim(),
      expire_date: el('skuEX').value, cost: num(el('skuCost').value)
    };
    if(!o.sku){ alert('กรุณาระบุ SKU'); return; }
    const i = items.findIndex(x=>x.sku===o.sku);
    if(i>=0) items[i]=o; else items.unshift(o);
    save(LS_KEYS.items, items);
    renderAdminSkuList(); renderTable();
    logEvent(currentUser.u,'sku_save', `${o.sku}|${o.description}`);
    clearSkuForm();
  }
  function clearSkuForm(){ ['skuSku','skuName','skuDetails','skuNP','skuPP','skuFS','skuMP','skuMGP','skuD1','skuD2','skuD3','skuG1','skuG2','skuG3','skuEX','skuCost'].forEach(id=> el(id).value=''); }

  function renderAdminSkuList(){
    const rows = items.map(r=>`<tr>
      <td><button class="btn" data-ed="${r.sku}">แก้ไข</button></td>
      <td>${r.sku}</td><td>${r.description||''}</td><td>${currencyTH(r.normal_price)}</td><td>${currencyTH(r.promo_price)}</td>
      <td>${currencyTH(r.dealer_price_t1)}</td><td>${currencyTH(r.dealer_price_t2)}</td><td>${currencyTH(r.dealer_price_t3)}</td>
      <td>${r.expire_date? ddmmyyyy(r.expire_date): '-'}</td>
      <td><button class="btn" data-del="${r.sku}">ลบ</button></td>
    </tr>`).join('');
    el('adminSkuList').innerHTML = `<div class="table-wrap"><table><thead><tr><th></th><th>SKU</th><th>ชื่อ</th><th>ปกติ</th><th>โปรฯ</th><th>D1</th><th>D2</th><th>D3</th><th>Expire</th><th></th></tr></thead><tbody>${rows}</tbody></table></div>`;
    el('adminSkuList').querySelectorAll('[data-ed]').forEach(b=> b.onclick=()=>{
      const it = items.find(x=>x.sku===b.dataset.ed); if(!it) return;
      el('skuSku').value=it.sku; el('skuName').value=it.description||''; el('skuDetails').value=it.details||'';
      el('skuNP').value=it.normal_price; el('skuPP').value=it.promo_price; el('skuFS').value=it.flagship_price; el('skuMP').value=it.marketplace_price; el('skuMGP').value=it.market_gp||'';
      el('skuD1').value=it.dealer_price_t1; el('skuD2').value=it.dealer_price_t2; el('skuD3').value=it.dealer_price_t3;
      el('skuG1').value=it.dealer_gp_t1||''; el('skuG2').value=it.dealer_gp_t2||''; el('skuG3').value=it.dealer_gp_t3||'';
      el('skuEX').value=it.expire_date||''; el('skuCost').value=it.cost||'';
    });
    el('adminSkuList').querySelectorAll('[data-del]').forEach(b=> b.onclick=()=>{
      if(!confirm('ลบรายการนี้?')) return;
      items = items.filter(x=>x.sku!==b.dataset.del); save(LS_KEYS.items, items); renderAdminSkuList(); renderTable(); logEvent(currentUser.u,'sku_delete', b.dataset.del);
    });
  }

  function loadTplVarsToInputs(){
    const v = settings.tplVars;
    el('var-logo-w').value = v.logoW; el('var-logo-l').value = v.logoL;
    el('var-sku-top').value = v.skuTop; el('var-sku-right').value = v.skuRight;
    el('var-exp-b').value = v.expB; el('var-exp-l').value = v.expL; el('var-pr-b').value = v.prB; el('var-pr-r').value = v.prR; el('var-np-b').value = v.npB; el('var-np-r').value = v.npR;
    el('expireStyle').value = settings.expireStyle || 'Expire :';
    // font sizes (อ่านจาก :root computed)
    const getVar = n=> getComputedStyle(document.documentElement).getPropertyValue(`--${n}`).trim();
    ['A4','A5','A6','ACC'].forEach(T=>{
      el(`pt-${T}-name`).value = getVar(`${T.toUpperCase()}-name-size`);
      el(`pt-${T}-price`).value = getVar(`${T.toUpperCase()}-price-size`);
    });
  }
  function applyTplVars(){
    const v = settings.tplVars;
    v.logoW = num(el('var-logo-w').value)||v.logoW; v.logoL = num(el('var-logo-l').value)||v.logoL;
    v.skuTop = num(el('var-sku-top').value)||v.skuTop; v.skuRight = num(el('var-sku-right').value)||v.skuRight;
    v.expB = num(el('var-exp-b').value)||v.expB; v.expL = num(el('var-exp-l').value)||v.expL; v.prB=num(el('var-pr-b').value)||v.prB; v.prR=num(el('var-pr-r').value)||v.prR; v.npB=num(el('var-np-b').value)||v.npB; v.npR=num(el('var-np-r').value)||v.npR;
    settings.expireStyle = el('expireStyle').value;

    // sync to CSS custom properties
    document.documentElement.style.setProperty('--logo-w-mm', v.logoW);
    document.documentElement.style.setProperty('--logo-left-mm', v.logoL);
    document.documentElement.style.setProperty('--sku-top-mm', v.skuTop);
    document.documentElement.style.setProperty('--sku-right-mm', v.skuRight);
    document.documentElement.style.setProperty('--expire-bottom-mm', v.expB);
    document.documentElement.style.setProperty('--expire-left-mm', v.expL);
    document.documentElement.style.setProperty('--promo-bottom-mm', v.prB);
    document.documentElement.style.setProperty('--promo-right-mm', v.prR);
    document.documentElement.style.setProperty('--normal-bottom-mm', v.npB);
    document.documentElement.style.setProperty('--normal-right-mm', v.npR);

    // font sizes
    const setVar = (k,v)=> document.documentElement.style.setProperty(`--${k}`, v);
    ;['A4','A5','A6','ACC'].forEach(T=>{
      const nm = el(`pt-${T}-name`).value; const pr = el(`pt-${T}-price`).value;
      if(nm) setVar(`${T}-name-size`, nm);
      if(pr) setVar(`${T}-price-size`, pr);
    });

    save(LS_KEYS.settings, settings);
    renderTplPreview();
    alert('บันทึกเทมเพลตแล้ว');
  }

  function renderTplPreview(){
    const prev = el('tplPreview'); prev.innerHTML='';
    const tag = buildTagDOM(items[0], 'A6', settings.defaultTier, 'Flagship');
    prev.appendChild(tag);
  }

  function loadBgPreview(file){
    if(!file) return; const rd = new FileReader(); rd.onload=e=>{ localStorage.setItem('pp_tpl_bg', e.target.result); renderTplPreview(); }; rd.readAsDataURL(file);
  }

  function renderLogoPreview(){
    const wrap = el('logoPreview'); wrap.innerHTML='';
    wrap.appendChild(buildTagDOM(items[0], 'A6', settings.defaultTier, 'Flagship'));
  }

  function saveUser(){
    if(currentUser.r!=='Host'){ alert('เฉพาะ Host'); return }
    const u = el('userU').value.trim(); const p = el('userP').value.trim(); const r = el('userR').value;
    if(!u||!p){ alert('กรอกชื่อผู้ใช้/รหัสผ่าน'); return }
    const i = users.findIndex(x=>x.u===u);
    const rec = {u,p,r};
    if(i>=0) users[i]=rec; else users.push(rec);
    save(LS_KEYS.users, users); renderUserList(); logEvent(currentUser.u,'user_save', u);
  }
  function renderUserList(){
    const rows = users.map(u=>`<tr><td>${u.u}</td><td>${u.r}</td><td><button class="btn" data-del="${u.u}">ลบ</button></td></tr>`).join('');
    el('userList').innerHTML = `<div class="table-wrap"><table><thead><tr><th>ผู้ใช้</th><th>บทบาท</th><th></th></tr></thead><tbody>${rows}</tbody></table></div>`;
    el('userList').querySelectorAll('[data-del]').forEach(b=> b.onclick=()=>{ if(currentUser.r!=='Host') return; if(confirm('ลบผู้ใช้นี้?')){ users = users.filter(x=>x.u!==b.dataset.del); save(LS_KEYS.users, users); renderUserList(); logEvent(currentUser.u,'user_delete', b.dataset.del);} });
  }

  function renderLogs(){
    const logs = load(LS_KEYS.logs, []);
    const rows = logs.map(l=>`<tr><td>${l.ts}</td><td>${l.who}</td><td>${l.action}</td><td>${l.detail||''}</td></tr>`).join('');
    el('logList').innerHTML = `<div class="table-wrap"><table><thead><tr><th>เวลา</th><th>ผู้ใช้</th><th>กิจกรรม</th><th>รายละเอียด</th></tr></thead><tbody>${rows}</tbody></table></div>`;
  }
  function exportLogs(){
    const logs = load(LS_KEYS.logs, []);
    const csv = ['ts,who,action,detail'].concat(logs.map(l=>`"${l.ts}","${l.who}","${l.action}","${(l.detail||'').replace(/"/g,'\"')}"`)).join('\n');
    const blob = new Blob([csv], {type:'text/csv'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href=url; a.download='logs.csv'; a.click(); URL.revokeObjectURL(url);
  }

  /******************* INIT *******************/
  // โหลด CSS vars จาก settings.tplVars
  (function initVars(){
    const v = settings.tplVars;
    document.documentElement.style.setProperty('--logo-w-mm', v.logoW);
    document.documentElement.style.setProperty('--logo-left-mm', v.logoL);
    document.documentElement.style.setProperty('--sku-top-mm', v.skuTop);
    document.documentElement.style.setProperty('--sku-right-mm', v.skuRight);
    document.documentElement.style.setProperty('--expire-bottom-mm', v.expB);
    document.documentElement.style.setProperty('--expire-left-mm', v.expL);
    document.documentElement.style.setProperty('--promo-bottom-mm', v.prB);
    document.documentElement.style.setProperty('--promo-right-mm', v.prR);
    document.documentElement.style.setProperty('--normal-bottom-mm', v.npB);
    document.documentElement.style.setProperty('--normal-right-mm', v.npR);
  })();

  </script>
</body>
</html>
